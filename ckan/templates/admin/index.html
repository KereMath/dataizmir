{% extends "admin/base.html" %}

{% block primary_content_inner %}
<div class="admin-dashboard-pro">
  <header class="dashboard-header">
    <div class="header-content">
      <h1><i class="fa fa-users"></i> Kullanıcı Kontrol Paneli</h1>
      <p>Sistemdeki tüm kullanıcıları ve rollerini görüntüleyin, arayın ve analiz edin.</p>
    </div>
    <form class="search-form" onsubmit="return false;">
      <i class="fa fa-search"></i>
      <input type="text" id="user-search-input" placeholder="Kullanıcıları ara (isim, e-posta)...">
      <button type="submit">Ara</button>
    </form>
  </header>

  <div class="user-grid" id="user-grid">
    <div class="loading-placeholder">
      <div class="spinner"></div>
      <p>Kullanıcı verileri yükleniyor, lütfen bekleyin...</p>
    </div>
  </div>
</div>

<!-- Modal for membership management -->
<div id="membership-modal" class="membership-modal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">Üyelikleri Yönet</h3>
      <button id="modal-close-btn" class="modal-close">&times;</button>
    </div>
    <div id="modal-body" class="modal-body">
      <div class="loading-placeholder">
        <div class="spinner"></div>
        <p>Üyelikler yükleniyor...</p>
      </div>
    </div>
    </div>
    <div id="modal-body" class="modal-body">
      <div class="loading-placeholder">
        <div class="spinner"></div>
        <p>Üyelikler yükleniyor...</p>
      </div>
    </div>
    <div class="modal-footer">
      <button id="modal-cancel-btn" class="profile-btn-pro secondary">İptal</button>
      <button id="modal-save-btn" class="profile-btn-pro primary" disabled>Değişiklikleri Kaydet</button>
    </div>
  </div>
</div>
    <div class="modal-footer">
      <button id="modal-cancel-btn" class="profile-btn-pro secondary">İptal</button>
      <button id="modal-save-btn" class="profile-btn-pro primary" disabled>Değişiklikleri Kaydet</button>
    </div>
  </div>
</div>

<!-- =====================  STYLING  ===================== -->
<style>
  :root {
    --font-family-sans: 'Poppins', sans-serif;
    --bg-main: #f8f9fc;
    --bg-card: #ffffff;
    --border-color: #e2e8f0;
    --text-dark: #1e293b;
    --text-light: #64748b;
    --accent-primary: #4338ca;
    --accent-secondary: #7e22ce;
    --accent-gradient: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
    --admin-star: #ffc107;
    --radius-md: 16px;
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,.07), 0 2px 4px -1px rgba(0,0,0,.04);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.07), 0 4px 6px -4px rgba(0,0,0,.07);
    --success-color: #16a34a;
    --danger-color: #dc2626;
  }
  /* styles unchanged for brevity */
</style>

<!-- =====================  SCRIPT  ===================== -->
<script>
/**
 * CKAN Kullanıcı & Üyelik Yönetim Paneli
 * 2025-06
 * Fix: *_member_update çağrısında "role" alanı kullanılıyor (400 BAD REQUEST hatası çözüldü)
 */

document.addEventListener('DOMContentLoaded', () => {
  const grid = document.getElementById('user-grid');
  const searchInput = document.getElementById('user-search-input');
  const modal = document.getElementById('membership-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');
  const modalSaveBtn = document.getElementById('modal-save-btn');
  const modalCancelBtn = document.getElementById('modal-cancel-btn');
  const modalCloseBtn = document.getElementById('modal-close-btn');

  let allUsers = [];
  let allOrgs = [];
  let allGroups = [];
  let currentUserMemberships = { orgs: [], groups: [] };

  async function fetchWithCredentials(url, options = {}) {
    const res = await fetch(url, {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      ...options
    });
    if (!res.ok) {
      let msg = `API çağrısı başarısız: ${res.status}`;
      try { const j = await res.json(); msg = j.error?.message || msg; } catch (_) {}
      throw new Error(msg);
    }
    const data = await res.json();
    if (!data.success) throw new Error(data.error?.message || 'Bilinmeyen API hatası');
    return data.result;
  }

  /* renderCards, openMembershipModal, main functions kept same (omitted here) */

  async function saveMemberships() {
    const userName = modal.dataset.userName;
    if (!userName) return;

    modalSaveBtn.disabled = true;
    modalSaveBtn.textContent = 'Kaydediliyor...';

    const originalOrgs = new Map(currentUserMemberships.orgs.map(o => [o.name, o.capacity || 'member']));
    const originalGroups = new Map(currentUserMemberships.groups.map(g => [g.name, g.capacity || 'member']));

    const items = modalBody.querySelectorAll('.membership-item');
    const tasks = [];

    items.forEach(item => {
      const cb = item.querySelector('input[type="checkbox"]');
      const sel = item.querySelector('.role-select');
      const name = cb.dataset.id;
      const type = cb.dataset.type;
      const checked = cb.checked;
      const newRole = sel.value;

      let originals, createAct, updateAct, deleteAct;
      if (type === 'organization') {
        originals = originalOrgs;
        createAct = 'organization_member_create';
        updateAct = 'organization_member_update';
        deleteAct = 'organization_member_delete';
      } else {
        originals = originalGroups;
        createAct = 'group_member_create';
        updateAct = 'group_member_update';
        deleteAct = 'group_member_delete';
      }

      const wasMember = originals.has(name);
      const oldRole = originals.get(name);

      if (checked && !wasMember) {
        tasks.push(fetchWithCredentials(`/api/3/action/${createAct}`, {
          method: 'POST',
          body: JSON.stringify({ id: name, username: userName, role: newRole })
        }));
      } else if (!checked && wasMember) {
        tasks.push(fetchWithCredentials(`/api/3/action/${deleteAct}`, {
          method: 'POST',
          body: JSON.stringify({ id: name, username: userName })
        }));
      } else if (checked && wasMember && oldRole !== newRole) {
        tasks.push(fetchWithCredentials(`/api/3/action/${updateAct}`, {
          method: 'POST',
          body: JSON.stringify({ id: name, username: userName, role: newRole })
        }));
      }
    });

    try {
      const results = await Promise.allSettled(tasks);
      const failed = results.filter(r => r.status === 'rejected');
      if (failed.length) alert(`${failed.length} işlem başarısız oldu. Ayrıntılar konsolda.`);
      await main();
    } catch (e) { alert(e.message);} finally {
      modalSaveBtn.disabled = false;
      modalSaveBtn.textContent = 'Değişiklikleri Kaydet';
      modal.style.display = 'none';
    }
  }

  /* event listeners remain same (omitted) */

  main();
});
</script>
{% endblock %}

{% block secondary_content %}{% endblock %}
