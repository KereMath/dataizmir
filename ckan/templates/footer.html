{# footer.html – PDF modal ile güncellenmiş sürüm #}

<style>
  /* --- GENEL --- */
  .site-footer{
      width:100%;
      padding:60px 0;                 /* height biraz arttı (üst‑alt 60px) */
      position: relative;
      bottom: 0px;
  }

  /* Dinamik footer pozisyonlaması - her durumda en altta */
  .site-footer.sticky-bottom {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
  }

  /* Body'ye footer yüksekliği kadar padding */
  body.footer-padded {
      padding-bottom: var(--footer-height, 200px) !important;
  }

  /* sütunları taşıyan satır */
  .footer-columns{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;  /* sola yapışmasın, boşluklu dağılsın */
      gap:60px;                       /* sütun arası boşluk */
  }

  /* sütunlar */
  .footer-column{
      flex:1 1 200px;                 /* min 200px, esnek */
      color:#ccc;
  }
  .footer-column a{color:#ccc;text-decoration:none;}
  .footer-column a:hover{color:#fff;}

  /* dikey kenar çizgisi – son sütun hariç */
  .footer-column.border-right{border-right:2px solid #555;padding-right:40px;}
  .footer-column.border-right:last-of-type{border-right:none;}

  /* logo sütunu */
  .logo-column img{max-width:160px;height:auto;}

  /* liste biçimi */
  .footer-links ul{margin:0;padding:0;list-style:none;}
  .footer-links li{margin-bottom:6px;text-align:left;}

  /* iletişim sütunu özel stiller */
  .contact-column {
      line-height: 1.6;
  }
  .contact-column p {
      margin: 0 0 10px 0;
      color: #ccc;
  }
  .contact-column .contact-text {
      font-size: 14px;
      margin-bottom: 8px;
  }
  .contact-column .contact-email {
      font-size: 15px;
      font-weight: 600;
      color: #fff;
  }
  .contact-column .contact-email:hover {
      color: #4f9eff;
  }

  /* PDF MODAL STİLLERİ */
  .pdf-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
  }

  .pdf-modal.active {
      display: flex;
      opacity: 1;
      align-items: center;
      justify-content: center;
      padding: 20px;
  }

  .pdf-modal-content {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 1000px;
      height: 85%;
      max-height: 800px;
      position: relative;
      overflow: hidden;
      transform: scale(0.9);
      transition: transform 0.3s ease-in-out;
  }

  .pdf-modal.active .pdf-modal-content {
      transform: scale(1);
  }

  .pdf-modal-header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 12px 12px 0 0;
  }

  .pdf-modal-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
  }

  .pdf-icon {
      width: 24px;
      height: 24px;
      background: #e74c3c;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
  }

  .pdf-modal-close {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
  }

  .pdf-modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
  }

  .pdf-modal-body {
      height: calc(100% - 70px);
      padding: 0;
      overflow: hidden;
  }

  .pdf-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #f8f9fa;
  }

  .pdf-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      background: #f8f9fa;
      font-size: 16px;
      color: #666;
  }

  .pdf-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e3e3e3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 15px;
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  /* PDF stilleri gereksizleri kaldır */
  .pdf-download-btn {
      display: none;
  }

  /* responsive ince ayar */
  @media (max-width:767px){
      .footer-columns{gap:30px;justify-content:center;}
      .footer-column.border-right{border-right:none;padding-right:0;}
      
      .pdf-modal-content {
          width: 95%;
          height: 90%;
          margin: 20px;
      }
      
      .pdf-modal-header {
          padding: 12px 15px;
      }
      
      .pdf-modal-title {
          font-size: 16px;
      }
  }

  @media (max-width: 480px) {
      .pdf-modal-content {
          width: 100%;
          height: 100%;
          margin: 0;
          border-radius: 0;
      }
      
      .pdf-modal-header {
          border-radius: 0;
      }
  }
</style>

<footer class="site-footer">
  <!-- .container tutmaya devam, genişlik eskisi gibi ortada -->
  <div class="container">
    {% block footer_content %}
    <div class="footer-columns">

      <!-- LOGO ------------------------------------------------------>
      <div class="footer-column logo-column border-right">
        <a class="logoalt" href="https://izka.org.tr">
          <img src="/base/images/theme/logo-izka-beyaz.png"
               alt="İzmir Kalkınma Ajansı"
               title="İzmir Kalkınma Ajansı" />
        </a>
      </div>

      <!-- MENÜ / LİNKLER ------------------------------------------->
      <div class="footer-column footer-links border-right">
        {% block footer_nav %}
          <ul>
            {% block footer_links %}
            {% endblock %}
          </ul>
          <ul>
            {% block footer_links_ckan %}
              {% set api_url = 'http://docs.ckan.org/en/{0}/api/'.format(g.ckan_doc_version) %}
              <li><a href="https://dataizmir.izka.org.tr/veripnihai.pdf" class="pdf-link">Veri&nbsp;Politikası</a></li>
              <li><a href="https://dataizmir.izka.org.tr/kvkknihai.pdf" class="pdf-link">KVKK</a></li>
              <li><a href="https://dataizmir.izka.org.tr/kosulnihai.pdf" class="pdf-link">Kullanım&nbsp;Koşulları</a></li>
            {% endblock %}
          </ul>
        {% endblock %}
      </div>

      <!-- İLETİŞİM -------------------------------------------------->
      <div class="footer-column contact-column">
        <p class="contact-text">Görüş ve önerileriniz için:</p>
        <a href="mailto:yenilik@izka.org.tr" class="contact-email">
          yenilik@izka.org.tr
        </a>
      </div>

    </div>
    {% endblock %}
  </div>

  {% block footer_debug %}
    {% if g.debug %}
      {% include 'snippets/debug.html' %}
    {% endif %}
  {% endblock %}
</footer>

<!-- PDF MODAL -->
<div id="pdfModal" class="pdf-modal">
  <div class="pdf-modal-content">
    <div class="pdf-modal-header">
      <h3 class="pdf-modal-title">
        <div class="pdf-icon">PDF</div>
        <span id="pdfModalTitle">PDF Belge</span>
      </h3>
      <button class="pdf-modal-close" id="pdfModalClose">×</button>
    </div>
    <div class="pdf-modal-body">
      <div class="pdf-loading" id="pdfLoading">
        <div class="pdf-spinner"></div>
        PDF yükleniyor...
      </div>
      <iframe id="pdfIframe" class="pdf-iframe" style="display: none;"></iframe>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===========================================
    // FOOTER POZİSYONLAMA SİSTEMİ
    // ===========================================
    
    function stickFooterToBottom() {
        const footer = document.querySelector('.site-footer');
        const body = document.body;
        
        if (!footer) return;
        
        // Footer yüksekliğini hesapla
        // Önce sticky class'ını kaldır ki doğal yüksekliği alabilelim
        footer.classList.remove('sticky-bottom');
        body.classList.remove('footer-padded');
        document.documentElement.style.removeProperty('--footer-height');
        
        // DOM güncelmesini bekle
        setTimeout(() => {
            const footerHeight = footer.offsetHeight;
            
            // CSS custom property olarak footer yüksekliği
            document.documentElement.style.setProperty('--footer-height', footerHeight + 'px');
            
            // Footer'ı en alta yapıştır
            footer.classList.add('sticky-bottom');
            
            // Body'ye padding ekle
            body.classList.add('footer-padded');
            
            console.log('Footer en alta yapıştırıldı, yükseklik:', footerHeight + 'px');
        }, 10);
    }
    
    function checkUrlAndSetFooterPosition() {
        const currentPath = window.location.pathname;
        const footer = document.querySelector('.site-footer');
        
        if (!footer) return;
        
        // Admin/Edit sayfası URL pattern'leri
        const adminPagePatterns = [
            /\/dataset\/.*\/resource\/.*\/edit$/,           // /dataset/.../resource/.../edit
            /\/dataset\/groups\/.*/,                        // /dataset/groups/...
            /\/organization\/groups\/.*/,                   // /organization/groups/...
            /\/dataset\/.*\/resource\/new$/,                // /dataset/.../resource/new
            /\/organization\/members\/.*/,                  // /organization/members/...
            /\/group\/members\/.*/,                         // /group/members/...
            /\/organization\/member_new\/.*/,               // /organization/member_new/...
            /\/group\/member_new\/.*/,                      // /group/member_new/...
            /\/ckan-admin\/config$/,                        // /ckan-admin/config
            /\/temalar$/,                                   // /temalar
            /\/dashboard\/temalar$/,                        // /dashboard/temalar
            /\/user\/.*\/api-tokens$/,                      // /user/.../api-tokens
            /\/user\/edit\/izkaacikveri$/                   // /user/edit/izkaacikveri
        ];
        
        // URL'nin admin sayfası olup olmadığını kontrol et
        const isAdminPage = adminPagePatterns.some(pattern => pattern.test(currentPath));
        
        console.log(isAdminPage ? 'Admin sayfa tespit edildi:' : 'Normal sayfa:', currentPath);
        
        // Her durumda footer'ı en alta yapıştır
        stickFooterToBottom();
    }
    
    // Sayfa yüklendiğinde kontrol et
    checkUrlAndSetFooterPosition();
    
    // Resize olaylarında footer'ı yeniden yapıştır
    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(stickFooterToBottom, 100);
    });
    
    // Orientation change için (mobil cihazlar)
    window.addEventListener('orientationchange', function() {
        setTimeout(stickFooterToBottom, 300);
    });
    
    // Zoom seviyesi değiştiğinde (wheel + ctrl)
    window.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(stickFooterToBottom, 200);
        }
    });
    
    // Klavye zoom (ctrl + +/-)
    window.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '=' || e.key === '0')) {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(stickFooterToBottom, 200);
        }
    });
    
    // Window yeniden odaklandığında (zoom, dev tools vs. sonrası)
    window.addEventListener('focus', function() {
        setTimeout(stickFooterToBottom, 100);
    });
    
    // Tam sayfa yüklenme sonrası final kontrol
    window.addEventListener('load', function() {
        setTimeout(stickFooterToBottom, 200);
    });
    
    // SPA (Single Page App) durumları için URL değişikliklerini dinle
    // History API değişikliklerini yakala
    const originalPushState = history.pushState;
    const originalReplaceState = history.replaceState;
    
    history.pushState = function() {
        originalPushState.apply(this, arguments);
        setTimeout(checkUrlAndSetFooterPosition, 50);
    };
    
    history.replaceState = function() {
        originalReplaceState.apply(this, arguments);
        setTimeout(checkUrlAndSetFooterPosition, 50);
    };
    
    // Popstate eventi (geri/ileri butonları)
    window.addEventListener('popstate', function() {
        setTimeout(checkUrlAndSetFooterPosition, 50);
    });
    
    // Hash değişikliklerini de dinle
    window.addEventListener('hashchange', function() {
        setTimeout(checkUrlAndSetFooterPosition, 50);
    });

    // ===========================================
    // PDF MODAL SİSTEMİ
    // ===========================================
    
    const modal = document.getElementById('pdfModal');
    const modalTitle = document.getElementById('pdfModalTitle');
    const modalClose = document.getElementById('pdfModalClose');
    const pdfIframe = document.getElementById('pdfIframe');
    const pdfLoading = document.getElementById('pdfLoading');

    // Tüm PDF linklerini bul (hem .pdf-link class'ı olanları hem de .pdf ile bitenleri)
    function findPdfLinks() {
        const pdfLinks = [];
        
        // Class'ı pdf-link olanları ekle
        document.querySelectorAll('a.pdf-link').forEach(link => {
            pdfLinks.push(link);
        });
        
        // .pdf ile biten tüm linkleri ekle (eğer zaten eklenmemişse)
        document.querySelectorAll('a[href$=".pdf"]').forEach(link => {
            if (!pdfLinks.includes(link)) {
                pdfLinks.push(link);
            }
        });
        
        return pdfLinks;
    }

    // PDF linklerine click event ekle
    function attachPdfEvents() {
        const pdfLinks = findPdfLinks();
        
        pdfLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                openPdfModal(this.href, this.textContent.trim());
            });
        });
    }

    // PDF modal'ını aç
    function openPdfModal(pdfUrl, title) {
        modalTitle.textContent = title || 'PDF Belge';
        
        // Loading göster, iframe gizle
        pdfLoading.style.display = 'flex';
        pdfIframe.style.display = 'none';
        
        // Modal'ı göster
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // PDF'i iframe'e yükle - sadece PDF içeriği, toolbar/navpane yok
        pdfIframe.src = pdfUrl + '#toolbar=0&navpanes=0&scrollbar=1&view=FitH';
        
        // iframe yüklenince loading'i gizle
        pdfIframe.onload = function() {
            setTimeout(() => {
                pdfLoading.style.display = 'none';
                pdfIframe.style.display = 'block';
            }, 500);
        };
    }

    // Modal'ı kapat
    function closePdfModal() {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        
        setTimeout(() => {
            pdfIframe.src = '';
            pdfLoading.style.display = 'flex';
            pdfIframe.style.display = 'none';
        }, 300);
    }

    // Event listeners
    modalClose.addEventListener('click', closePdfModal);
    
    // Modal dışına tıklayınca kapat
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closePdfModal();
        }
    });

    // ESC tuşu ile kapat
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closePdfModal();
        }
    });

    // PDF linklerini başlat
    attachPdfEvents();
    
    // Dinamik içerik için observer (eğer sayfa sonradan PDF linkleri eklerse)
    const observer = new MutationObserver(function(mutations) {
        let shouldUpdateFooter = false;
        
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length > 0) {
                attachPdfEvents();
                
                // Önemli DOM değişiklikleri varsa footer'ı güncelle
                Array.from(mutation.addedNodes).forEach(node => {
                    if (node.nodeType === Node.ELEMENT_NODE && 
                        (node.offsetHeight > 30 || (node.querySelector && node.querySelector('*')))) {
                        shouldUpdateFooter = true;
                    }
                });
            }
        });
        
        if (shouldUpdateFooter) {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(stickFooterToBottom, 150);
        }
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});
</script>