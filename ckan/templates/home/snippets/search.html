{% set tags = h.get_facet_items_dict('tags', c.search_facets, limit=3) %}
{% set placeholder = "" %}
<style>
  .search-form{
    margin-top: 12px!important;
    margin-bottom: 0!important;
    border-top: none!important;
  }

  .moduleout{
    padding: 0.004%;
    background-color: #699df67a;
    border-radius: 5px;
  }

  .search-form .search-input.search-giant input{
    padding: 5px!important;
  }
  .form-control {
    width: 80%!important;

  }

  .search-form .search-input button i{
    color: #fff;
  }

</style>
<div class="moduleout">
  <h1 class="page-heading" style="color:#fff;font-size: 16px!important;margin-bottom: -10px!important;padding: 3px;">Veri Setini Arayƒ±n</h1>
  <div class="module">
    <form class="module-content search-form" method="get" action="{% url_for 'dataset.search' %}">
      <div class="search-input form-group search-giant">
        <input aria-label="{% block header_site_search_label %}{{ _('Search datasets') }}{% endblock %}"
          id="field-main-search" type="text" class="form-control" name="q" value="" autocomplete="off"
          placeholder="{% block search_placeholder %}{{ placeholder }}{% endblock %}" />
        <button type="submit" aria-labelledby="search-label">
          <i class="fa fa-search"></i>
          <span class="sr-only" id="search-label">{{ _('Search') }}</span>
        </button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // T√ºrk√ße karakter d√∂n√º≈üt√ºrme fonksiyonu
  function turkishToNormalized(text) {
    if (!text) return '';
    
    // T√ºrk√ße karakter d√∂n√º≈ü√ºm tablosu
    const turkishChars = {
      '√á': 'C', '√ß': 'c',
      'ƒû': 'G', 'ƒü': 'g', 
      'ƒ∞': 'I', 'ƒ±': 'i',
      '√ñ': 'O', '√∂': 'o',
      '≈û': 'S', '≈ü': 's',
      '√ú': 'U', '√º': 'u'
    };
    
    return text.replace(/[√á√ßƒûƒüƒ∞ƒ±√ñ√∂≈û≈ü√ú√º]/g, function(match) {
      return turkishChars[match] || match;
    });
  }

  // Geli≈ümi≈ü arama terimi hazƒ±rlama fonksiyonu
  function prepareSearchTerms(searchTerm) {
    if (!searchTerm) return [];
    
    const terms = [];
    const cleanTerm = searchTerm.trim();
    
    // 1. Orijinal arama terimi
    terms.push(cleanTerm);
    
    // 2. Normalize edilmi≈ü arama terimi (T√ºrk√ße karakterler ƒ∞ngilizce'ye √ßevrilmi≈ü)
    const normalizedTerm = turkishToNormalized(cleanTerm);
    if (normalizedTerm !== cleanTerm) {
      terms.push(normalizedTerm);
    }
    
    // 3. K√º√ß√ºk harfli versiyonlarƒ± da ekle
    const lowerOriginal = cleanTerm.toLowerCase();
    const lowerNormalized = normalizedTerm.toLowerCase();
    
    if (!terms.includes(lowerOriginal)) {
      terms.push(lowerOriginal);
    }
    if (!terms.includes(lowerNormalized)) {
      terms.push(lowerNormalized);
    }
    
    // 4. B√ºy√ºk harfli versiyonlarƒ± da ekle
    const upperOriginal = cleanTerm.toUpperCase();
    const upperNormalized = normalizedTerm.toUpperCase();
    
    if (!terms.includes(upperOriginal)) {
      terms.push(upperOriginal);
    }
    if (!terms.includes(upperNormalized)) {
      terms.push(upperNormalized);
    }
    
    // Benzersiz terimleri d√∂nd√ºr
    return [...new Set(terms)].filter(term => term.length > 0);
  }

  // Arama formunu ve input alanƒ±nƒ± se√ßiyoruz
  const searchForm = document.querySelector('.search-form');
  const searchInput = document.getElementById('field-main-search');

  if (searchForm && searchInput) {
    // Form g√∂nderildiƒüinde (Enter'a basƒ±ldƒ±ƒüƒ±nda veya butona tƒ±klandƒ±ƒüƒ±nda) √ßalƒ±≈üacak
    searchForm.addEventListener('submit', function(e) {
      const searchTerm = searchInput.value.trim();
      
      if (searchTerm) {
        // T√ºrk√ße karakter kontrol√º ve uyarƒ±
        const normalizedTerm = turkishToNormalized(searchTerm);
        const hasTurkishChars = normalizedTerm !== searchTerm;
        
        if (hasTurkishChars) {
          console.log(`üî§ T√ºrk√ße karakter tespit edildi: "${searchTerm}" ‚Üí "${normalizedTerm}"`);
          console.log('üîç Geli≈ümi≈ü arama aktif: Hem orijinal hem normalize edilmi≈ü karakterlerle arama yapƒ±lacak');
        }
        
        // Orijinal arama terimini localStorage'a kaydet
        // Ana tabloda bu terim kullanƒ±larak geli≈ümi≈ü arama yapƒ±lacak
        localStorage.setItem('globalSearchTerm', searchTerm);
        
        // Form normal ≈üekilde g√∂nderilsin - CKAN'ƒ±n kendi arama mantƒ±ƒüƒ± √ßalƒ±≈üsƒ±n
        console.log(`üì§ Form g√∂nderiliyor: "${searchTerm}"`);
        console.log('üíæ localStorage\'a kaydedildi, ana tabloda geli≈ümi≈ü arama yapƒ±lacak');
        
        // URL'ye de arama terimini ekle (CKAN'ƒ±n standart davranƒ±≈üƒ±)
        const currentAction = searchForm.action;
        const separator = currentAction.includes('?') ? '&' : '?';
        const newAction = `${currentAction}${separator}q=${encodeURIComponent(searchTerm)}`;
        
        // Form action'ƒ±nƒ± g√ºncelle
        searchForm.action = newAction;
      }
    });

    // Input alanƒ±nda ger√ßek zamanlƒ± karakter kontrol√º
    searchInput.addEventListener('input', function() {
      const currentValue = this.value;
      const normalizedValue = turkishToNormalized(currentValue);
      
      // T√ºrk√ße karakter varsa g√∂rsel geri bildirim verebiliriz
      if (normalizedValue !== currentValue && currentValue.length > 0) {
        // ƒ∞steƒüe baƒülƒ±: Input'a √∂zel bir class ekleyebiliriz
        this.setAttribute('data-has-turkish-chars', 'true');
        this.title = `T√ºrk√ße karakterli arama: "${currentValue}"\nAyrƒ±ca ≈üu ≈üekilde de aranacak: "${normalizedValue}"`;
      } else {
        this.removeAttribute('data-has-turkish-chars');
        this.title = '';
      }
    });

    // Enter tu≈üu ile arama
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchForm.dispatchEvent(new Event('submit'));
      }
    });

    // Sayfa y√ºklendiƒüinde mevcut URL'den arama terimini al
    const urlParams = new URLSearchParams(window.location.search);
    const qParam = urlParams.get('q');
    if (qParam) {
      searchInput.value = qParam;
      console.log(`üîó URL'den arama terimi alƒ±ndƒ±: "${qParam}"`);
      
      // T√ºrk√ße karakter kontrol√º
      const normalizedParam = turkishToNormalized(qParam);
      if (normalizedParam !== qParam) {
        console.log(`üî§ URL'deki arama teriminde T√ºrk√ße karakter: "${qParam}" ‚Üí "${normalizedParam}"`);
        searchInput.setAttribute('data-has-turkish-chars', 'true');
        searchInput.title = `T√ºrk√ße karakterli arama: "${qParam}"\nAyrƒ±ca ≈üu ≈üekilde de aranacak: "${normalizedParam}"`;
      }
    }
  }

  // Global arama testi fonksiyonu (geli≈ütirme ama√ßlƒ±)
  window.testTurkishSearch = function(testTerm) {
    console.log('=== T√úRK√áE ARAMA TESTƒ∞ ===');
    console.log(`Test terimi: "${testTerm}"`);
    
    const searchTerms = prepareSearchTerms(testTerm);
    console.log('Hazƒ±rlanan arama terimleri:', searchTerms);
    
    const normalizedTerm = turkishToNormalized(testTerm);
    console.log(`Normalize edilmi≈ü: "${normalizedTerm}"`);
    
    const hasTurkishChars = normalizedTerm !== testTerm;
    console.log(`T√ºrk√ße karakter var mƒ±: ${hasTurkishChars}`);
    
    console.log('=== TEST TAMAMLANDI ===');
    
    return {
      original: testTerm,
      normalized: normalizedTerm,
      hasTurkishChars: hasTurkishChars,
      allTerms: searchTerms
    };
  };

  // Geli≈ütirme ama√ßlƒ± test √∂rnekleri
  if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
    console.log('üß™ Geli≈ütirme modu tespit edildi. T√ºrk√ße arama testleri:');
    
    const testCases = [
      'ithalat',
      'ƒ∞thalat', 
      'ITHALAT',
      'ihracat',
      'ƒ∞hracat',
      'ticaret',
      'Ticaret',
      'g√∂√ß',
      'G√∂√ß',
      '√∂zet',
      '√ñzet',
      '≈üirket',
      '≈ûirket'
    ];
    
    testCases.forEach(testCase => {
      const result = window.testTurkishSearch(testCase);
      if (result.hasTurkishChars) {
        console.log(`‚úì "${result.original}" ‚Üí "${result.normalized}"`);
      }
    });
  }
});

// CSS stilleri - T√ºrk√ße karakter g√∂rsel geri bildirimi i√ßin
const style = document.createElement('style');
style.textContent = `
  /* T√ºrk√ße karakterli input i√ßin g√∂rsel geri bildirim */
  input[data-has-turkish-chars="true"] {
    border-left: 3px solid #17a2b8 !important;
    background-image: linear-gradient(45deg, transparent 30%, rgba(23, 162, 184, 0.1) 30%, rgba(23, 162, 184, 0.1) 70%, transparent 70%);
  }
  
  /* Hover durumunda tooltip benzeri efekt */
  input[data-has-turkish-chars="true"]:focus {
    box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.3) !important;
  }
`;
document.head.appendChild(style);
</script>