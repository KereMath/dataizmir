{% extends "page.html" %}

{% block subtitle %}{{ _('Mekansal G√∂sterim') }}{% endblock %}

{% block primary %}
<style>
  .mekansal-container {
    padding: 20px;
    max-width: 100%;
    background-color: #f8f9fa;
  }

  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 25px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.2);
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
  }

  .stats-bar {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
    flex-wrap: wrap;
  }

  .stat-item {
    background: rgba(255,255,255,0.15);
    padding: 10px 20px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    text-align: center;
  }

  .stat-number {
    font-size: 1.4rem;
    font-weight: 700;
    display: block;
  }

  .stat-label {
    font-size: 0.8rem;
    opacity: 0.9;
    margin-top: 3px;
  }

  .controls-section {
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-input {
    flex: 1;
    min-width: 200px;
    padding: 10px 14px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
  }

  .search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
  }

  .filter-select {
    padding: 10px 14px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    background: white;
    font-size: 14px;
    min-width: 140px;
  }

  .packages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
    gap: 20px;
  }

  .package-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.08);
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
  }

  .package-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  }

  .package-header {
    padding: 16px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
    user-select: none;
  }

  .package-header:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
  }

  .package-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .package-title {
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
    text-decoration: none;
    line-height: 1.3;
    flex: 1;
  }

  .package-title:hover {
    color: #667eea;
    text-decoration: none;
  }

  .collapse-toggle {
    background: none;
    border: none;
    font-size: 18px;
    color: #6c757d;
    cursor: pointer;
    padding: 0 5px;
    transition: transform 0.3s ease;
  }

  .collapse-toggle:hover {
    color: #495057;
  }

  .collapse-toggle.collapsed {
    transform: rotate(-90deg);
  }

  .package-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
  }

  .org-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
  }

  .package-date {
    color: #6c757d;
    font-size: 12px;
  }

  .resource-count-badge {
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
  }

  .spatial-count-badge {
    background: #007bff;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    margin-left: 5px;
  }

  .resources-list {
    padding: 12px;
    max-height: 400px;
    overflow-y: auto;
    display: block;
  }

  .resources-list.collapsed {
    display: none;
  }

  .resource-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 3px solid transparent;
    transition: all 0.2s ease;
  }

  .resource-item:hover {
    background: #e9ecef;
    border-left-color: #667eea;
  }

  .resource-item:last-child {
    margin-bottom: 0;
  }

  .resource-item.spatial-active {
    border-left-color: #28a745;
    background: #f8fff9;
  }

  .resource-info {
    flex: 1;
    min-width: 0;
  }

  .resource-name {
    font-size: 13px;
    font-weight: 500;
    color: #495057;
    margin: 0 0 4px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .resource-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 4px;
  }

  .resource-size {
    font-size: 11px;
    color: #6c757d;
  }

  .resource-actions {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-shrink: 0;
  }

  .format-badge {
    display: inline-block;
    padding: 3px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    min-width: 35px;
    text-align: center;
  }

  /* Format renkleri */
  .format-csv { background: #d4edda; color: #155724; }
  .format-json { background: #fff3cd; color: #856404; }
  .format-geojson { background: #d1ecf1; color: #0c5460; }
  .format-xml { background: #f8d7da; color: #721c24; }
  .format-pdf { background: #cce5ff; color: #004085; }
  .format-xls, .format-xlsx { background: #e2e3e5; color: #383d41; }
  .format-doc, .format-docx { background: #cfe2ff; color: #052c65; }
  .format-txt { background: #f1f3f5; color: #495057; }
  .format-rtf { background: #fff0f6; color: #7c2d12; }
  .format-zip, .format-rar, .format-7z { background: #fef3c7; color: #92400e; }
  .format-shp { background: #dcfce7; color: #166534; }
  .format-kml { background: #ddd6fe; color: #5b21b6; }
  .format-gml { background: #fed7d7; color: #c53030; }
  .format-wkt { background: #bee3f8; color: #2c5282; }
  .format-gpx { background: #f0fff4; color: #22543d; }
  .format-kmz { background: #e9d5ff; color: #6b46c1; }
  .format-sql { background: #ede9fe; color: #5b21b6; }
  .format-db, .format-sqlite { background: #f3e8ff; color: #6b21a8; }
  .format-html, .format-htm { background: #fef2f2; color: #991b1b; }
  .format-css { background: #dbeafe; color: #1e40af; }
  .format-js { background: #fef3c7; color: #d97706; }
  .format-php { background: #e0e7ff; color: #3730a3; }
  .format-py { background: #fef3c7; color: #b45309; }
  .format-java { background: #fed7d7; color: #c53030; }
  .format-cpp, .format-c { background: #e2e8f0; color: #2d3748; }
  .format-img, .format-jpg, .format-jpeg, .format-png, .format-gif, .format-bmp, .format-tiff { background: #fef5e7; color: #c05621; }
  .format-svg { background: #f0fff4; color: #276749; }
  .format-ico { background: #e6fffa; color: #234e52; }
  .format-mp3, .format-wav, .format-ogg, .format-flac { background: #fed7e2; color: #97266d; }
  .format-mp4, .format-avi, .format-mov, .format-wmv, .format-flv { background: #e0e7ff; color: #3730a3; }
  .format-rss, .format-atom { background: #fef3c7; color: #92400e; }
  .format-wms, .format-wfs, .format-wcs { background: #dcfce7; color: #166534; }
  .format-api { background: #f0f9ff; color: #0c4a6e; }
  .format-rest { background: #ecfdf5; color: #065f46; }
  .format-soap { background: #fffbeb; color: #92400e; }
  .format-other { background: #f1f5f9; color: #475569; }

  .spatial-indicator {
    color: #059669;
    font-size: 12px;
    margin-left: 4px;
  }

  .spatial-toggle {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
    margin-left: 8px;
  }

  .spatial-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
  }

  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .toggle-slider {
    background-color: #28a745;
  }

  input:checked + .toggle-slider:before {
    transform: translateX(20px);
  }

  .action-btn {
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .btn-view {
    background: #28a745;
    color: white;
  }

  .btn-view:hover {
    background: #218838;
    color: white;
    text-decoration: none;
  }

  .btn-download {
    background: #007bff;
    color: white;
  }

  .btn-download:hover {
    background: #0056b3;
    color: white;
    text-decoration: none;
  }

  .no-resources {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-style: italic;
    font-size: 13px;
  }

  .loading {
    text-align: center;
    padding: 40px;
    color: #6c757d;
    grid-column: 1 / -1;
  }

  .error {
    background: #f8d7da;
    color: #721c24;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    grid-column: 1 / -1;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
    grid-column: 1 / -1;
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
  }

  .spatial-filter {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #e3f2fd;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
  }

  .spatial-count {
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .bulk-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #dee2e6;
  }

  .bulk-btn {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
    background: white;
    color: #495057;
  }

  .bulk-btn:hover {
    background: #f8f9fa;
    text-decoration: none;
    color: #495057;
  }

  .bulk-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
  }

  @media (max-width: 768px) {
    .packages-grid {
      grid-template-columns: 1fr;
    }
    
    .controls-section {
      flex-direction: column;
      align-items: stretch;
    }
    
    .search-input,
    .filter-select {
      min-width: 100%;
    }
    
    .package-meta {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .resource-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
    }
    
    .resource-actions {
      align-self: flex-end;
    }
  }
</style>

<div class="mekansal-container">
  <div class="page-header">
    <h1 class="page-title">Mekansal Resource Y√∂netimi</h1>
    <div class="stats-bar">
      <div class="stat-item">
        <span class="stat-number" id="totalPackages">-</span>
        <div class="stat-label">Toplam Paket</div>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="totalResources">-</span>
        <div class="stat-label">Toplam Kaynak</div>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="spatialResources">-</span>
        <div class="stat-label">Mekansal Se√ßili</div>
      </div>
      <div class="stat-item">
        <span class="stat-number" id="totalFormats">-</span>
        <div class="stat-label">Farklƒ± Format</div>
      </div>
    </div>
  </div>

  <div class="controls-section">
    <input type="text" class="search-input" id="searchInput" placeholder="Paket veya kaynak ara...">
    <select class="filter-select" id="formatFilter">
      <option value="">T√ºm Formatlar</option>
    </select>
    <select class="filter-select" id="orgFilter">
      <option value="">T√ºm Organizasyonlar</option>
    </select>
    <div class="spatial-filter">
      üó∫Ô∏è Mekansal: <span class="spatial-count" id="spatialCount">0</span>
    </div>
  </div>

  <div class="packages-grid" id="packagesGrid">
    <div class="loading">Veriler y√ºkleniyor...</div>
  </div>
</div>

<script>
console.log('üöÄ Mekansal Resource Y√∂netimi Ba≈ülƒ±yor');

class SpatialResourceManager {
  constructor() {
    this.allResources = [];
    this.filteredResources = [];
    this.organizations = new Set();
    this.allFormats = [];
    this.spatialFormats = ['geojson', 'shp', 'kml', 'gml', 'wkt', 'wfs', 'wms', 'wcs', 'gpx', 'kmz', 'api', 'json'];
    this.spatialResourceIds = new Set();
    this.collapsedPackages = new Set();
    this.init();
  }

  async init() {
    console.log('üéØ Initialization ba≈ülƒ±yor...');
    try {
      console.log('üì¶ 1. Resource verileri y√ºkleniyor...');
      await this.loadSpatialResources();
      
      console.log('üéõÔ∏è 2. Event listener kurulumu...');
      this.setupEventListeners();
      
      console.log('üìã 3. Filtreler dolduruluyor...');
      this.populateFilters();
      
      console.log('üé® 4. ƒ∞lk render...');
      this.filterAndRender();
      
      console.log('üìä 5. ƒ∞statistikler...');
      this.updateStats();
      
      console.log('‚úÖ Initialization tamamlandƒ±!');
    } catch (error) {
      console.error('‚ùå Initialization hatasƒ±:', error);
      this.showError('Veri y√ºklenirken hata olu≈ütu: ' + error.message);
    }
  }

  async loadSpatialResources() {
    try {
      console.log('üåê Spatial resources API √ßaƒürƒ±sƒ±...');
      const response = await fetch('/api/spatial-resources', {
        credentials: 'include'
      });
      
      const data = await response.json();
      console.log('üì° Spatial API yanƒ±tƒ±:', data.success, data.count);
      
      if (!data.success) {
        throw new Error(data.error || 'Spatial resources API hatasƒ±');
      }

      this.allResources = data.resources || [];
      console.log('üì¶ Resource sayƒ±sƒ±:', this.allResources.length);
      
      // Spatial resource ID'lerini topla
      this.allResources.forEach(resource => {
        if (resource.organization_title) {
          this.organizations.add(resource.organization_title);
        }
        
        if (resource.format && resource.format.trim()) {
          const format = resource.format.toLowerCase().trim();
          if (!this.allFormats.includes(format)) {
            this.allFormats.push(format);
          }
        }
        
        if (resource.is_spatial) {
          this.spatialResourceIds.add(resource.resource_id);
        }
      });

      this.allFormats.sort();
      console.log('üè¢ Organizasyon sayƒ±sƒ±:', this.organizations.size);
      console.log('üìÑ Format sayƒ±sƒ±:', this.allFormats.length);
      console.log('üó∫Ô∏è Spatial resource sayƒ±sƒ±:', this.spatialResourceIds.size);
      
    } catch (error) {
      console.error('‚ùå Spatial resources y√ºkleme hatasƒ±:', error);
      throw error;
    }
  }

  async toggleSpatialResource(resourceId, isSpatial) {
    try {
      console.log(`üîÑ Spatial toggle: ${resourceId} -> ${isSpatial}`);
      
      const response = await fetch('/api/spatial-resources/toggle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify({
          resource_id: resourceId,
          is_spatial: isSpatial
        })
      });
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Toggle i≈ülemi ba≈üarƒ±sƒ±z');
      }
      
      // Local state'i g√ºncelle
      if (isSpatial) {
        this.spatialResourceIds.add(resourceId);
      } else {
        this.spatialResourceIds.delete(resourceId);
      }
      
      // Resource'un is_spatial deƒüerini g√ºncelle
      const resource = this.allResources.find(r => r.resource_id === resourceId);
      if (resource) {
        resource.is_spatial = isSpatial;
      }
      
      this.updateStats();
      this.updatePackageCounters();
      console.log('‚úÖ Spatial toggle ba≈üarƒ±lƒ±');
      
      return true;
    } catch (error) {
      console.error('‚ùå Spatial toggle hatasƒ±:', error);
      alert('Spatial durumu deƒüi≈ütirilemedi: ' + error.message);
      return false;
    }
  }

  togglePackageCollapse(packageId) {
    if (this.collapsedPackages.has(packageId)) {
      this.collapsedPackages.delete(packageId);
    } else {
      this.collapsedPackages.add(packageId);
    }
    
    // G√∂rsel g√ºncelleme
    const resourcesList = document.getElementById(`resources-${packageId}`);
    const toggleBtn = document.getElementById(`toggle-${packageId}`);
    
    if (resourcesList && toggleBtn) {
      if (this.collapsedPackages.has(packageId)) {
        resourcesList.classList.add('collapsed');
        toggleBtn.classList.add('collapsed');
      } else {
        resourcesList.classList.remove('collapsed');
        toggleBtn.classList.remove('collapsed');
      }
    }
  }

  bulkTogglePackage(packageId, enable) {
    const packageResources = this.allResources.filter(r => r.package_id === packageId);
    
    packageResources.forEach(async (resource) => {
      const shouldToggle = enable ? !resource.is_spatial : resource.is_spatial;
      if (shouldToggle) {
        await this.toggleSpatialResource(resource.resource_id, enable);
        
        // Checkbox'ƒ± g√ºncelle
        const checkbox = document.querySelector(`input[onchange*="${resource.resource_id}"]`);
        if (checkbox) {
          checkbox.checked = enable;
        }
        
        // Resource item'ƒ± g√ºncelle
        const resourceItem = checkbox?.closest('.resource-item');
        if (resourceItem) {
          if (enable) {
            resourceItem.classList.add('spatial-active');
          } else {
            resourceItem.classList.remove('spatial-active');
          }
        }
      }
    });
    
    setTimeout(() => this.updatePackageCounters(), 100);
  }

  updatePackageCounters() {
    const packageGroups = {};
    this.allResources.forEach(resource => {
      if (!packageGroups[resource.package_id]) {
        packageGroups[resource.package_id] = {
          total: 0,
          spatial: 0
        };
      }
      packageGroups[resource.package_id].total++;
      if (resource.is_spatial) {
        packageGroups[resource.package_id].spatial++;
      }
    });

    Object.keys(packageGroups).forEach(packageId => {
      const counter = document.getElementById(`spatial-counter-${packageId}`);
      if (counter) {
        counter.textContent = packageGroups[packageId].spatial;
      }
    });
  }

  setupEventListeners() {
    const searchInput = document.getElementById('searchInput');
    const formatFilter = document.getElementById('formatFilter');
    const orgFilter = document.getElementById('orgFilter');

    if (!searchInput || !formatFilter || !orgFilter) {
      console.error('‚ùå Filter elementleri bulunamadƒ±!');
      return;
    }

    // Debounce arama
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        this.filterAndRender();
      }, 300);
    });

    formatFilter.addEventListener('change', () => this.filterAndRender());
    orgFilter.addEventListener('change', () => this.filterAndRender());
  }

  populateFilters() {
    const orgFilter = document.getElementById('orgFilter');
    const formatFilter = document.getElementById('formatFilter');
    
    // Organizasyon filtresini doldur
    [...this.organizations].sort().forEach(org => {
      const option = document.createElement('option');
      option.value = org;
      option.textContent = org;
      orgFilter.appendChild(option);
    });

    // Format filtresini doldur
    this.allFormats.forEach(format => {
      const option = document.createElement('option');
      option.value = format.toLowerCase();
      option.textContent = format.toUpperCase();
      formatFilter.appendChild(option);
    });
  }

  filterAndRender() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const formatFilter = document.getElementById('formatFilter').value.toLowerCase();
    const orgFilter = document.getElementById('orgFilter').value;

    this.filteredResources = this.allResources.filter(resource => {
      // Arama filtresi
      if (searchTerm) {
        const searchText = `${resource.package_title} ${resource.resource_name}`.toLowerCase();
        if (!searchText.includes(searchTerm)) {
          return false;
        }
      }

      // Format filtresi
      if (formatFilter && (resource.format || '').toLowerCase() !== formatFilter) {
        return false;
      }

      // Organizasyon filtresi
      if (orgFilter && resource.organization_title !== orgFilter) {
        return false;
      }

      return true;
    });

    this.renderResources();
  }

  renderResources() {
    const grid = document.getElementById('packagesGrid');
    
    if (this.filteredResources.length === 0) {
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <div>Filtre kriterlerine uygun resource bulunamadƒ±</div>
        </div>
      `;
      return;
    }

    // Paketlere g√∂re grupla
    const packageGroups = {};
    this.filteredResources.forEach(resource => {
      if (!packageGroups[resource.package_id]) {
        packageGroups[resource.package_id] = {
          package: resource,
          resources: []
        };
      }
      packageGroups[resource.package_id].resources.push(resource);
    });

    const html = Object.values(packageGroups).map(group => this.renderPackageCard(group)).join('');
    grid.innerHTML = html;
  }

  renderPackageCard(group) {
    const pkg = group.package;
    const resources = group.resources;
    const spatialCount = resources.filter(r => r.is_spatial).length;
    const isCollapsed = this.collapsedPackages.has(pkg.package_id);
    
    return `
      <div class="package-card">
        <div class="package-header" onclick="spatialManager.togglePackageCollapse('${pkg.package_id}')">
          <div class="package-title-row">
            <a href="/dataset/${pkg.package_name}" class="package-title" onclick="event.stopPropagation()">
              ${pkg.package_title}
            </a>
            <button class="collapse-toggle ${isCollapsed ? 'collapsed' : ''}" id="toggle-${pkg.package_id}">
              ‚ñº
            </button>
          </div>
          <div class="package-meta">
            <span class="org-badge">${pkg.organization_title || 'Bilinmiyor'}</span>
            <div>
              <span class="resource-count-badge">${resources.length} kaynak</span>
              <span class="spatial-count-badge" id="spatial-counter-${pkg.package_id}">${spatialCount} mekansal</span>
            </div>
          </div>
        </div>
        <div class="resources-list ${isCollapsed ? 'collapsed' : ''}" id="resources-${pkg.package_id}">
          ${resources.map(resource => this.renderResourceItem(resource)).join('')}
          <div class="bulk-actions">
            <button class="bulk-btn" onclick="spatialManager.bulkTogglePackage('${pkg.package_id}', true)">
              T√ºm√ºn√º Mekansal Yap
            </button>
            <button class="bulk-btn" onclick="spatialManager.bulkTogglePackage('${pkg.package_id}', false)">
              T√ºm√ºn√º ƒ∞ptal Et
            </button>
          </div>
        </div>
      </div>
    `;
  }

  renderResourceItem(resource) {
    const format = (resource.format || 'other').toLowerCase();
    const formatClass = this.getFormatClass(format);
    const isSpatial = resource.is_spatial;
    const resourceName = resource.resource_name || 'ƒ∞simsiz kaynak';
    const resourceSize = resource.size ? this.formatFileSize(resource.size) : '';

    return `
      <div class="resource-item ${isSpatial ? 'spatial-active' : ''}">
        <div class="resource-info">
          <div class="resource-name" title="${resourceName}">
            ${resourceName}
            ${this.isSpatialFormat(format) ? '<span class="spatial-indicator">üó∫</span>' : ''}
          </div>
          <div class="resource-meta">
            <span class="format-badge ${formatClass}">${format.toUpperCase()}</span>
            ${resourceSize ? `<span class="resource-size">${resourceSize}</span>` : ''}
          </div>
        </div>
        <div class="resource-actions">
          <label class="spatial-toggle" title="Mekansal katmana ekle/√ßƒ±kar">
            <input type="checkbox" 
                   ${isSpatial ? 'checked' : ''} 
                   onchange="spatialManager.toggleSpatialResource('${resource.resource_id}', this.checked)">
            <span class="toggle-slider"></span>
          </label>
          <a href="/dataset/${resource.package_name}/resource/${resource.resource_id}" class="action-btn btn-view">G√∂r√ºnt√ºle</a>
          ${resource.url ? `<a href="${resource.url}" class="action-btn btn-download" target="_blank">ƒ∞ndir</a>` : ''}
        </div>
      </div>
    `;
  }

  getFormatClass(format) {
    const formats = {
      'csv': 'format-csv', 'json': 'format-json', 'geojson': 'format-geojson',
      'xml': 'format-xml', 'pdf': 'format-pdf', 'xls': 'format-xls',
      'xlsx': 'format-xlsx', 'doc': 'format-doc', 'docx': 'format-docx',
      'txt': 'format-txt', 'rtf': 'format-rtf', 'zip': 'format-zip',
      'rar': 'format-rar', '7z': 'format-7z', 'shp': 'format-shp',
      'kml': 'format-kml', 'gml': 'format-gml', 'wkt': 'format-wkt',
      'gpx': 'format-gpx', 'kmz': 'format-kmz', 'sql': 'format-sql',
      'db': 'format-db', 'sqlite': 'format-sqlite', 'html': 'format-html',
      'htm': 'format-html', 'css': 'format-css', 'js': 'format-js',
      'api': 'format-api', 'rest': 'format-rest', 'soap': 'format-soap'
    };
    return formats[format] || 'format-other';
  }

  isSpatialFormat(format) {
    return this.spatialFormats.includes(format.toLowerCase());
  }

  formatFileSize(bytes) {
    if (!bytes) return '';
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(1024));
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
  }

  updateStats() {
    const totalPackages = new Set(this.allResources.map(r => r.package_id)).size;
    const totalResources = this.allResources.length;
    const spatialResources = this.spatialResourceIds.size;
    const totalFormats = this.allFormats.length;

    document.getElementById('totalPackages').textContent = totalPackages.toLocaleString('tr-TR');
    document.getElementById('totalResources').textContent = totalResources.toLocaleString('tr-TR');
    document.getElementById('spatialResources').textContent = spatialResources.toLocaleString('tr-TR');
    document.getElementById('totalFormats').textContent = totalFormats.toLocaleString('tr-TR');
    document.getElementById('spatialCount').textContent = spatialResources.toLocaleString('tr-TR');
  }

  showError(message) {
    const grid = document.getElementById('packagesGrid');
    grid.innerHTML = `
      <div class="error">
        ‚ùå ${message}
      </div>
    `;
  }
}

// Global deƒüi≈üken
let spatialManager;

// Sayfa y√ºklendiƒüinde ba≈ülat
document.addEventListener('DOMContentLoaded', () => {
  spatialManager = new SpatialResourceManager();
});
</script>

{% endblock %}