{% extends "page.html" %}

{% block subtitle %}{{ _('Organizations') }}{% endblock %}
{%- block header %}
    {% include "header.html" %}
    <div id="title" class="package-title container-fluid" style="background-image:url('/base/images/theme/background_photo.jpg');color:#fff;">
      <div class="background-overlay">
      <div class="restricted-max-width">
      <div class="col-xs-12 col-md-10 col-md-offset-1">
      <div id="title-container" class="col-xs-10 col-md-6 text-left">
      <h1 style="margin-left: 200px;">Veri Paydaşları</h1>
      </div>
      <div id="stats" class="col-xs-12 col-md-4 col-md-offset-2">
      <div class="col-xs-12" style="text-align: center;margin-top: 20px;font-size: 16px;">
      <p class="stat" style="font-size: 30px;font-weight: bolder;"><span id="showing-count">{{page.item_count}}</span><span style="font-size: 18px"> Veri Paydaşı</span></p>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
{% endblock -%}

{% block breadcrumb_content %}
  <li class="active">{% link_for _('Organizations'), named_route=group_type+'.index' %}</li>
{% endblock %}

{% block page_header %}{% endblock %}

{% block page_primary_action %}
  {% if h.check_access('organization_create') %}
    {% link_for _('Add Organization'), named_route=group_type+'.new', class_='btn21 btn-primary', icon='plus-square' %}
  {% endif %}
{% endblock %}

{% block primary_content_inner %}
  <h1 class="hide-heading">{% block page_heading %}{{ _('Organizations') }}{% endblock %}</h1>
  
  <!-- Veri Paydaşları Açıklaması -->
  <!-- <div class="organizations-info" style="margin-bottom: 30px;">
    {% snippet "organization/snippets/helper.html" %}
  </div> -->
  
  <!-- TAMAMEN CLIENT-SIDE FİLTRELEME -->
  <div class="search-and-filters" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; background: #fff; padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
    <!-- Arama Input -->
    <div style="flex: 2; min-width: 250px;">
      <input type="text" 
             class="form-control" 
             placeholder="Veri paydaşı ismi ile arayın..." 
             id="search-input"
             style="width: 100%; border: 2px solid #e5e7eb; border-radius: 6px; ; background-image: url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; fill=&quot;%23666&quot; viewBox=&quot;0 0 16 16&quot;><path d=&quot;M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z&quot;/></svg>'); background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px;">
    </div>
    
    <!-- Sıralama -->
    <div style="flex: 1; min-width: 180px;">
      <select class="form-control" id="sort-select" style="border: 2px solid #e5e7eb; border-radius: 6px; ;">
        <option value="name-asc">İsim (A-Z)</option>
        <option value="name-desc">İsim (Z-A)</option>
        <option value="count-desc">En Çok Veri Seti</option>
        <option value="count-asc">En Az Veri Seti</option>
      </select>
    </div>
    
    <!-- Sayfa başına gösterim -->
    <div style="flex: 1; min-width: 120px;">
      <select class="form-control" id="limit-select" style="border: 2px solid #e5e7eb; border-radius: 6px; ;">
        <option value="5">5'li</option>
        <option value="10">10'lu</option>
        <option value="20" selected>20'li</option>
      </select>
    </div>
  </div>
  
  {% block organizations_list %}
    {% if page.items or request.params %}
      {% if page.items %}
        <!-- Organizasyon listesi container -->
        <div id="organizations-container">
          <ul class="media-grid" id="organizations-list" style="padding: 0; margin: 0; list-style: none; min-height: 240px !important; background: none; border: 1px solid #ddd; border-width: 1px 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <!-- JavaScript ile doldurulacak -->
          </ul>
        </div>
        
        <!-- Pagination container -->
        <div id="pagination-container" style="text-align: center; margin-top: 30px;"></div>
        
        <!-- Tüm organizasyonları API'den çekmek için script -->
        <script>
        // Global değişkenler
        let allOrganizations = [];
        let filteredOrganizations = [];
        let currentPage = 1;
        let itemsPerPage = 20;
        document.addEventListener('DOMContentLoaded', () => loadAllOrganizations());

        async function loadAllOrganizations(){
          try{
            const res = await fetch('/api/3/action/organization_list?all_fields=true&include_extras=true&limit=1000');
            const data = await res.json();
            if(data.success && data.result){
              allOrganizations = data.result.map(o=>({name:o.name,display_name:o.display_name||o.title||o.name,package_count:+o.package_count||0,image_url:o.image_display_url||'/base/images/placeholder-organization.png',url:'/organization/'+o.name,state:o.state||'unknown'}));
              filteredOrganizations=[...allOrganizations];updateUI();setupEvents();
            }else loadFallbackData();
          }catch(e){loadFallbackData();}
        }
        function loadFallbackData(){
          allOrganizations=[{% for org in page.items %}{name:"{{org.name}}",display_name:"{{org.display_name or org.title or org.name}}",package_count:{{org.package_count or 0}},image_url:"{{org.image_display_url or h.url_for_static('/base/images/placeholder-organization.png')}}",url:"{{ h.url_for((org.type or 'organization') ~ '.read', id=org.name) }}"}{% if not loop.last %},{% endif %}{% endfor %}];
          filteredOrganizations=[...allOrganizations];updateUI();setupEvents();
        }
        function setupEvents(){
          document.getElementById('search-input').addEventListener('input',filterAndRender);
          document.getElementById('sort-select').addEventListener('change',filterAndRender);
          document.getElementById('limit-select').addEventListener('change',e=>{itemsPerPage=+e.target.value;currentPage=1;updateUI();});
        }
        function filterAndRender(){
          const s=document.getElementById('search-input').value.toLowerCase().trim(),sort=document.getElementById('sort-select').value;
          filteredOrganizations=allOrganizations.filter(o=>o.display_name.toLowerCase().includes(s));
          filteredOrganizations.sort((a,b)=>({ 'name-asc':()=>a.display_name.localeCompare(b.display_name,'tr'),'name-desc':()=>b.display_name.localeCompare(a.display_name,'tr'),'count-desc':()=>b.package_count-a.package_count,'count-asc':()=>a.package_count-b.package_count }[sort]||(()=>0))());
          currentPage=1;updateUI();
        }
        const updateUI=()=>{renderOrgs();renderPag();document.getElementById('showing-count').textContent=filteredOrganizations.length;}
        function renderOrgs(){
          const c=document.getElementById('organizations-list');
          const start=(currentPage-1)*itemsPerPage,end=start+itemsPerPage,items=filteredOrganizations.slice(start,end);
          c.innerHTML=items.length?items.map(o=>`<li style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;text-align:center;transition:.2s;box-shadow:0 2px 5px rgba(0,0,0,.05);display:flex;flex-direction:column;justify-content:space-between;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 15px rgba(0,0,0,.1)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 5px rgba(0,0,0,.05)'"><div><img src="${o.image_url}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin:0 auto 15px;"><h2 style="font-size:18px;margin:0 0 10px;color:#333;">${o.display_name}</h2><strong style="display:block;margin-bottom:15px;color:#666;">${o.package_count} Veri Seti</strong></div><a href="${o.url}" style="display:inline-block;background:#4f7cc1;color:#fff!important;border-radius:4px;padding:8px 16px;margin-top:auto;text-decoration:none;transition:.2s;" onmouseover="this.style.background='#3a5a8a'" onmouseout="this.style.background='#4f7cc1'">Görüntüle</a></li>`).join(''):`<li style="grid-column:1/-1;text-align:center;padding:40px;color:#666;">Hiçbir veri paydaşı bulunamadı.</li>`;
        }
        function renderPag(){
          const c=document.getElementById('pagination-container'),total=Math.ceil(filteredOrganizations.length/itemsPerPage);
          if(total<=1){c.innerHTML='';return;}
          let h='<ul style="display:inline-flex;gap:5px;list-style:none;padding:0;margin:0;">';
          if(currentPage>1)h+=`<li><a href="#" onclick="go(${currentPage-1})" style="padding:8px 12px;border:1px solid #ddd;border-radius:4px;text-decoration:none;color:#333;">« Önceki</a></li>`;
          for(let i=1;i<=Math.min(total,10);i++)h+=i===currentPage?`<li><span style="padding:8px 12px;background:#4f46e5;color:#fff;border-radius:4px;">${i}</span></li>`:`<li><a href="#" onclick="go(${i})" style="padding:8px 12px;border:1px solid #ddd;border-radius:4px;text-decoration:none;color:#333;">${i}</a></li>`;
          if(currentPage<total)h+=`<li><a href="#" onclick="go(${currentPage+1})" style="padding:8px 12px;border:1px solid #ddd;border-radius:4px;text-decoration:none;color:#333;">Sonraki »</a></li>`;
          c.innerHTML=h+'</ul>';
        }
        const go=p=>{currentPage=p;updateUI();window.scrollTo(0,0);}
        </script>
        
      {% endif %}
    {% else %}
      <p class="empty">
        {{ _('There are currently no organizations for this site') }}.
        {% if h.check_access('organization_create') %}
          {% link_for _('How about creating one?'), named_route=group_type+'.new' %}
        {% endif %}
      </p>
    {% endif %}
  {% endblock %}
{% endblock %}

{% block secondary_content %}{% endblock %}

{# ------------------- SOLDAN FLOT VERİ PAYDAŞI EKLE ------------------- #}
{% if h.check_access('organization_create') %}
  <a href="{{ h.url_for(group_type + '.new') }}" class="fab-left" title="{{ _('Add Organization') }}">
    <i class="fa fa-plus"></i>
    <span class="fab-label">Ekle</span>
  </a>
{% endif %}

<style>
/* Layout override’ların hepsi yerinde */
body div.row.wrapper:before,div.row.wrapper:before{display:none!important;content:none!important}
@media(min-width:768px){.col-sm-9{width:100%!important;}}
body.page-organization aside.secondary.col-sm-3{display:none!important;}
.organizations-info .module{background:#f8f9fa;border:1px solid #dee2e6;border-radius:6px;}
@media(max-width:768px){
  .search-and-filters{flex-direction:column!important;gap:10px!important;}
  .search-and-filters>div{width:100%!important;flex:none!important;min-width:auto!important;}
  .media-grid{grid-template-columns:repeat(2,1fr)!important;gap:15px!important;}
}
@media(max-width:480px){
  .media-grid{grid-template-columns:1fr!important;gap:10px!important;}
}
.media-grid:before{display:none!important;}

/* --------- SOLDAN KAYDIRMAYAN MODERN FAB --------- */
.fab-left{
  position:fixed;
  left:30px;
  top:50%;
  transform:translateY(-50%);
  width:64px;
  height:64px;
  background:#ff0075;
  color:#fff!important;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  transition:box-shadow .15s,transform .15s;
  text-decoration:none;
  z-index:1100;
  overflow:hidden;
}
.fab-left:hover{
  box-shadow:0 6px 18px rgba(0,0,0,.35);
  transform:translateY(-50%) scale(1.05);
}
/* Etiket animasyonu */
.fab-label{
  position:absolute;
  left:100%;
  margin-left:12px;
  background:#ff0075;
  padding:6px 12px;
  border-radius:6px;
  font-size:14px;
  font-weight:600;
  white-space:nowrap;
  opacity:0;
  transform:translateX(-10px);
  transition:opacity .2s,transform .2s;
  pointer-events:none;
}
.fab-left:hover .fab-label{
  opacity:1;
  transform:translateX(0);
}
/* Küçük ekranlarda boyutu küçült */
@media(max-width:768px){
  .fab-left{width:54px;height:54px;font-size:26px;left:18px;}
  .fab-label{font-size:13px;}
}
</style>
