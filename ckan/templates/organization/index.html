{% extends "page.html" %}

{% block subtitle %}{{ _('Organizations') }}{% endblock %}
{%- block header %}
    {% include "header.html" %}
    <div id="title" class="package-title container-fluid" style="background-image:url(&quot;/base/images/theme/background_photo.jpg&quot;);color: #fff;">
      <div class="background-overlay">
      <div class="restricted-max-width">
      <div class="col-xs-12 col-md-10 col-md-offset-1">
      <div id="title-container" class="col-xs-10 col-md-6 text-left">
      <h1 style="margin-left: 200px;">Veri Paydaşları</h1>
      </div>
      <div id="stats" class="col-xs-12 col-md-4 col-md-offset-2">
      <div class="col-xs-12" style="text-align: center;margin-top: 20px;font-size: 16px;">
      <p class="stat" style="font-size: 30px;font-weight: bolder;"><span id="showing-count">{{page.item_count}}</span><span style="font-size: 18px"> Veri Paydaşı</span></p>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
  {% endblock -%}
{% block breadcrumb_content %}
  <li class="active">{% link_for _('Organizations'), named_route=group_type+'.index' %}</li>
{% endblock %}

{% block page_header %}{% endblock %}

{% block page_primary_action %}
  {% if h.check_access('organization_create') %}
    {% link_for _('Add Organization'), named_route=group_type+'.new', class_='btn btn-primary', icon='plus-square' %}
  {% endif %}
{% endblock %}

{% block primary_content_inner %}
  <h1 class="hide-heading">{% block page_heading %}{{ _('Organizations') }}{% endblock %}</h1>
  
  <!-- Veri Paydaşları Açıklaması -->
  <div class="organizations-info" style="margin-bottom: 30px;">
    {% snippet "organization/snippets/helper.html" %}
  </div>
  
  <!-- Basit Arama ve Filtreleme -->
  <div class="search-and-filters" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
    <!-- Arama Input -->
    <div style="flex: 2; min-width: 250px;">
      <input type="text" 
             class="form-control" 
             placeholder="Veri paydaşı ismi ile arayın..." 
             id="search-input"
             style="width: 100%;">
    </div>
    
    <!-- Sıralama -->
    <div style="flex: 1; min-width: 180px;">
      <select class="form-control" id="sort-select">
        <option value="name-asc">İsim (A-Z)</option>
        <option value="name-desc">İsim (Z-A)</option>
        <option value="count-desc">En Çok Veri Seti</option>
        <option value="count-asc">En Az Veri Seti</option>
      </select>
    </div>
    
    <!-- Sayfa başına gösterim -->
    <div style="flex: 1; min-width: 120px;">
      <select class="form-control" id="limit-select">
        <option value="5">5'li</option>
        <option value="10">10'lu</option>
        <option value="20" selected>20'li</option>
      </select>
    </div>
  </div>
  
  {% block organizations_list %}
    {% if page.items or request.params %}
      {% if page.items %}
        <!-- Orijinal organizasyon listesi - JavaScript ile manipüle edilecek -->
        <div id="organizations-container">
          {% snippet "organization/snippets/organization_list.html", organizations=page.items %}
        </div>
        
        <!-- Pagination container -->
        <div id="pagination-container"></div>
        
        <!-- JavaScript için organizasyon verilerini gizli olarak sakla -->
        <script type="application/json" id="org-data">
        [
          {% for org in page.items %}
          {
            "name": "{{ org.name }}",
            "display_name": "{{ org.display_name }}",
            "package_count": {{ org.package_count or 0 }},
            "image_url": "{{ org.image_display_url or h.url_for_static('/base/images/placeholder-organization.png') }}",
            "url": "{{ h.url_for(org.type ~ '.read', id=org.name) }}"
          }{% if not loop.last %},{% endif %}
          {% endfor %}
        ]
        </script>
      {% endif %}
    {% else %}
      <p class="empty">
        {{ _('There are currently no organizations for this site') }}.
        {% if h.check_access('organization_create') %}
          {% link_for _('How about creating one?'), named_route=group_type+'.new' %}</a>.
        {% endif %}
      </p>
    {% endif %}
  {% endblock %}
{% endblock %}

{% block secondary_content %}
  <!-- Boş bırakıldı -->
{% endblock %}

<script>
// Basit filtreleme ve pagination sistemi
let allOrgs = [];
let filteredOrgs = [];
let currentPage = 1;
let itemsPerPage = 30;

// Sayfa yüklendiğinde çalışacak
document.addEventListener('DOMContentLoaded', function() {
    // Önce template'den gelen veriyi al
    const orgDataElement = document.getElementById('org-data');
    if (orgDataElement) {
        allOrgs = JSON.parse(orgDataElement.textContent);
        filteredOrgs = [...allOrgs];
    }
    
    // Sonra API'den tüm organizasyonları çek
    loadAllOrganizations();
});

// API'den tüm organizasyonları çek
async function loadAllOrganizations() {
    try {
        const response = await fetch('/api/3/action/organization_list?all_fields=true&include_extras=true');
        const data = await response.json();
        
        if (data.success && data.result.length > allOrgs.length) {
            // API'den daha fazla organizasyon geldi, onları kullan
            allOrgs = data.result.map(org => ({
                name: org.name,
                display_name: org.display_name || org.title || org.name,
                package_count: org.package_count || 0,
                image_url: org.image_display_url || '/base/images/placeholder-organization.png',
                url: `/organization/${org.name}`
            }));
            
            filteredOrgs = [...allOrgs];
            document.getElementById('showing-count').textContent = allOrgs.length;
            
            // Event listener'ları yeniden kur
            setupEventListeners();
            console.log(`${allOrgs.length} organizasyon yüklendi`);
        } else {
            // API'den az veri geldi veya hata oldu, mevcut veriyi kullan
            setupEventListeners();
            console.log(`Template'den ${allOrgs.length} organizasyon kullanılıyor`);
        }
    } catch (error) {
        console.log('API hatası, mevcut veri kullanılıyor:', error);
        setupEventListeners();
    }
}

function setupEventListeners() {
    // Event listener'ları ekle
    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const limitSelect = document.getElementById('limit-select');
    // Arama - her tuş vuruşunda
    searchInput.addEventListener('input', function() {
        filterAndRender();
    });
    
    // Sıralama - seçilir seçilmez
    sortSelect.addEventListener('change', function() {
        filterAndRender();
    });
    
    // Limit - seçilir seçilmez
    limitSelect.addEventListener('change', function() {
        itemsPerPage = parseInt(this.value);
        currentPage = 1;
        renderPagination();
        renderCurrentPage();
    });
}

function filterAndRender() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const sortBy = document.getElementById('sort-select').value;
    
    // Filtreleme
    filteredOrgs = allOrgs.filter(org => 
        org.display_name.toLowerCase().includes(searchTerm)
    );
    
    // Sıralama
    filteredOrgs.sort((a, b) => {
        switch(sortBy) {
            case 'name-asc':
                return a.display_name.localeCompare(b.display_name, 'tr');
            case 'name-desc':
                return b.display_name.localeCompare(a.display_name, 'tr');
            case 'count-desc':
                return b.package_count - a.package_count;
            case 'count-asc':
                return a.package_count - b.package_count;
            default:
                return 0;
        }
    });
    
    // Sayfa numarasını sıfırla
    currentPage = 1;
    
    // Toplam sayıyı güncelle
    document.getElementById('showing-count').textContent = filteredOrgs.length;
    
    // Render et
    renderPagination();
    renderCurrentPage();
}

function renderCurrentPage() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const currentOrgs = filteredOrgs.slice(startIndex, endIndex);
    
    const container = document.querySelector('#organizations-container .media-grid');
    if (!container) return;
    
    if (currentOrgs.length === 0) {
        container.innerHTML = '<li><p class="empty">Hiçbir veri paydaşı bulunamadı.</p></li>';
        return;
    }
    
    container.innerHTML = currentOrgs.map(org => `
        <li class="media-item">
            <img src="${org.image_url}" alt="${org.name}" class="img-responsive media-image">
            <h2 class="media-heading">${org.display_name}</h2>
            <strong class="count">${org.package_count} Veri Seti</strong>
            <a href="${org.url}" title="${org.display_name} görüntüle" class="media-view">
                <span>${org.display_name} görüntüle</span>
            </a>
        </li>
    `).join('');
}

function renderPagination() {
    const totalPages = Math.ceil(filteredOrgs.length / itemsPerPage);
    const container = document.getElementById('pagination-container');
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<div class="text-center"><ul class="pagination">';
    
    // Önceki
    if (currentPage > 1) {
        html += `<li><a href="#" onclick="goToPage(${currentPage - 1})">« Önceki</a></li>`;
    }
    
    // Sayfa numaraları
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPage) {
            html += `<li class="active"><span>${i}</span></li>`;
        } else {
            html += `<li><a href="#" onclick="goToPage(${i})">${i}</a></li>`;
        }
    }
    
    // Sonraki
    if (currentPage < totalPages) {
        html += `<li><a href="#" onclick="goToPage(${currentPage + 1})">Sonraki »</a></li>`;
    }
    
    html += '</ul></div>';
    container.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    renderCurrentPage();
    renderPagination();
    window.scrollTo(0, 0);
}
</script>

<style>
/* En yüksek öncelik için body de ekliyoruz */
body div.row.wrapper:before {
  content: none !important;
  display: none !important;
}
div.row.wrapper:before{display:none!important;content:none!important}

.wrapper:before {
    content: '';
    display: none !important;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    width: 25%;
    border-right: 1px solid #ddd;
    z-index: 1;
}

div.row.wrapper:before {
  display: none !important;   /* görünmez yap */
  content: none !important;   /* varsa içeriği temizle */
}

@media (min-width: 768px) {
    .col-sm-9 {
         width: 100% !important; 
    }
}

body.page-organization aside.secondary.col-sm-3 {
  display: none !important;
}

.organizations-info .module {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
}

.search-and-filters {
    background: #fff;
    padding: 20px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}

.search-and-filters .form-control {
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    padding: 10px 15px;
    transition: all 0.2s ease;
}

.search-and-filters .form-control:focus {
    border-color: #4f46e5;
    outline: none;
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.media-grid {
    padding-left: 0;
    margin: 0;
    list-style: none;
    min-height: 240px !important;
    padding-top: 15px;
    background: none;
    border: 1px solid #ddd;
    border-width: 1px 0;
}

/* Responsive tasarım */
@media (max-width: 768px) {
    .search-and-filters {
        flex-direction: column;
        gap: 10px !important;
    }
    
    .search-and-filters > div {
        width: 100% !important;
        flex: none !important;
        min-width: auto !important;
    }
}

#search-input {
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23666" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 40px;
}

.pagination {
    margin-top: 20px;
}

.pagination li a {
    padding: 8px 12px;
    text-decoration: none;
    border: 1px solid #ddd;
    color: #333;
    border-radius: 4px;
    margin: 0 2px;
}

.pagination li.active span {
    background: #4f46e5;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
}

.pagination li a:hover {
    background: #f5f5f5;
    text-decoration: none;
}
</style>