{% extends "page.html" %}

{% block subtitle %}{{ _('Organizations') }}{% endblock %}
{%- block header %}
    {% include "header.html" %}
    <div id="title" class="package-title container-fluid" style="background-image:url('/base/images/theme/background_photo.jpg');color:#fff;">
      <div class="background-overlay">
        <div class="restricted-max-width">
          <div class="col-xs-12 col-md-10 col-md-offset-1">
            <div id="title-container" class="col-xs-10 col-md-6 text-left">
              <h1 style="margin-left:200px;">Veri Paydaşları</h1>
            </div>
            <div id="stats" class="col-xs-12 col-md-4 col-md-offset-2">
              <div class="col-xs-12" style="text-align:center;margin-top:20px;font-size:16px;">
                <p class="stat" style="font-size:30px;font-weight:bolder;">
                  <span id="showing-count">{{ page.item_count }}</span>
                  <span style="font-size:18px"> Veri Paydaşı</span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
{% endblock -%}

{% block breadcrumb_content %}
  <li class="active">{% link_for _('Organizations'), named_route=group_type+'.index' %}</li>
{% endblock %}

{# ------ VARSAYILAN CKAN BUTONUNU GİZLE ------ #}
{% block page_header %}{% endblock %}
{% block page_primary_action %}{# boş #}{% endblock %}

{# ========================================================== #
 #                 ANA İÇERİK BLOĞU                           #
 # ========================================================== #}
{% block primary_content_inner %}
  <h1 class="hide-heading">{% block page_heading %}{{ _('Organizations') }}{% endblock %}</h1>

  {# ---------- Arama & Filtre Kutusu ---------- #}
  <div class="search-and-filters" style="display:flex;gap:15px;margin-bottom:20px;align-items:center;flex-wrap:wrap;background:#fff;padding:20px;border:2px solid #e5e7eb;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.05);">
    <div style="flex:2;min-width:250px;">
      <input type="text" class="form-control" placeholder="Veri paydaşı ismi ile arayın..."
             id="search-input"
             style="width:100%;border:2px solid #e5e7eb;border-radius:6px;background-image:url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; fill=&quot;%23666&quot; viewBox=&quot;0 0 16 16&quot;><path d=&quot;M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z&quot;/></svg>');background-repeat:no-repeat;background-position:right 12px center;padding-right:40px;">
    </div>
    <div style="flex:1;min-width:180px;">
      <select class="form-control" id="sort-select" style="border:2px solid #e5e7eb;border-radius:6px;">
        <option value="name-asc">İsim (A-Z)</option>
        <option value="name-desc">İsim (Z-A)</option>
        <option value="count-desc">En Çok Veri Seti</option>
        <option value="count-asc">En Az Veri Seti</option>
      </select>
    </div>
    <div style="flex:1;min-width:120px;">
      <select class="form-control" id="limit-select" style="border:2px solid #e5e7eb;border-radius:6px;">
        <option value="5">5'li</option>
        <option value="10">10'lu</option>
        <option value="20" selected>20'li</option>
      </select>
    </div>
  </div>

  {# ---------- Organizasyon Listesi ---------- #}
  {% block organizations_list %}
    {% if page.items or request.params %}
      {% if page.items %}
        <div id="organizations-container">
          <ul class="media-grid" id="organizations-list" style="padding:0;margin:0;list-style:none;min-height:240px!important;background:none;border:1px solid #ddd;border-width:1px 0;display:grid;grid-template-columns:repeat(3,1fr);gap:20px;">
            <!-- JS dolduracak -->
          </ul>
        </div>
        <div id="pagination-container" style="text-align:center;margin-top:30px;"></div>

        <script>
        /* ------------------ JS KODUN TAMAMI (değişmedi) ------------------ */
        let allOrganizations=[],filteredOrganizations=[],currentPage=1,itemsPerPage=20;
        document.addEventListener('DOMContentLoaded',()=>loadAllOrganizations());
        async function loadAllOrganizations(){
          try{
            const response=await fetch('/api/3/action/organization_list?all_fields=true&include_extras=true&limit=1000');
            const data=await response.json();
            if(data.success&&data.result&&data.result.length){
              allOrganizations=data.result.map(o=>({name:o.name||'',display_name:o.display_name||o.title||o.name||'',package_count:parseInt(o.package_count)||0,image_url:o.image_display_url||'/base/images/placeholder-organization.png',url:'/organization/'+(o.name||''),state:o.state||'unknown'}));
              filteredOrganizations=[...allOrganizations];updateUI();setupEventListeners();
            }else{loadFallbackData();}
          }catch(e){console.error(e);loadFallbackData();}
        }
        function loadFallbackData(){
          allOrganizations=[{% for org in page.items %}{name:"{{ org.name }}",display_name:"{{ org.display_name or org.title or org.name }}",package_count:{{ org.package_count or 0 }},image_url:"{{ org.image_display_url or h.url_for_static('/base/images/placeholder-organization.png') }}",url:"{{ h.url_for((org.type or 'organization') ~ '.read', id=org.name) }}"}{% if not loop.last %},{% endif %}{% endfor %}];
          filteredOrganizations=[...allOrganizations];updateUI();setupEventListeners();
        }
        function setupEventListeners(){
          document.getElementById('search-input').addEventListener('input',filterAndRender);
          document.getElementById('sort-select').addEventListener('change',filterAndRender);
          document.getElementById('limit-select').addEventListener('change',function(){itemsPerPage=parseInt(this.value);currentPage=1;updateUI();});
        }
        function filterAndRender(){
          const s=document.getElementById('search-input').value.toLowerCase().trim(),sortBy=document.getElementById('sort-select').value;
          filteredOrganizations=allOrganizations.filter(o=>o.display_name.toLowerCase().includes(s));
          filteredOrganizations.sort((a,b)=>{switch(sortBy){case'name-asc':return a.display_name.localeCompare(b.display_name,'tr');case'name-desc':return b.display_name.localeCompare(a.display_name,'tr');case'count-desc':return b.package_count-a.package_count;case'count-asc':return a.package_count-b.package_count;default:return 0;}});
          currentPage=1;updateUI();
        }
        function updateUI(){renderOrganizations();renderPagination();document.getElementById('showing-count').textContent=filteredOrganizations.length;}
        function renderOrganizations(){
          const c=document.getElementById('organizations-list');if(!c)return;
          const start=(currentPage-1)*itemsPerPage,end=start+itemsPerPage,items=filteredOrganizations.slice(start,end);
          if(!items.length){c.innerHTML='<li style="grid-column:1/-1;text-align:center;padding:40px;color:#666;">Hiçbir veri paydaşı bulunamadı.</li>';return;}
          c.innerHTML=items.map(o=>`<li style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:15px;text-align:center;transition:.2s;box-shadow:0 2px 5px rgba(0,0,0,0.05);display:flex;flex-direction:column;justify-content:space-between;" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'"><div><img src="${o.image_url}" alt="${o.name}" style="width:80px;height:80px;object-fit:cover;border-radius:50%;margin:0 auto 15px;"><h2 style="font-size:18px;margin:0 0 10px;color:#333;">${o.display_name}</h2><strong style="display:block;margin-bottom:15px;color:#666;">${o.package_count} Veri Seti</strong></div><a href="${o.url}" style="display:inline-block;background:#4f7cc1!important;color:#fff!important;text-decoration:none;border-radius:4px;transition:.2s;margin-top:auto;padding:8px 16px;" onmouseover="this.style.background='#3a5a8a!important'" onmouseout="this.style.background='#4f7cc1!important'">Görüntüle</a></li>`).join('');
        }
        function renderPagination(){
          const c=document.getElementById('pagination-container');if(!c)return;
          const total=Math.ceil(filteredOrganizations.length/itemsPerPage);if(total<=1){c.innerHTML='';return;}
          let h='<ul style="display:inline-flex;list-style:none;padding:0;margin:0;gap:5px;">';
          if(currentPage>1)h+=`<li><a href="#" onclick="goToPage(${currentPage-1});return false;" style="display:block;padding:8px 12px;text-decoration:none;border:1px solid #ddd;color:#333;border-radius:4px;">« Önceki</a></li>`;
          for(let i=1;i<=Math.min(total,10);i++)h+=i===currentPage?`<li><span style="display:block;padding:8px 12px;background:#4f46e5;color:#fff;border-radius:4px;">${i}</span></li>`:`<li><a href="#" onclick="goToPage(${i});return false;" style="display:block;padding:8px 12px;text-decoration:none;border:1px solid #ddd;color:#333;border-radius:4px;">${i}</a></li>`;
          if(currentPage<total)h+=`<li><a href="#" onclick="goToPage(${currentPage+1});return false;" style="display:block;padding:8px 12px;text-decoration:none;border:1px solid #ddd;color:#333;border-radius:4px;">Sonraki »</a></li>`;
          h+='</ul>';c.innerHTML=h;
        }
        function goToPage(p){currentPage=p;updateUI();window.scrollTo(0,0);}
        </script>
      {% endif %}
    {% else %}
      <p class="empty">
        {{ _('There are currently no organizations for this site') }}.
        {% if h.check_access('organization_create') %}
          {% link_for _('How about creating one?'), named_route=group_type+'.new' %}
        {% endif %}
      </p>
    {% endif %}
  {% endblock %}
{% endblock %}

{% block secondary_content %}{% endblock %}

{# ========================================================== #
 #            YÜZEN + BUTON (SOLDA)                           #
 # ========================================================== #}
{% if h.check_access('organization_create') %}
  <a href="{{ h.url_for(group_type + '.new') }}"
     class="fab-add-org"
     title="{{ _('Add Organization') }}"
     aria-label="{{ _('Add Organization') }}">
     <i class="fa fa-plus"></i>
  </a>
{% endif %}

<style>
/* CKAN kenar override'ları (değişmedi) */
body div.row.wrapper:before,div.row.wrapper:before{display:none!important;content:none!important}
@media(min-width:768px){.col-sm-9{width:100%!important;}}
body.page-organization aside.secondary.col-sm-3{display:none!important;}
.organizations-info .module{background:#f8f9fa;border:1px solid #dee2e6;border-radius:6px;}
@media(max-width:768px){
  .search-and-filters{flex-direction:column!important;gap:10px!important;}
  .search-and-filters>div{width:100%!important;flex:none!important;min-width:auto!important;}
  .media-grid{grid-template-columns:repeat(2,1fr)!important;gap:15px!important;}
}
@media(max-width:480px){.media-grid{grid-template-columns:1fr!important;gap:10px!important;}}
.media-grid:before{display:none!important;}

/* ---------- YÜZEN + (FAB) SOL KONUM ---------- */
.fab-add-org{
  position:fixed;
  top:50%;               /* sayfanın ortası */
  left:40px;             /* gridin solunda */
  transform:translateY(-50%);
  width:72px;
  height:72px;
  border-radius:50%;
  background:#ff0075;    /* dikkat çeken pembe-mor */
  color:#fff!important;
  font-size:38px;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  transition:transform .15s,box-shadow .15s;
  z-index:1100;
  text-decoration:none;
}
.fab-add-org:hover{
  transform:translate(-2px,-50%) scale(1.07);
  box-shadow:0 6px 18px rgba(0,0,0,.35);
}
@media(max-width:768px){
  .fab-add-org{
    width:60px;height:60px;font-size:30px;left:20px;
  }
}
</style>
