{% extends "page.html" %}

{% block subtitle %}{{ _('Organizations') }}{% endblock %}
{%- block header %}
    {% include "header.html" %}
    <div id="title" class="package-title container-fluid" style="background-image:url('/base/images/theme/background_photo.jpg');color:#fff;">
      <div class="background-overlay">
      <div class="restricted-max-width">
      <div class="col-xs-12 col-md-10 col-md-offset-1">
      <div id="title-container" class="col-xs-10 col-md-6 text-left">
      <h1 style="margin-left: 200px;">Veri Paydaşları</h1>
      </div>
      <div id="stats" class="col-xs-12 col-md-4 col-md-offset-2">
      <div class="col-xs-12" style="text-align: center;margin-top: 20px;font-size: 16px;">
      <p class="stat" style="font-size: 30px;font-weight: bolder;"><span id="showing-count">{{page.item_count}}</span><span style="font-size: 18px"> Veri Paydaşı</span></p>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
{% endblock -%}

{% block breadcrumb_content %}
  <li class="active">{% link_for _('Organizations'), named_route=group_type+'.index' %}</li>
{% endblock %}

{% block page_header %}{% endblock %}

{% block page_primary_action %}
  {% if h.check_access('organization_create') %}
    {#  ➜ Ekledik: özel class ve görünür metin  #}
    {% link_for _('Yeni Paydaş Oluştur'),
        named_route=group_type ~ '.new',
        class_='floating-add-org',
        icon='plus' %}
  {% endif %}
{% endblock %}


{% block primary_content_inner %}
  <h1 class="hide-heading">{% block page_heading %}{{ _('Organizations') }}{% endblock %}</h1>
  
  <!-- Veri Paydaşları Açıklaması -->
  <!-- <div class="organizations-info" style="margin-bottom: 30px;">
    {% snippet "organization/snippets/helper.html" %}
  </div> -->
  
  <!-- TAMAMEN CLIENT-SIDE FİLTRELEME -->
  <div class="search-and-filters" style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; background: #fff; padding: 20px; border: 2px solid #e5e7eb; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
    <!-- Arama Input -->
    <div style="flex: 2; min-width: 250px;">
      <input type="text" 
             class="form-control" 
             placeholder="Veri paydaşı ismi ile arayın..." 
             id="search-input"
             style="width: 100%; border: 2px solid #e5e7eb; border-radius: 6px; ; background-image: url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot; fill=&quot;%23666&quot; viewBox=&quot;0 0 16 16&quot;><path d=&quot;M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z&quot;/></svg>'); background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px;">
    </div>
    
    <!-- Sıralama -->
    <div style="flex: 1; min-width: 180px;">
      <select class="form-control" id="sort-select" style="border: 2px solid #e5e7eb; border-radius: 6px; ;">
        <option value="name-asc">İsim (A-Z)</option>
        <option value="name-desc">İsim (Z-A)</option>
        <option value="count-desc">En Çok Veri Seti</option>
        <option value="count-asc">En Az Veri Seti</option>
      </select>
    </div>
    
    <!-- Sayfa başına gösterim -->
    <div style="flex: 1; min-width: 120px;">
      <select class="form-control" id="limit-select" style="border: 2px solid #e5e7eb; border-radius: 6px; ;">
        <option value="5">5'li</option>
        <option value="10">10'lu</option>
        <option value="20" selected>20'li</option>
      </select>
    </div>
  </div>
  
  {% block organizations_list %}
    {% if page.items or request.params %}
      {% if page.items %}
        <!-- Organizasyon listesi container -->
        <div id="organizations-container">
          <ul class="media-grid" id="organizations-list" style="padding: 0; margin: 0; list-style: none; min-height: 240px !important; background: none; border: 1px solid #ddd; border-width: 1px 0; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <!-- JavaScript ile doldurulacak -->
          </ul>
        </div>
        
        <!-- Pagination container -->
        <div id="pagination-container" style="text-align: center; margin-top: 30px;"></div>
        
        <!-- Tüm organizasyonları API'den çekmek için script -->
        <script>
        // Global değişkenler
        let allOrganizations = [];
        let filteredOrganizations = [];
        let currentPage = 1;
        let itemsPerPage = 20;

        // Sayfa yüklendiğinde başlat
        document.addEventListener('DOMContentLoaded', function() {
            loadAllOrganizations();
        });

        // API'den tüm organizasyonları çek
        async function loadAllOrganizations() {
            try {
                const response = await fetch('/api/3/action/organization_list?all_fields=true&include_extras=true&limit=1000');
                const data = await response.json();
                
                if (data.success && data.result && data.result.length > 0) {
                    allOrganizations = data.result.map(org => ({
                        name: org.name || '',
                        display_name: org.display_name || org.title || org.name || '',
                        package_count: parseInt(org.package_count) || 0,
                        image_url: org.image_display_url || '/base/images/placeholder-organization.png',
                        url: '/organization/' + (org.name || ''),
                        state: org.state || 'unknown'
                    }));
                    
                    filteredOrganizations = [...allOrganizations];
                    updateUI();
                    setupEventListeners();
                    
                } else {
                    loadFallbackData();
                }
            } catch (error) {
                loadFallbackData();
            }
        }

        // Fallback: Template'den veri al
        function loadFallbackData() {
            allOrganizations = [
              {% for org in page.items %}
              {
                name: "{{ org.name }}",
                display_name: "{{ org.display_name or org.title or org.name }}",
                package_count: {{ org.package_count or 0 }},
                image_url: "{{ org.image_display_url or h.url_for_static('/base/images/placeholder-organization.png') }}",
                url: "{{ h.url_for((org.type or 'organization') ~ '.read', id=org.name) }}"
              }{% if not loop.last %},{% endif %}
              {% endfor %}
            ];
            
            filteredOrganizations = [...allOrganizations];
            updateUI();
            setupEventListeners();
        }

        // Event listener'ları kur
        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            const sortSelect = document.getElementById('sort-select');
            const limitSelect = document.getElementById('limit-select');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterAndRender);
            }
            
            if (sortSelect) {
                sortSelect.addEventListener('change', filterAndRender);
            }
            
            if (limitSelect) {
                limitSelect.addEventListener('change', function() {
                    itemsPerPage = parseInt(this.value);
                    currentPage = 1;
                    updateUI();
                });
            }
        }

        // Filtreleme ve sıralama
        function filterAndRender() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            const sortBy = document.getElementById('sort-select').value;
            
            filteredOrganizations = allOrganizations.filter(org => 
                org.display_name.toLowerCase().includes(searchTerm)
            );
            
            filteredOrganizations.sort((a, b) => {
                switch(sortBy) {
                    case 'name-asc':
                        return a.display_name.localeCompare(b.display_name, 'tr');
                    case 'name-desc':
                        return b.display_name.localeCompare(a.display_name, 'tr');
                    case 'count-desc':
                        return b.package_count - a.package_count;
                    case 'count-asc':
                        return a.package_count - b.package_count;
                    default:
                        return 0;
                }
            });
            
            currentPage = 1;
            updateUI();
        }

        // UI'yi güncelle
        function updateUI() {
            renderOrganizations();
            renderPagination();
            updateCount();
        }

        // Organizasyonları render et
        function renderOrganizations() {
            const container = document.getElementById('organizations-list');
            if (!container) return;
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentOrgs = filteredOrganizations.slice(startIndex, endIndex);
            
            if (currentOrgs.length === 0) {
                container.innerHTML = '<li style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;"><p>Hiçbir veri paydaşı bulunamadı.</p></li>';
                return;
            }
            
            const organizationHTML = currentOrgs.map(org => `
                <li style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between;" 
                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.1)'"
                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(0,0,0,0.05)'">
                    <div>
                        <img src="${org.image_url}" alt="${org.name}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; margin: 0 auto 15px; display: block;">
                        <h2 style="font-size: 18px; margin: 0 0 10px; color: #333;">${org.display_name}</h2>
                        <strong style="display: block; margin-bottom: 15px; color: #666;">${org.package_count} Veri Seti</strong>
                    </div>
                    <a href="${org.url}" style="display: inline-block; background: #4f7cc1 !important; color: white !important; text-decoration: none; border-radius: 4px; transition: background 0.2s; margin-top: auto; padding: 8px 16px;"
                       onmouseover="this.style.background='#3a5a8a !important'" 
                       onmouseout="this.style.background='#4f7cc1 !important'">
                        Görüntüle
                    </a>
                </li>
            `).join('');
            
            container.innerHTML = organizationHTML;
        }

        // Pagination render
        function renderPagination() {
            const container = document.getElementById('pagination-container');
            if (!container) return;
            
            const totalPages = Math.ceil(filteredOrganizations.length / itemsPerPage);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<ul style="display: inline-flex; list-style: none; padding: 0; margin: 0; gap: 5px;">';
            
            // Önceki
            if (currentPage > 1) {
                html += `<li><a href="#" onclick="goToPage(${currentPage - 1}); return false;" style="display: block; padding: 8px 12px; text-decoration: none; border: 1px solid #ddd; color: #333; border-radius: 4px;">« Önceki</a></li>`;
            }
            
            // Sayfa numaraları
            for (let i = 1; i <= Math.min(totalPages, 10); i++) {
                if (i === currentPage) {
                    html += `<li><span style="display: block; padding: 8px 12px; background: #4f46e5; color: white; border-radius: 4px;">${i}</span></li>`;
                } else {
                    html += `<li><a href="#" onclick="goToPage(${i}); return false;" style="display: block; padding: 8px 12px; text-decoration: none; border: 1px solid #ddd; color: #333; border-radius: 4px;">${i}</a></li>`;
                }
            }
            
            // Sonraki
            if (currentPage < totalPages) {
                html += `<li><a href="#" onclick="goToPage(${currentPage + 1}); return false;" style="display: block; padding: 8px 12px; text-decoration: none; border: 1px solid #ddd; color: #333; border-radius: 4px;">Sonraki »</a></li>`;
            }
            
            html += '</ul>';
            container.innerHTML = html;
        }

        // Sayfa değiştir
        function goToPage(page) {
            currentPage = page;
            updateUI();
            window.scrollTo(0, 0);
        }

        // Sayıyı güncelle
        function updateCount() {
            const countElement = document.getElementById('showing-count');
            if (countElement) {
                countElement.textContent = filteredOrganizations.length;
            }
        }
        </script>
        
      {% endif %}
    {% else %}
      <p class="empty">
        {{ _('There are currently no organizations for this site') }}.
        {% if h.check_access('organization_create') %}
          {% link_for _('How about creating one?'), named_route=group_type+'.new' %}</a>.
        {% endif %}
      </p>
    {% endif %}
  {% endblock %}
{% endblock %}

{% block secondary_content %}
  <!-- Boş bırakıldı -->
{% endblock %}

{# ============ SAĞ-ÜST SABİT VERİ PAYDAŞI EKLE BUTONU ============ #}
{% if h.check_access('organization_create') %}
  <a href="{{ h.url_for(group_type + '.new') }}" class="add-org-btn" title="{{ _('Add Organization') }}">
    <i class="fa fa-plus" style="margin-right:6px;"></i>Veri Paydaşı Ekle
  </a>
{% endif %}

<style>
/* CKAN layout override’ları */
body div.row.wrapper:before,
div.row.wrapper:before{display:none!important;content:none!important}
@media (min-width: 768px){.col-sm-9{width:100%!important;}}
body.page-organization aside.secondary.col-sm-3{display:none!important;}
.organizations-info .module{background:#f8f9fa;border:1px solid #dee2e6;border-radius:6px;}

@media (max-width: 768px){
  .search-and-filters{flex-direction:column!important;gap:10px!important;}
  .search-and-filters>div{width:100%!important;flex:none!important;min-width:auto!important;}
  .media-grid{grid-template-columns:repeat(2,1fr)!important;gap:15px!important;}
}
@media (max-width: 480px){
  .media-grid{grid-template-columns:1fr!important;gap:10px!important;}
}
.media-grid:before{display:none!important;}

/* Sağ-üst “Veri Paydaşı Ekle” düğmesi */
.add-org-btn{
  position:fixed;
  top:100px;          /* sayfayı kaydırınca da sabit */
  right:40px;
  padding:11px 22px;
  font-size:15px;
  font-weight:600;
  background:#ff0075;
  color:#fff!important;
  border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  transition:background .15s,transform .15s;
  z-index:1100;
  text-decoration:none;
}
.add-org-btn:hover{
  background:#d80067;
  transform:translateY(-2px);
}
@media (max-width: 768px){
  .add-org-btn{right:20px;top:90px;font-size:14px;padding:10px 18px;}
}



/* Google Font – süslü ama okunaklı */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap');

a.floating-add-org {
    position: fixed;    /* ekranda kayarken sabit */
    left: 30px;
    bottom: 30px;       /* sayfa altına yapıştır */
    z-index: 1050;      /* tooltip vb. üstünde kalsın */

    background: #6f42c1;      /* mor */
    color: #fff;
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    font-weight: 500;
    line-height: 1.2;

    padding: 14px 22px 14px 18px; /* ikon + yazı arası boşluk */
    border-radius: 9999px;        /* tam yuvarlak köşeler */
    display: flex;
    align-items: center;
    gap: 10px;

    box-shadow: 0 4px 12px rgba(0,0,0,.18);
    transition: transform .18s ease, box-shadow .18s ease;
    text-decoration: none;        /* alt çizgi olmasın */
}

a.floating-add-org:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(0,0,0,.25);
    color: #fff;                  /* hover’da da beyaz */
}

a.floating-add-org i.fa,
a.floating-add-org i.fas,
a.floating-add-org i.far {
    font-size: 1.2rem;            /* “+” ikonunu büyüt */
}

</style>
