<!-- Updated API Request Handler with Authentication -->
<script>
  // API Request Handler with Authentication
  class APIRequestHandler {
    constructor() {
      this.corsProxyUrls = [
        '', // Direct request first
        'https://api.allorigins.win/get?url=',
        'https://corsproxy.io/?',
        'https://thingproxy.freeboard.io/fetch/'
      ];
    }
  
    // Get CKAN session cookie
    getCKANAuthCookie() {
      // Get auth_tkt cookie which CKAN uses for authentication
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'auth_tkt' || name === 'ckan') {
          return value;
        }
      }
      return null;
    }
  
    // Get CKAN API Key from user profile (if available in page)
    getCKANAPIKey() {
      // Try to get API key from meta tags or data attributes
      const apiKeyMeta = document.querySelector('meta[name="ckan-api-key"]');
      if (apiKeyMeta) return apiKeyMeta.content;
      
      // Try to get from user data if exposed
      const userDataEl = document.querySelector('[data-user-api-key]');
      if (userDataEl) return userDataEl.dataset.userApiKey;
      
      return null;
    }
  
    // Get CSRF token for CKAN
    getCSRFToken() {
      // CKAN typically uses a CSRF token in forms
      const csrfInput = document.querySelector('input[name="csrf_token"], meta[name="csrf-token"]');
      if (csrfInput) {
        return csrfInput.value || csrfInput.content;
      }
      return null;
    }
  
    async makeRequest(url, method = 'GET', customHeaders = {}, body = null) {
      const loadingContainer = document.getElementById('api-loading');
      const responseContainer = document.getElementById('api-response');
      const errorContainer = document.getElementById('api-error');
  
      // Show loading
      loadingContainer.style.display = 'block';
      responseContainer.style.display = 'none';
      errorContainer.style.display = 'none';
  
      // Build authentication headers
      const authHeaders = {};
      
      // Add CKAN session cookie
      const authCookie = this.getCKANAuthCookie();
      if (authCookie) {
        authHeaders['Cookie'] = `auth_tkt=${authCookie}`;
      }
      
      // Add API key if available
      const apiKey = this.getCKANAPIKey();
      if (apiKey) {
        authHeaders['Authorization'] = apiKey;
        authHeaders['X-CKAN-API-Key'] = apiKey;
      }
      
      // Add CSRF token
      const csrfToken = this.getCSRFToken();
      if (csrfToken) {
        authHeaders['X-CSRF-Token'] = csrfToken;
      }
  
      // Check if this is a CKAN API endpoint
      const isCKANAPI = url.includes('/api/') || url.includes('/action/');
      
      // Merge headers
      const headers = {
        'Accept': 'application/json, text/plain, */*',
        'Content-Type': 'application/json',
        ...authHeaders,
        ...customHeaders
      };
  
      // If it's a CKAN API, try direct request with credentials
      if (isCKANAPI) {
        try {
          const requestOptions = {
            method: method,
            headers: headers,
            mode: 'cors',
            credentials: 'include', // Include cookies
            cache: 'no-cache'
          };
  
          if (body && ['POST', 'PUT', 'PATCH'].includes(method)) {
            requestOptions.body = typeof body === 'string' ? body : JSON.stringify(body);
          }
  
          console.log('Attempting authenticated CKAN API request...');
          
          const response = await fetch(url, requestOptions);
          
          if (response.ok) {
            const data = await response.json();
            loadingContainer.style.display = 'none';
            this.displayResponse(data, this.getResponseHeaders(response), response.status, 'authenticated');
            return;
          }
        } catch (error) {
          console.log('Authenticated request failed:', error.message);
        }
      }
  
      // Fallback to proxy requests for non-CKAN or failed requests
      for (let i = 0; i < this.corsProxyUrls.length; i++) {
        try {
          const proxyUrl = this.corsProxyUrls[i];
          let requestUrl;
          let requestOptions;
          
          if (proxyUrl === '') {
            // Direct request
            requestUrl = url;
            requestOptions = {
              method: method,
              headers: headers,
              mode: 'cors',
              credentials: 'omit'
            };
          } else if (proxyUrl.includes('allorigins.win')) {
            // AllOrigins format
            requestUrl = `${proxyUrl}${encodeURIComponent(url)}`;
            requestOptions = {
              method: 'GET',
              headers: {
                'Accept': 'application/json'
              }
            };
          } else {
            // Other proxies
            requestUrl = proxyUrl + encodeURIComponent(url);
            requestOptions = {
              method: 'GET',
              headers: {
                'Accept': 'application/json, text/plain, */*'
              }
            };
          }
  
          if (proxyUrl === '' && body && ['POST', 'PUT', 'PATCH'].includes(method)) {
            requestOptions.body = typeof body === 'string' ? body : JSON.stringify(body);
          }
  
          console.log(`Attempting request ${i + 1}/${this.corsProxyUrls.length}: ${requestUrl}`);
  
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);
  
          requestOptions.signal = controller.signal;
  
          const response = await fetch(requestUrl, requestOptions);
          clearTimeout(timeoutId);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
  
          let data;
          let responseHeaders = {};
          
          if (proxyUrl.includes('allorigins.win')) {
            const result = await response.json();
            try {
              data = JSON.parse(result.contents);
            } catch {
              data = result.contents;
            }
            responseHeaders = result.headers || {};
          } else {
            const contentType = response.headers.get('content-type') || '';
            
            if (contentType.includes('application/json')) {
              data = await response.json();
            } else {
              const text = await response.text();
              try {
                data = JSON.parse(text);
              } catch {
                data = text;
              }
            }
            
            responseHeaders = this.getResponseHeaders(response);
          }
  
          loadingContainer.style.display = 'none';
          
          const proxyMethod = proxyUrl === '' ? 'direct' : `proxy (${proxyUrl.split('/')[2]})`;
          this.displayResponse(data, responseHeaders, response.status, proxyMethod);
          return;
  
        } catch (error) {
          console.log(`Request ${i + 1} failed:`, error.message);
          
          if (i === this.corsProxyUrls.length - 1) {
            loadingContainer.style.display = 'none';
            this.displayError(`All ${this.corsProxyUrls.length} request methods failed.\n\nLast error: ${error.message}\n\nThis API might:\n- Not support CORS\n- Require authentication\n- Be temporarily unavailable`, null);
          }
        }
      }
    }
  
    getResponseHeaders(response) {
      const headers = {};
      response.headers.forEach((value, key) => {
        headers[key] = value;
      });
      return headers;
    }
  
    displayResponse(data, headers, status, method = 'direct') {
      const responseContainer = document.getElementById('api-response');
      const statusElement = document.getElementById('response-status');
      const headersElement = document.getElementById('response-headers');
      const bodyElement = document.getElementById('response-body');
      const methodElement = document.getElementById('response-method');
  
      // Update status with authentication info
      let statusText = `Status: ${status}`;
      if (method === 'authenticated') {
        statusText += ' (authenticated request)';
      } else {
        statusText += ` (${method})`;
      }
      
      statusElement.textContent = statusText;
      statusElement.className = status >= 200 && status < 300 ? 'alert alert-success' : 'alert alert-danger';
  
      // Show method info
      if (methodElement) {
        methodElement.textContent = method;
        methodElement.className = method === 'authenticated' ? 'label label-primary' : 
                                 method === 'direct' ? 'label label-success' : 'label label-info';
      }
  
      // Display headers
      if (headers && Object.keys(headers).length > 0) {
        headersElement.innerHTML = Object.entries(headers)
          .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
          .join('<br>');
        headersElement.style.display = 'block';
      } else {
        headersElement.style.display = 'none';
      }
  
      // Display response body
      if (typeof data === 'object') {
        bodyElement.innerHTML = this.formatJSON(data);
      } else {
        bodyElement.innerHTML = `<pre>${this.escapeHtml(data)}</pre>`;
      }
  
      responseContainer.style.display = 'block';
    }
  
    displayError(error, status) {
      const errorContainer = document.getElementById('api-error');
      const errorMessage = document.getElementById('error-message');
      
      errorMessage.innerHTML = `
        <strong>Request Failed</strong><br>
        ${status ? `Status: ${status}<br>` : ''}
        Error: ${this.escapeHtml(error)}
        <br><br>
        <strong>Troubleshooting:</strong><br>
        - Make sure you are logged in to CKAN<br>
        - Check if the API requires specific authentication<br>
        - Verify the API endpoint is correct<br>
        - Some APIs may not support browser requests due to CORS
      `;
      
      errorContainer.style.display = 'block';
    }
  
    formatJSON(obj) {
      let json;
      try {
        json = JSON.stringify(obj, null, 2);
      } catch (e) {
        json = String(obj);
      }
      
      return '<pre>' + json
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/(".*?")\s*:/g, '<span class="json-key">$1</span>:')
        .replace(/:\s*(".*?")/g, ': <span class="json-string">$1</span>')
        .replace(/:\s*(\b\d+\.?\d*\b)/g, ': <span class="json-number">$1</span>')
        .replace(/:\s*(\btrue\b|\bfalse\b)/g, ': <span class="json-boolean">$1</span>')
        .replace(/:\s*(\bnull\b)/g, ': <span class="json-null">$1</span>') + '</pre>';
    }
  
    escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  }
  
  // Initialize API handler
  let apiHandler;
  
  document.addEventListener('DOMContentLoaded', function() {
    apiHandler = new APIRequestHandler();
    
    // Check if user is logged in
    const authCookie = apiHandler.getCKANAuthCookie();
    if (authCookie) {
      console.log('CKAN authentication detected');
    }
    
    // Auto-test API if resource is API type
    const resourceType = '{{ res.resource_type }}';
    const resourceFormat = '{{ res.format }}';
    const resourceUrl = '{{ res.url }}';
    
    if (resourceType === 'api' || resourceFormat?.toLowerCase() === 'api' || 
        resourceUrl?.includes('/api/') || resourceUrl?.includes('api.')) {
      // Add authentication indicator
      const authIndicator = document.createElement('div');
      authIndicator.className = 'alert alert-info';
      authIndicator.style.marginBottom = '1rem';
      authIndicator.innerHTML = authCookie ? 
        '<i class="fa fa-lock"></i> Using your CKAN session for authentication' :
        '<i class="fa fa-unlock"></i> Not authenticated - API requests may fail';
      
      const apiContainer = document.querySelector('.api-response-container');
      if (apiContainer) {
        apiContainer.insertBefore(authIndicator, apiContainer.firstChild);
      }
      
      testAPI();
    }
  });
  
  function testAPI() {
    const resourceUrl = '{{ res.url }}';
    if (resourceUrl) {
      const method = document.getElementById('method-selector')?.value || 'GET';
      const headersText = document.getElementById('headers-input')?.value || '{}';
      
      try {
        const headers = JSON.parse(headersText);
        apiHandler.makeRequest(resourceUrl, method, headers);
      } catch (e) {
        apiHandler.displayError('Invalid JSON in headers field: ' + e.message, null);
      }
    } else {
      apiHandler.displayError('No URL found for this resource', null);
    }
  }
  </script>