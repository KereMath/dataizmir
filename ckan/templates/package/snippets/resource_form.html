{% import 'macros/form.html' as form %}

{% set data = data or {} %}
{% set errors = errors or {} %}
{% set action = form_action or h.url_for(dataset_type ~ '_resource.new', id=pkg_name) %}

<style>
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  --glass-bg: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.2);
  --input-bg: rgba(255, 255, 255, 0.9);
  --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.1);
  --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.modern-form-container {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 2rem 0;
}

.form-card {
  background: var(--glass-bg);
  backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border);
  border-radius: 25px;
  padding: 3rem;
  box-shadow: var(--shadow-light);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.form-card:hover {
  box-shadow: var(--shadow-heavy);
  transform: translateY(-5px);
}

.form-header {
  text-align: center;
  margin-bottom: 3rem;
}

.form-title {
  font-size: 2.5rem;
  font-weight: 700;
  color: white;
  text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
  margin-bottom: 0.5rem;
}

.form-subtitle {
  color: rgba(255, 255, 255, 0.8);
  font-size: 1.1rem;
}

.modern-form-group {
  margin-bottom: 2rem;
  position: relative;
}

.modern-label {
  display: block;
  color: white;
  font-weight: 600;
  margin-bottom: 0.5rem;
  font-size: 1rem;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.modern-input {
  width: 100%;
  padding: 1rem 1.5rem;
  border: 2px solid transparent;
  border-radius: 15px;
  background: var(--input-bg);
  font-size: 1rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.modern-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
  transform: translateY(-2px);
}

.modern-textarea {
  min-height: 120px;
  resize: vertical;
}

.modern-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 1rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 3rem;
}

.file-upload-area {
  border: 2px dashed rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  padding: 3rem 2rem;
  text-align: center;
  background: rgba(255, 255, 255, 0.05);
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.file-upload-area:hover {
  border-color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
}

.file-upload-area.dragover {
  border-color: #667eea;
  background: rgba(102, 126, 234, 0.1);
  transform: scale(1.02);
}

.upload-icon {
  font-size: 3rem;
  color: rgba(255, 255, 255, 0.6);
  margin-bottom: 1rem;
}

.upload-text {
  color: white;
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
}

.upload-subtext {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.9rem;
}

.file-input {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
}

.url-input-group {
  display: flex;
  gap: 1rem;
  align-items: end;
}

.url-input-group .modern-input {
  flex: 1;
}

.url-check-btn {
  background: var(--success-gradient);
  border: none;
  border-radius: 12px;
  padding: 1rem 1.5rem;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
}

.url-check-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
}

.format-suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.format-tag {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  padding: 0.3rem 0.8rem;
  border-radius: 15px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.format-tag:hover {
  background: var(--primary-gradient);
  transform: translateY(-1px);
}

.error-message {
  background: var(--danger-gradient);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 15px;
  margin-bottom: 2rem;
  border-left: 4px solid #fa709a;
  box-shadow: 0 4px 15px rgba(250, 112, 154, 0.3);
}

.info-block {
  background: rgba(79, 172, 254, 0.2);
  border: 1px solid rgba(79, 172, 254, 0.3);
  border-radius: 10px;
  padding: 0.8rem 1rem;
  margin-top: 0.5rem;
  color: rgba(255, 255, 255, 0.9);
  font-size: 0.9rem;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: space-between;
  align-items: center;
  margin-top: 3rem;
  flex-wrap: wrap;
}

.btn-modern {
  padding: 1rem 2rem;
  border: none;
  border-radius: 25px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1rem;
  position: relative;
  overflow: hidden;
}

.btn-modern::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.btn-modern:hover::before {
  left: 100%;
}

.btn-primary {
  background: var(--primary-gradient);
  color: white;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
  color: white;
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: translateY(-2px);
  color: white;
}

.btn-danger {
  background: var(--danger-gradient);
  color: white;
  box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
}

.btn-danger:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 25px rgba(250, 112, 154, 0.6);
  color: white;
}

.progress-steps {
  display: flex;
  justify-content: center;
  margin-bottom: 3rem;
}

.step {
  display: flex;
  align-items: center;
  color: rgba(255, 255, 255, 0.6);
  font-weight: 600;
}

.step.active {
  color: white;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 1rem;
  font-weight: 700;
}

.step.active .step-number {
  background: var(--primary-gradient);
  box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
}

.step-connector {
  width: 60px;
  height: 2px;
  background: rgba(255, 255, 255, 0.2);
  margin: 0 1rem;
}

.step.active + .step .step-connector {
  background: var(--primary-gradient);
}

/* Responsive Design */
@media (max-width: 768px) {
  .form-card {
    padding: 2rem 1.5rem;
    margin: 1rem;
  }
  
  .form-title {
    font-size: 2rem;
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .btn-modern {
    width: 100%;
    justify-content: center;
  }
  
  .url-input-group {
    flex-direction: column;
  }
  
  .progress-steps {
    flex-direction: column;
    align-items: center;
  }
  
  .step-connector {
    width: 2px;
    height: 30px;
    margin: 0.5rem 0;
  }
}

/* Animations */
@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.form-card {
  animation: slideInUp 0.6s ease-out;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

.upload-icon {
  animation: pulse 2s infinite;
}
</style>

<div class="modern-form-container">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="form-card">
          <div class="form-header">
            <h1 class="form-title">
              <i class="fa fa-cloud-upload"></i>
              {{ _('Add Resource') if not data.id else _('Edit Resource') }}
            </h1>
            <p class="form-subtitle">
              {{ _('Upload data files or link to external resources') }}
            </p>
          </div>

          {% if stage %}
            <div class="progress-steps">
              <div class="step {{ 'active' if stage[0] == 1 }}">
                <div class="step-number">1</div>
                <span>{{ _('Resource') }}</span>
              </div>
              <div class="step-connector"></div>
              <div class="step {{ 'active' if stage[0] == 2 }}">
                <div class="step-number">2</div>
                <span>{{ _('Metadata') }}</span>
              </div>
              <div class="step-connector"></div>
              <div class="step {{ 'active' if stage[0] == 3 }}">
                <div class="step-number">3</div>
                <span>{{ _('Complete') }}</span>
              </div>
            </div>
          {% endif %}

          <form id="resource-edit" method="post" action="{{ action }}" enctype="multipart/form-data">
            {% if error_summary %}
              <div class="error-message">
                <strong><i class="fa fa-exclamation-triangle"></i> {{ _('Please fix the following errors:') }}</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                  {% for error in error_summary %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}

            <input name="id" value="{{ data.id }}" type="hidden"/>

            <!-- URL/Upload Section -->
            <div class="modern-form-group">
              <label class="modern-label">
                <i class="fa fa-link"></i> {{ _('Data Source') }}
              </label>
              
              {% set is_upload = (data.url_type == 'upload') %}
              
              <div class="upload-method-tabs" style="margin-bottom: 1rem;">
                <button type="button" class="method-tab {{ 'active' if not is_upload }}" data-method="url">
                  <i class="fa fa-link"></i> {{ _('URL') }}
                </button>
                <button type="button" class="method-tab {{ 'active' if is_upload }}" data-method="upload">
                  <i class="fa fa-upload"></i> {{ _('Upload File') }}
                </button>
              </div>

              <div class="upload-section {{ 'hidden' if not is_upload }}" id="upload-section">
                <div class="file-upload-area" id="file-upload-area">
                  <div class="upload-icon">
                    <i class="fa fa-cloud-upload"></i>
                  </div>
                  <div class="upload-text">{{ _('Drag and drop your file here') }}</div>
                  <div class="upload-subtext">{{ _('or click to browse files') }}</div>
                  <input type="file" name="upload" class="file-input" id="file-input">
                </div>
              </div>

              <div class="url-section {{ 'hidden' if is_upload }}" id="url-section">
                <div class="url-input-group">
                  <input type="url" 
                         name="url" 
                         class="modern-input" 
                         placeholder="{{ _('https://example.com/data.csv') }}" 
                         value="{{ data.url if data.url and not is_upload }}"
                         id="url-input">
                  <button type="button" class="url-check-btn" id="url-check">
                    <i class="fa fa-check"></i> {{ _('Validate') }}
                  </button>
                </div>
              </div>
            </div>

            <!-- Name Field -->
            <div class="modern-form-group">
              <label for="field-name" class="modern-label">
                <i class="fa fa-tag"></i> {{ _('Name') }}
              </label>
              <input type="text" 
                     id="field-name" 
                     name="name" 
                     class="modern-input" 
                     placeholder="{{ _('e.g. January 2024 Sales Data') }}" 
                     value="{{ data.name }}"
                     required>
            </div>

            <!-- Description Field -->
            <div class="modern-form-group">
              <label for="field-description" class="modern-label">
                <i class="fa fa-file-text"></i> {{ _('Description') }}
              </label>
              <textarea id="field-description" 
                       name="description" 
                       class="modern-input modern-textarea" 
                       placeholder="{{ _('Describe what this resource contains...') }}">{{ data.description }}</textarea>
            </div>

            <!-- Format Field -->
            <div class="modern-form-group">
              <label for="field-format" class="modern-label">
                <i class="fa fa-file-code-o"></i> {{ _('Format') }}
              </label>
              <input type="text" 
                     id="field-format" 
                     name="format" 
                     class="modern-input" 
                     placeholder="{{ _('e.g. CSV, JSON, XML') }}" 
                     value="{{ data.format }}"
                     autocomplete="off">
              
              <div class="format-suggestions">
                <span class="format-tag" data-format="CSV">CSV</span>
                <span class="format-tag" data-format="JSON">JSON</span>
                <span class="format-tag" data-format="XML">XML</span>
                <span class="format-tag" data-format="PDF">PDF</span>
                <span class="format-tag" data-format="XLS">XLS</span>
                <span class="format-tag" data-format="XLSX">XLSX</span>
              </div>
              
              <div class="info-block">
                <i class="fa fa-info-circle"></i>
                {{ _('Format will be automatically detected if left blank') }}
              </div>
            </div>

            {% if include_metadata %}
              <!-- Metadata Fields -->
              <div class="modern-form-group">
                <label for="field-last-modified" class="modern-label">
                  <i class="fa fa-calendar"></i> {{ _('Last Modified') }}
                </label>
                <input type="date" 
                       id="field-last-modified" 
                       name="last_modified" 
                       class="modern-input" 
                       value="{{ data.last_modified }}">
              </div>

              <div class="modern-form-group">
                <label for="field-size" class="modern-label">
                  <i class="fa fa-hdd-o"></i> {{ _('File Size') }}
                </label>
                <input type="text" 
                       id="field-size" 
                       name="size" 
                       class="modern-input" 
                       placeholder="{{ _('e.g. 1.5 MB') }}" 
                       value="{{ data.size }}">
              </div>

              <div class="modern-form-group">
                <label for="field-mimetype" class="modern-label">
                  <i class="fa fa-file-o"></i> {{ _('MIME Type') }}
                </label>
                <input type="text" 
                       id="field-mimetype" 
                       name="mimetype" 
                       class="modern-input" 
                       placeholder="{{ _('e.g. text/csv') }}" 
                       value="{{ data.mimetype }}">
              </div>
            {% endif %}

            <!-- Form Actions -->
            <div class="form-actions">
              <div class="left-actions">
                {% if data.id and h.check_access('resource_delete', {'id': data.id}) %}
                  <a href="{{ h.url_for(dataset_type ~ '_resource.delete', resource_id=data.id, id=pkg_name) }}" 
                     class="btn-modern btn-danger" 
                     onclick="return confirm('{{ _('Are you sure you want to delete this resource?') }}')">
                    <i class="fa fa-trash"></i> {{ _('Delete') }}
                  </a>
                {% endif %}
              </div>
              
              <div class="right-actions" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                {% if stage %}
                  <button class="btn-modern btn-secondary" name="save" value="go-dataset" type="submit">
                    <i class="fa fa-arrow-left"></i> {{ _('Previous') }}
                  </button>
                {% endif %}
                
                <button class="btn-modern btn-secondary" name="save" value="again" type="submit">
                  <i class="fa fa-plus"></i> {{ _('Save & Add Another') }}
                </button>
                
                {% if stage %}
                  <button class="btn-modern btn-primary" name="save" value="go-metadata" type="submit">
                    <i class="fa fa-check"></i> {{ _('Next') }}
                  </button>
                {% else %}
                  <button class="btn-modern btn-primary" name="save" value="go-dataset-complete" type="submit">
                    <i class="fa fa-save"></i> {{ _('Save Resource') }}
                  </button>
                {% endif %}
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Upload method toggle
  const methodTabs = document.querySelectorAll('.method-tab');
  const uploadSection = document.getElementById('upload-section');
  const urlSection = document.getElementById('url-section');
  
  methodTabs.forEach(tab => {
    tab.addEventListener('click', function() {
      methodTabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      if (this.dataset.method === 'upload') {
        uploadSection.classList.remove('hidden');
        urlSection.classList.add('hidden');
      } else {
        uploadSection.classList.add('hidden');
        urlSection.classList.remove('hidden');
      }
    });
  });

  // File upload drag and drop
  const fileUploadArea = document.getElementById('file-upload-area');
  const fileInput = document.getElementById('file-input');

  if (fileUploadArea && fileInput) {
    fileUploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        fileInput.files = files;
        updateFileName(files[0].name);
      }
    });

    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        updateFileName(this.files[0].name);
      }
    });
  }

  function updateFileName(fileName) {
    const uploadText = document.querySelector('.upload-text');
    const uploadIcon = document.querySelector('.upload-icon i');
    
    if (uploadText && uploadIcon) {
      uploadText.textContent = fileName;
      uploadIcon.className = 'fa fa-file-o';
    }
  }

  // Format suggestions
  const formatTags = document.querySelectorAll('.format-tag');
  const formatInput = document.getElementById('field-format');

  formatTags.forEach(tag => {
    tag.addEventListener('click', function() {
      if (formatInput) {
        formatInput.value = this.dataset.format;
        
        // Visual feedback
        formatTags.forEach(t => t.style.background = 'rgba(255, 255, 255, 0.2)');
        this.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      }
    });
  });

  // URL validation
  const urlCheck = document.getElementById('url-check');
  const urlInput = document.getElementById('url-input');

  if (urlCheck && urlInput) {
    urlCheck.addEventListener('click', function() {
      const url = urlInput.value;
      if (url) {
        // Simple URL validation
        try {
          new URL(url);
          this.innerHTML = '<i class="fa fa-check"></i> Valid';
          this.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
          
          setTimeout(() => {
            this.innerHTML = '<i class="fa fa-check"></i> Validate';
            this.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
          }, 2000);
        } catch {
          this.innerHTML = '<i class="fa fa-times"></i> Invalid';
          this.style.background = 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';
          
          setTimeout(() => {
            this.innerHTML = '<i class="fa fa-check"></i> Validate';
            this.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
          }, 2000);
        }
      }
    });
  }

  // Auto-detect format from file extension
  if (fileInput) {
    fileInput.addEventListener('change', function() {
      if (this.files.length > 0 && formatInput) {
        const fileName = this.files[0].name;
        const extension = fileName.split('.').pop().toUpperCase();
        
        if (['CSV', 'JSON', 'XML', 'PDF', 'XLS', 'XLSX', 'TXT', 'DOC', 'DOCX'].includes(extension)) {
          formatInput.value = extension;
        }
      }
    });
  }
});
</script>

<style>
.method-tab {
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.8);
  padding: 0.8rem 1.5rem;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-right: 1rem;
  font-weight: 600;
}

.method-tab.active {
  background: var(--primary-gradient);
  border-color: transparent;
  color: white;
  box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
}

.method-tab:hover {
  transform: translateY(-2px);
}

.hidden {
  display: none !important;
}

.upload-method-tabs {
  display: flex;
  margin-bottom: 1rem;
}

@media (max-width: 768px) {
  .upload-method-tabs {
    flex-direction: column;
  }
  
  .method-tab {
    margin-right: 0;
    margin-bottom: 0.5rem;
  }
}
</style>