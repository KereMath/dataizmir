<style>
  /* Modern Data Preview Styles */
  .module-content.ckanext-datapreview {
    background: white !important;
    border-radius: 16px !important;
    overflow: hidden !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05) !important;
    border: 1px solid rgba(226, 232, 240, 0.8) !important;
  }
  
  /* PDF and X-Frame-Options Error Handler */
  .pdf-viewer-container, .x-frame-error-container {
    background: white !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05) !important;
    border: 1px solid rgba(226, 232, 240, 0.8) !important;
    margin: 1rem 0 !important;
  }
  
  .pdf-viewer-header, .x-frame-error-header {
    background: linear-gradient(135deg, #f8fafc, #e2e8f0) !important;
    padding: 1rem 1.5rem !important;
    border-bottom: 1px solid rgba(226, 232, 240, 0.8) !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
  }
  
  .pdf-viewer-title, .x-frame-error-title {
    font-size: 1rem !important;
    font-weight: 600 !important;
    color: #374151 !important;
    margin: 0 !important;
    display: flex !important;
    align-items: center !important;
  }
  
  .pdf-viewer-title i {
    margin-right: 0.75rem !important;
    color: #dc2626 !important;
  }
  
  .x-frame-error-title i {
    margin-right: 0.75rem !important;
    color: #f59e0b !important;
  }
  
  .viewer-actions {
    display: flex !important;
    gap: 0.75rem !important;
  }
  
  .viewer-actions .btn {
    background: white !important;
    border: 2px solid #e2e8f0 !important;
    color: #374151 !important;
    padding: 0.5rem 1rem !important;
    border-radius: 8px !important;
    font-weight: 600 !important;
    font-size: 0.875rem !important;
    transition: all 0.3s ease !important;
    text-decoration: none !important;
  }
  
  .viewer-actions .btn:hover {
    background: #f8fafc !important;
    border-color: #667eea !important;
    color: #667eea !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
  }
  
  .viewer-actions .btn-primary {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    border: none !important;
    color: white !important;
  }
  
  .viewer-actions .btn-primary:hover {
    background: linear-gradient(135deg, #5a67d8, #6b46c1) !important;
    color: white !important;
  }
  
  .viewer-embed-container {
    padding: 1.5rem !important;
    background: #f8fafc !important;
    text-align: center !important;
  }
  
  .viewer-embed-message {
    background: rgba(239, 68, 68, 0.1) !important;
    border: 2px dashed #ef4444 !important;
    border-radius: 12px !important;
    padding: 2rem !important;
    color: #dc2626 !important;
    font-weight: 500 !important;
    margin-bottom: 1.5rem !important;
  }
  
  .x-frame-embed-message {
    background: rgba(245, 158, 11, 0.1) !important;
    border: 2px dashed #f59e0b !important;
    border-radius: 12px !important;
    padding: 2rem !important;
    color: #d97706 !important;
    font-weight: 500 !important;
    margin-bottom: 1.5rem !important;
  }
  
  .viewer-embed-message i, .x-frame-embed-message i {
    font-size: 2rem !important;
    margin-bottom: 1rem !important;
    display: block !important;
  }
  
  .viewer-fallback-actions {
    display: flex !important;
    gap: 1rem !important;
    justify-content: center !important;
    flex-wrap: wrap !important;
  }
  
  .viewer-fallback-actions .btn {
    padding: 1rem 2rem !important;
    font-weight: 600 !important;
    border-radius: 10px !important;
    transition: all 0.3s ease !important;
    text-decoration: none !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 0.75rem !important;
  }
  
  .viewer-fallback-actions .btn-primary {
    background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
    color: white !important;
    border: none !important;
  }
  
  .viewer-fallback-actions .btn-primary:hover {
    background: linear-gradient(135deg, #b91c1c, #991b1b) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3) !important;
    color: white !important;
  }
  
  .viewer-fallback-actions .btn-secondary {
    background: white !important;
    color: #374151 !important;
    border: 2px solid #e2e8f0 !important;
  }
  
  .viewer-fallback-actions .btn-secondary:hover {
    background: #f8fafc !important;
    border-color: #667eea !important;
    color: #667eea !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
  }
  
  .viewer-fallback-actions .btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706) !important;
    color: white !important;
    border: none !important;
  }
  
  .viewer-fallback-actions .btn-warning:hover {
    background: linear-gradient(135deg, #d97706, #b45309) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3) !important;
    color: white !important;
  }
  
  /* Enhanced iframe with error detection */
  iframe[data-module="data-viewer"] {
    border-radius: 12px !important;
    border: 1px solid rgba(226, 232, 240, 0.8) !important;
    background: white !important;
    min-height: 500px !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05) !important;
    transition: all 0.3s ease !important;
  }
  
  iframe[data-module="data-viewer"].error {
    border-color: #ef4444 !important;
    background: #fef2f2 !important;
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .viewer-fallback-actions {
      flex-direction: column !important;
      align-items: center !important;
    }
    
    .viewer-fallback-actions .btn {
      width: 100% !important;
      max-width: 300px !important;
    }
  }
  </style>
  
  <div class="module-content ckanext-datapreview">
    {% if embed %}
      {# images can be embedded directly #}
      <img src="{{ resource_url }}"></img>
    {% else %}
      <!-- Smart Resource Detection -->
      {% set resource_url_lower = resource_url.lower() if resource_url else '' %}
      {% set raw_resource_url_lower = raw_resource_url.lower() if raw_resource_url else '' %}
      
      <!-- PDF Detection: Check both URLs and common PDF patterns -->
      {% set is_pdf_resource = (
        '.pdf' in resource_url_lower or 
        '.pdf' in raw_resource_url_lower or
        'application/pdf' in resource_url_lower or
        'pdf' in resource_url_lower or
        'openfiles.izmir.bel.tr' in resource_url_lower or
        'docs/' in resource_url_lower
      ) %}
      
      <!-- X-Frame-Options problematic domains -->
      {% set is_x_frame_blocked = (
        'openfiles.izmir.bel.tr' in resource_url_lower or
        'izmir.bel.tr' in resource_url_lower or
        '.gov.tr' in resource_url_lower
      ) %}
      
      {% if is_pdf_resource %}
        <!-- PDF Specific Handler -->
        <div class="pdf-viewer-container">
          <div class="pdf-viewer-header">
            <h4 class="pdf-viewer-title">
              <i class="fa fa-file-pdf-o"></i>
              PDF Dökümanı
            </h4>
            <div class="viewer-actions">
              <a href="{{ raw_resource_url }}" class="btn btn-secondary" target="_blank">
                <i class="fa fa-external-link"></i>
                Yeni Sekmede Aç
              </a>
              <a href="{{ raw_resource_url }}" class="btn btn-primary" download>
                <i class="fa fa-download"></i>
                İndir
              </a>
            </div>
          </div>
          
          <div class="viewer-embed-container">
            <div class="viewer-embed-message">
              <i class="fa fa-file-pdf-o"></i>
              <strong>PDF Dosyası Tespit Edildi</strong><br>
              Bu PDF dosyası güvenlik nedeniyle doğrudan görüntülenemiyor.
              <br><small>Yeni sekmede açabilir veya indirebilirsiniz.</small>
            </div>
            
            <div class="viewer-fallback-actions">
              <a href="{{ raw_resource_url }}" class="btn btn-primary" target="_blank">
                <i class="fa fa-external-link"></i>
                PDF'i Yeni Sekmede Görüntüle
              </a>
              <a href="{{ raw_resource_url }}" class="btn btn-secondary" download>
                <i class="fa fa-download"></i>
                PDF'i Bilgisayara İndir
              </a>
            </div>
          </div>
        </div>
        
      {% elif is_x_frame_blocked %}
        <!-- X-Frame-Options Blocked Handler -->
        <div class="x-frame-error-container">
          <div class="x-frame-error-header">
            <h4 class="x-frame-error-title">
              <i class="fa fa-shield"></i>
              Güvenlik Kısıtlaması
            </h4>
            <div class="viewer-actions">
              <a href="{{ raw_resource_url }}" class="btn btn-secondary" target="_blank">
                <i class="fa fa-external-link"></i>
                Yeni Sekmede Aç
              </a>
              <a href="{{ raw_resource_url }}" class="btn btn-primary" download>
                <i class="fa fa-download"></i>
                İndir
              </a>
            </div>
          </div>
          
          <div class="viewer-embed-container">
            <div class="x-frame-embed-message">
              <i class="fa fa-shield"></i>
              <strong>X-Frame-Options Kısıtlaması</strong><br>
              Bu kaynak sunucu güvenlik ayarları nedeniyle iframe içinde görüntülenemiyor.
              <br><small>Kaynağı yeni sekmede açmanız gerekiyor.</small>
            </div>
            
            <div class="viewer-fallback-actions">
              <a href="{{ raw_resource_url }}" class="btn btn-warning" target="_blank">
                <i class="fa fa-external-link"></i>
                Kaynağı Yeni Sekmede Aç
              </a>
              <a href="{{ raw_resource_url }}" class="btn btn-secondary" download>
                <i class="fa fa-download"></i>
                Kaynağı İndir
              </a>
            </div>
          </div>
        </div>
        
      {% else %}
        <!-- Standard Error Handler with Enhanced Detection -->
        <div class="data-viewer-error js-hide">
          <p class="text-danger">
            <i class="fa fa-info-circle"></i>
            {{ _('This resource can not be previewed at the moment.') }}
            <a href="#" data-toggle="collapse" data-target="#data-view-error">
              {{ _('Click here for more information.') }}
            </a>
          </p>
          <p id="data-view-error" class="collapse"></p>
          <p>
            <a href="{{ raw_resource_url }}" class="btn btn-default btn-lg resource-url-analytics" target="_blank">
              <i class="fa fa-lg fa-arrow-circle-o-down"></i>
              {{ _('Download resource') }}
            </a>
          </p>
        </div>
        
        <!-- Enhanced iframe with error detection -->
        <iframe src="{{ resource_url }}" 
                frameborder="0" 
                width="100%" 
                data-module="data-viewer" 
                class="visible-md"
                onload="handleIframeLoad(this)"
                onerror="handleIframeError(this, '{{ raw_resource_url }}')">
          <p>{{ _('Your browser does not support iframes.') }}</p>
        </iframe>
      {% endif %}
    {% endif %}
  </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Enhanced iframe error detection
    const iframe = document.querySelector('iframe[data-module="data-viewer"]');
    if (iframe) {
      
      // Set a timeout to detect if iframe failed to load
      const timeoutId = setTimeout(function() {
        // If iframe is still loading after 8 seconds, assume it failed
        if (iframe.style.display !== 'none') {
          console.warn('Iframe loading timeout - showing fallback');
          handleIframeError(iframe, iframe.getAttribute('data-fallback-url') || '{{ raw_resource_url }}');
        }
      }, 8000);
      
      // Clear timeout if iframe loads successfully
      iframe.addEventListener('load', function() {
        clearTimeout(timeoutId);
        
        // Additional check: try to access iframe content to detect X-Frame-Options
        try {
          // This will throw an error if X-Frame-Options blocks access
          const iframeDoc = this.contentDocument || this.contentWindow.document;
          if (!iframeDoc || iframeDoc.body.innerHTML.trim() === '') {
            throw new Error('Empty or blocked content');
          }
          console.log('Iframe loaded successfully');
        } catch (error) {
          console.warn('Iframe blocked by X-Frame-Options:', error);
          handleIframeError(this, '{{ raw_resource_url }}');
        }
      });
      
      // Handle explicit iframe errors
      iframe.addEventListener('error', function() {
        clearTimeout(timeoutId);
        handleIframeError(this, '{{ raw_resource_url }}');
      });
    }
  });
  
  function handleIframeLoad(iframe) {
    console.log('Iframe load event fired');
    
    // Try to detect X-Frame-Options blocking
    setTimeout(function() {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        if (!iframeDoc) {
          throw new Error('Cannot access iframe content');
        }
      } catch (error) {
        console.warn('X-Frame-Options detected:', error);
        handleIframeError(iframe, iframe.src);
      }
    }, 1000);
  }
  
  function handleIframeError(iframe, fallbackUrl) {
    console.log('Handling iframe error for:', iframe.src);
    
    // Hide the iframe
    iframe.style.display = 'none';
    iframe.classList.add('error');
    
    // Show the error div
    const errorDiv = iframe.parentElement.querySelector('.data-viewer-error');
    if (errorDiv) {
      errorDiv.classList.remove('js-hide');
      errorDiv.style.display = 'block';
      
      // Update error details
      const errorDetails = errorDiv.querySelector('#data-view-error');
      if (errorDetails) {
        errorDetails.innerHTML = `
          <div class="alert alert-warning" style="margin-top: 1rem; border-radius: 10px;">
            <strong><i class="fa fa-exclamation-triangle"></i> Görüntülenme Sorunu</strong><br><br>
            <strong>Muhtemel Nedenler:</strong><br>
            • <strong>X-Frame-Options:</strong> Sunucu güvenlik ayarları iframe'i engelliyor<br>
            • <strong>CORS Kısıtlaması:</strong> Cross-origin erişim izni yok<br>
            • <strong>Ağ Sorunu:</strong> Bağlantı veya sunucu hatası<br>
            • <strong>İçerik Türü:</strong> Kaynak iframe'de görüntülenemez<br><br>
            
            <div class="viewer-fallback-actions" style="margin-top: 1rem;">
              <a href="${fallbackUrl}" class="btn btn-warning" target="_blank" style="margin: 0.25rem;">
                <i class="fa fa-external-link"></i> Yeni Sekmede Aç
              </a>
              <a href="${fallbackUrl}" class="btn btn-secondary" download style="margin: 0.25rem;">
                <i class="fa fa-download"></i> İndir
              </a>
            </div>
          </div>
        `;
      }
    } else {
      // Create a new error container if none exists
      const errorContainer = document.createElement('div');
      errorContainer.className = 'x-frame-error-container';
      errorContainer.innerHTML = `
        <div class="x-frame-error-header">
          <h4 class="x-frame-error-title">
            <i class="fa fa-shield"></i>
            Görüntüleme Hatası
          </h4>
          <div class="viewer-actions">
            <a href="${fallbackUrl}" class="btn btn-secondary" target="_blank">
              <i class="fa fa-external-link"></i>
              Yeni Sekmede Aç
            </a>
          </div>
        </div>
        <div class="viewer-embed-container">
          <div class="x-frame-embed-message">
            <i class="fa fa-exclamation-triangle"></i>
            <strong>Kaynak Bu Çerçevede Görüntülenemiyor</strong><br>
            Sunucu güvenlik ayarları veya içerik türü nedeniyle iframe içinde görüntülenemiyor.
          </div>
          <div class="viewer-fallback-actions">
            <a href="${fallbackUrl}" class="btn btn-warning" target="_blank">
              <i class="fa fa-external-link"></i>
              Yeni Sekmede Aç
            </a>
            <a href="${fallbackUrl}" class="btn btn-secondary" download>
              <i class="fa fa-download"></i>
              İndir
            </a>
          </div>
        </div>
      `;
      
      iframe.parentElement.insertBefore(errorContainer, iframe);
    }
  }
  </script>