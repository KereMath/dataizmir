{% import 'macros/form.html' as form %}

<style>
/* Modern Resource View Styles */
.resource-view {
  background: linear-gradient(145deg, #ffffff, #f8fafc) !important;
  border-radius: 20px !important;
  padding: 0 !important;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08) !important;
  border: 1px solid rgba(226, 232, 240, 0.8) !important;
  overflow: hidden !important;
  transition: all 0.4s ease !important;
}

.resource-view:hover {
  transform: translateY(-3px) !important;
  box-shadow: 0 25px 70px rgba(0, 0, 0, 0.12) !important;
}

/* View Header with Actions */
.view-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  padding: 1.5rem 2rem !important;
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  color: white !important;
}

.view-title {
  font-size: 1.25rem !important;
  font-weight: 700 !important;
  margin: 0 !important;
  color: white !important;
}

.view-actions {
  display: flex !important;
  gap: 0.75rem !important;
}

.view-actions .btn {
  background: rgba(255, 255, 255, 0.15) !important;
  border: 1px solid rgba(255, 255, 255, 0.3) !important;
  color: white !important;
  border-radius: 10px !important;
  padding: 0.5rem 1rem !important;
  font-weight: 600 !important;
  font-size: 0.875rem !important;
  transition: all 0.3s ease !important;
  backdrop-filter: blur(10px) !important;
}

.view-actions .btn:hover {
  background: rgba(255, 255, 255, 0.25) !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15) !important;
  color: white !important;
}

.view-actions .btn i {
  margin-right: 0.5rem !important;
}

/* Description Section */
.view-description {
  padding: 1.5rem 2rem !important;
  background: rgba(248, 250, 252, 0.5) !important;
  border-bottom: 1px solid rgba(226, 232, 240, 0.8) !important;
}

.view-description p {
  margin: 0 !important;
  color: #64748b !important;
  font-size: 0.9rem !important;
  line-height: 1.6 !important;
}

/* Content Area */
.view-content {
  padding: 2rem !important;
  background: white !important;
  min-height: 400px !important;
}

.ckanext-datapreview {
  margin: 0 !important;
  border-radius: 12px !important;
  overflow: hidden !important;
  background: white !important;
}

/* Iframe Styling */
iframe[data-module="data-viewer"] {
  border-radius: 12px !important;
  border: 1px solid rgba(226, 232, 240, 0.8) !important;
  background: white !important;
  min-height: 500px !important;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05) !important;
}

/* Error State */
.data-viewer-error {
  text-align: center !important;
  padding: 3rem 2rem !important;
  background: linear-gradient(135deg, #fef2f2, #fef7f7) !important;
  border-radius: 16px !important;
  border: 2px dashed #fca5a5 !important;
  margin: 1rem 0 !important;
}

.data-viewer-error .text-danger {
  color: #dc2626 !important;
  font-weight: 600 !important;
  margin-bottom: 1.5rem !important;
  font-size: 1.1rem !important;
}

.data-viewer-error .btn {
  background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
  color: white !important;
  border: none !important;
  padding: 1rem 2rem !important;
  font-weight: 600 !important;
  border-radius: 12px !important;
  transition: all 0.3s ease !important;
  text-decoration: none !important;
}

.data-viewer-error .btn:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 25px rgba(220, 38, 38, 0.3) !important;
  color: white !important;
}

/* Modal Modernization */
.modal-content {
  border-radius: 20px !important;
  border: none !important;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15) !important;
  overflow: hidden !important;
}

.modal-header {
  background: linear-gradient(135deg, #667eea, #764ba2) !important;
  color: white !important;
  padding: 2rem !important;
  border-bottom: none !important;
}

.modal-title {
  font-weight: 700 !important;
  font-size: 1.5rem !important;
  margin: 0 !important;
}

.modal-header .close {
  color: white !important;
  opacity: 0.8 !important;
  font-size: 2rem !important;
  font-weight: 300 !important;
  text-shadow: none !important;
  transition: opacity 0.3s ease !important;
}

.modal-header .close:hover {
  opacity: 1 !important;
}

.modal-body {
  padding: 2rem !important;
  background: linear-gradient(145deg, #ffffff, #f8fafc) !important;
}

.embed-content {
  background: rgba(102, 126, 234, 0.05) !important;
  padding: 1rem 1.5rem !important;
  border-radius: 12px !important;
  border-left: 4px solid #667eea !important;
  margin-bottom: 1.5rem !important;
  color: #475569 !important;
  font-weight: 500 !important;
}

/* Form Controls */
.control-full {
  background: rgba(255, 255, 255, 0.9) !important;
  border: 2px solid #e2e8f0 !important;
  border-radius: 10px !important;
  padding: 0.75rem 1rem !important;
  font-weight: 500 !important;
  transition: all 0.3s ease !important;
}

.control-full:focus {
  outline: none !important;
  border-color: #667eea !important;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
  background: white !important;
}

.control-label {
  font-weight: 600 !important;
  color: #374151 !important;
  margin-bottom: 0.5rem !important;
  font-size: 0.875rem !important;
  text-transform: uppercase !important;
  letter-spacing: 0.05em !important;
}

textarea.pre {
  background: #1f2937 !important;
  color: #f3f4f6 !important;
  border: 2px solid #374151 !important;
  border-radius: 10px !important;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace !important;
  font-size: 0.875rem !important;
  line-height: 1.6 !important;
  padding: 1rem !important;
}

/* Filter Section Enhancement */
.resource-view-filters {
  background: linear-gradient(135deg, #f1f5f9, #e2e8f0) !important;
  border-radius: 12px !important;
  padding: 1.5rem !important;
  margin-bottom: 1.5rem !important;
  border: 1px solid rgba(226, 232, 240, 0.8) !important;
}

/* Responsive Design */
@media (max-width: 768px) {
  .view-header {
    flex-direction: column !important;
    gap: 1rem !important;
    text-align: center !important;
  }
  
  .view-actions {
    justify-content: center !important;
    flex-wrap: wrap !important;
  }
  
  .view-content {
    padding: 1rem !important;
  }
  
  .modal-body {
    padding: 1rem !important;
  }
  
  iframe[data-module="data-viewer"] {
    min-height: 300px !important;
  }
}

/* Loading Animation */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.loading iframe {
  animation: pulse 2s infinite !important;
}

/* Fullscreen Mode Enhancement */
.btn[href*="Fullscreen"] {
  position: relative !important;
}

.btn[href*="Fullscreen"]::before {
  content: 'üîç' !important;
  margin-right: 0.5rem !important;
}
</style>

{% block resource_view %}
  <div id="view-{{ resource_view['id'] }}" class="resource-view" data-id="{{ resource_view['id'] }}" data-title="{{ resource_view['title'] }}" data-description="{{ resource_view['descripion'] }}">
    
    <!-- Modern Header with Actions -->
    <div class="view-header">
      <h3 class="view-title">{{ resource_view['title'] or _('Data Preview') }}</h3>
      <div class="view-actions">
        <a class="btn btn-glass"
           target="_blank"
           href="{{ h.url_for('resource_view', id=package['name'], resource_id=resource['id'], view_id=resource_view['id'], qualified=True) }}">
          <i class="fa fa-expand"></i>
          {{ _("Tam Ekran") }}
        </a>
        <a class="btn btn-glass"
           href="#embed-{{ resource_view['id'] }}"
           data-module="resource-view-embed"
           data-module-id="{{ resource_view['id'] }}"
           data-module-url="{{ h.url_for('resource_view', id=package['name'], resource_id=resource['id'], view_id=resource_view['id'], qualified=True) }}">
          <i class="fa fa-code"></i>
          {{ _("Embed Kodu") }}
        </a>
      </div>
    </div>

    <!-- Description Section -->
    {% if resource_view['description'] %}
    <div class="view-description">
      <p>{{ h.render_markdown(resource_view['description']) }}</p>
    </div>
    {% endif %}

    <!-- Main Content Area -->
    <div class="view-content">
      <div class="ckanext-datapreview">
        {% if not to_preview and h.resource_view_is_filterable(resource_view) %}
          <div class="resource-view-filters">
            {% snippet 'package/snippets/resource_view_filters.html', resource=resource %}
          </div>
        {% endif %}
        
        {% if not h.resource_view_is_iframed(resource_view) %}
          {{ h.rendered_resource_view(resource_view, resource, package) }}
        {% else %}
          <div class="data-viewer-error js-hide">
            <p class="text-danger">
              <i class="fa fa-exclamation-triangle fa-2x"></i><br><br>
              {{ _('Bu kaynak g√∂r√ºn√ºm√º ≈üu anda kullanƒ±lamƒ±yor.') }}
            </p>
            <a href="#" data-toggle="collapse" data-target="#data-view-error" class="btn btn-outline-secondary">
              {{ _('Daha fazla bilgi i√ßin tƒ±klayƒ±n') }}
            </a>
            <div id="data-view-error" class="collapse mt-3"></div>
            <br><br>
            <a href="{{ resource.url }}" class="btn btn-lg resource-url-analytics" target="_blank">
              <i class="fa fa-download fa-lg"></i>
              {{ _('Kaynaƒüƒ± ƒ∞ndir') }}
            </a>
          </div>
          
          {% if not to_preview %}
            {% set current_filters = request.args.get('filters') %}
            {% if current_filters %}
              {% set src = h.url_for(package['type'] ~ '_resource.view', id=package['name'],
                resource_id=resource['id'],
                view_id=resource_view['id'],
                filters=current_filters, qualified=true)  %}
            {% else %}
              {% set src = h.url_for(package['type'] ~ '_resource.view', id=package['name'],
                resource_id=resource['id'],
                view_id=resource_view['id'], qualified=true)  %}
            {% endif %}
          {% else %}
            {% set src = h.url_for(package['type'] ~ '_resource.view', id=package['name'], resource_id=resource['id'], qualified=true) + '?' + h.urlencode({'resource_view': h.dump_json(resource_view)}) %}
          {% endif %}
          
          <iframe src="{{ src }}" 
                  frameborder="0" 
                  width="100%" 
                  data-module="data-viewer"
                  class="loading">
            <p>{{ _('Tarayƒ±cƒ±nƒ±z iframe desteklemiyor.') }}</p>
          </iframe>
        {% endif %}
      </div>
    </div>

    <!-- Modern Embed Modal -->
    <div id="embed-{{ resource_view['id'] }}" class="modal fade resource-view-embed">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fa fa-code"></i>
              {{ _("Embed Kaynak G√∂r√ºn√ºm√º") }}
            </h3>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <p class="embed-content">
              <i class="fa fa-info-circle"></i>
              {{ _("Bu embed kodunu CMS veya blog yazƒ±lƒ±mƒ±nƒ±za kopyalayƒ±p yapƒ±≈ütƒ±rabilirsiniz") }}
            </p>
            <div class="row">
              <div class="col-md-6">
                {{ form.input("width", label=_("Geni≈ülik"), value=700, classes=["control-full"]) }}
              </div>
              <div class="col-md-6">
                {{ form.input("height", label=_("Y√ºkseklik"), value=400, classes=["control-full"]) }}
              </div>
            </div>
            <div class="mt-3">
              {{ form.textarea("code", label=_("HTML Kodu"), value="", classes=["pre"], rows=5, placeholder="<iframe src='...'></iframe>") }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Enhanced iframe loading
    document.addEventListener('DOMContentLoaded', function() {
      const iframe = document.querySelector('iframe[data-module="data-viewer"]');
      if (iframe) {
        iframe.addEventListener('load', function() {
          this.classList.remove('loading');
        });
      }
      
      // Auto-generate embed code
      const widthInput = document.querySelector('input[name="width"]');
      const heightInput = document.querySelector('input[name="height"]');
      const codeTextarea = document.querySelector('textarea[name="code"]');
      
      function updateEmbedCode() {
        const width = widthInput.value || 700;
        const height = heightInput.value || 400;
        const embedUrl = "{{ h.url_for('resource_view', id=package['name'], resource_id=resource['id'], view_id=resource_view['id'], qualified=True) }}";
        
        const embedCode = `<iframe src="${embedUrl}" width="${width}" height="${height}" frameborder="0"></iframe>`;
        codeTextarea.value = embedCode;
      }
      
      if (widthInput && heightInput && codeTextarea) {
        widthInput.addEventListener('input', updateEmbedCode);
        heightInput.addEventListener('input', updateEmbedCode);
        updateEmbedCode(); // Initial generation
      }
    });
  </script>
{% endblock %}