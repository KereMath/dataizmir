{% asset 'base/view-filters' %}

<style>
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --glass-bg: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.2);
  --input-bg: rgba(255, 255, 255, 0.9);
  --shadow-modern: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.modern-filter-container {
  background: var(--glass-bg);
  backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  padding: 0;
  margin: 1rem 0;
  overflow: hidden;
  box-shadow: var(--shadow-modern);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.modern-filter-container:hover {
  transform: translateY(-3px);
  box-shadow: 0 0 30px rgba(102, 126, 234, 0.3), var(--shadow-modern);
}

.filter-header {
  background: var(--primary-gradient);
  padding: 1.5rem 2rem;
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: relative;
  overflow: hidden;
}

.filter-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: headerShimmer 4s infinite;
}

@keyframes headerShimmer {
  0%, 100% { transform: rotate(0deg); }
  50% { transform: rotate(180deg); }
}

.filter-title {
  font-size: 1.3rem;
  font-weight: 700;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.75rem;
  position: relative;
  z-index: 2;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.filter-toggle {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 12px;
  padding: 0.6rem 1.2rem;
  color: white;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  position: relative;
  z-index: 2;
}

.filter-toggle:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

.filter-toggle.active {
  background: var(--secondary-gradient);
  border-color: transparent;
  box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
}

.filter-content {
  padding: 2rem;
  max-height: 0;
  overflow: hidden;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0;
}

.filter-content.expanded {
  max-height: 800px;
  opacity: 1;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2rem;
}

.filter-group {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 15px;
  padding: 1.5rem;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.filter-group::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
  transition: left 0.6s ease;
}

.filter-group:hover::before {
  left: 100%;
}

.filter-group:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(102, 126, 234, 0.5);
  transform: translateY(-2px);
}

.filter-label {
  color: white;
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  position: relative;
  z-index: 2;
}

.filter-input {
  width: 100%;
  background: var(--input-bg);
  border: 2px solid transparent;
  border-radius: 12px;
  padding: 0.8rem 1rem;
  font-size: 0.95rem;
  transition: all 0.3s ease;
  position: relative;
  z-index: 2;
}

.filter-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
  transform: translateY(-1px);
}

.filter-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 1rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 3rem;
}

.filter-checkbox {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.5rem 0;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  z-index: 2;
}

.filter-checkbox:hover {
  transform: translateX(3px);
}

.filter-checkbox input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: #667eea;
  cursor: pointer;
}

.filter-checkbox label {
  color: rgba(255, 255, 255, 0.9);
  cursor: pointer;
  font-weight: 500;
}

.date-range-inputs {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

.date-input-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.date-input-group label {
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.85rem;
  font-weight: 500;
  position: relative;
  z-index: 2;
}

.filter-actions {
  display: flex;
  gap: 1rem;
  justify-content: space-between;
  align-items: center;
  padding-top: 1.5rem;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  flex-wrap: wrap;
}

.filter-actions-left {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.filter-actions-right {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.filter-btn {
  background: var(--secondary-gradient);
  border: none;
  border-radius: 12px;
  padding: 0.8rem 1.5rem;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
}

.filter-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
}

.filter-btn.secondary {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.filter-btn.secondary:hover {
  background: rgba(255, 255, 255, 0.2);
}

.filter-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.active-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 1rem;
}

.filter-tag {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  padding: 0.4rem 0.8rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
}

.filter-tag:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.filter-tag-remove {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  padding: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.filter-tag-remove:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

.filter-count {
  background: var(--primary-gradient);
  color: white;
  padding: 0.3rem 0.6rem;
  border-radius: 15px;
  font-size: 0.8rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.loading-filters {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  color: rgba(255, 255, 255, 0.7);
  font-style: italic;
}

.loading-spinner-small {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 0.5rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .filter-header {
    padding: 1rem 1.5rem;
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }

  .filter-content {
    padding: 1.5rem;
  }

  .filters-grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .filter-actions {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }

  .filter-actions-left,
  .filter-actions-right {
    justify-content: center;
  }

  .date-range-inputs {
    grid-template-columns: 1fr;
  }
}

/* Animation delays for staggered appearance */
.filter-group:nth-child(1) { animation-delay: 0s; }
.filter-group:nth-child(2) { animation-delay: 0.1s; }
.filter-group:nth-child(3) { animation-delay: 0.2s; }
.filter-group:nth-child(4) { animation-delay: 0.3s; }

@keyframes filterSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.filter-group {
  animation: filterSlideIn 0.6s ease-out;
}
</style>

<div class="modern-filter-container">
  <div class="filter-header">
    <h3 class="filter-title">
      <i class="fa fa-filter"></i>
      {{ _('Filter Data') }}
    </h3>
    
    <button class="filter-toggle" onclick="toggleFilters()" id="filter-toggle">
      <i class="fa fa-chevron-down" id="filter-chevron"></i>
      <span>{{ _('Show Filters') }}</span>
    </button>
  </div>

  <div class="filter-content" id="filter-content">
    <div class="loading-filters" id="loading-filters">
      <div class="loading-spinner-small"></div>
      {{ _('Loading filter options...') }}
    </div>

    <div class="resource-view-filters" 
         style="display: none;"
         data-module="resource-view-filters"
         data-module-resource-id="{{ resource['id'] }}"
         data-module-fields="{{ h.dump_json(h.resource_view_get_fields(resource)) }}">
      
      <div class="filters-grid" id="filters-grid">
        <!-- Dynamic filters will be populated here by JavaScript -->
      </div>

      <div class="filter-actions">
        <div class="filter-actions-left">
          <button class="filter-btn" onclick="applyFilters()" id="apply-filters">
            <i class="fa fa-check"></i>
            {{ _('Apply Filters') }}
          </button>
          
          <button class="filter-btn secondary" onclick="resetFilters()" id="reset-filters">
            <i class="fa fa-refresh"></i>
            {{ _('Reset All') }}
          </button>
        </div>

        <div class="filter-actions-right">
          <div class="filter-count" id="filter-count" style="display: none;">
            <i class="fa fa-filter"></i>
            <span id="filter-count-text">0 {{ _('filters active') }}</span>
          </div>
        </div>
      </div>

      <div class="active-filters" id="active-filters">
        <!-- Active filter tags will appear here -->
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  let filtersExpanded = false;
  let activeFilters = {};
  let availableFields = [];

  // Initialize filters
  window.addEventListener('DOMContentLoaded', function() {
    initializeFilters();
  });

  function initializeFilters() {
    // Get resource fields from data attribute
    const filterContainer = document.querySelector('[data-module="resource-view-filters"]');
    if (filterContainer) {
      try {
        availableFields = JSON.parse(filterContainer.dataset.moduleFields || '[]');
        generateFilterUI();
      } catch (e) {
        console.error('Failed to parse filter fields:', e);
        showError();
      }
    }
  }

  function generateFilterUI() {
    const filtersGrid = document.getElementById('filters-grid');
    const loadingFilters = document.getElementById('loading-filters');
    const filterContainer = document.querySelector('.resource-view-filters');

    if (!filtersGrid || !availableFields.length) {
      showError();
      return;
    }

    // Hide loading and show filters
    loadingFilters.style.display = 'none';
    filterContainer.style.display = 'block';

    // Generate filter controls for each field
    availableFields.forEach(field => {
      const filterGroup = createFilterGroup(field);
      filtersGrid.appendChild(filterGroup);
    });

    // Add event listeners
    setupFilterEventListeners();
  }

  function createFilterGroup(field) {
    const group = document.createElement('div');
    group.className = 'filter-group';
    
    let filterControl = '';
    
    switch (field.type) {
      case 'text':
        filterControl = `
          <input type="text" 
                 class="filter-input" 
                 placeholder="{{ _('Search in ') }}${field.label}..."
                 data-field="${field.name}"
                 data-type="text">
        `;
        break;
        
      case 'number':
        filterControl = `
          <div class="date-range-inputs">
            <div class="date-input-group">
              <label>{{ _('Minimum') }}</label>
              <input type="number" 
                     class="filter-input" 
                     placeholder="{{ _('Min value') }}"
                     data-field="${field.name}"
                     data-type="number-min">
            </div>
            <div class="date-input-group">
              <label>{{ _('Maximum') }}</label>
              <input type="number" 
                     class="filter-input" 
                     placeholder="{{ _('Max value') }}"
                     data-field="${field.name}"
                     data-type="number-max">
            </div>
          </div>
        `;
        break;
        
      case 'date':
        filterControl = `
          <div class="date-range-inputs">
            <div class="date-input-group">
              <label>{{ _('From') }}</label>
              <input type="date" 
                     class="filter-input" 
                     data-field="${field.name}"
                     data-type="date-from">
            </div>
            <div class="date-input-group">
              <label>{{ _('To') }}</label>
              <input type="date" 
                     class="filter-input" 
                     data-field="${field.name}"
                     data-type="date-to">
            </div>
          </div>
        `;
        break;
        
      case 'select':
        const options = field.options || [];
        filterControl = `
          <select class="filter-input filter-select" 
                  data-field="${field.name}"
                  data-type="select">
            <option value="">{{ _('All values') }}</option>
            ${options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
          </select>
        `;
        break;
        
      default:
        filterControl = `
          <input type="text" 
                 class="filter-input" 
                 placeholder="{{ _('Filter ') }}${field.label}..."
                 data-field="${field.name}"
                 data-type="text">
        `;
    }

    group.innerHTML = `
      <div class="filter-label">
        <i class="fa fa-${getFieldIcon(field.type)}"></i>
        ${field.label || field.name}
      </div>
      ${filterControl}
    `;

    return group;
  }

  function getFieldIcon(type) {
    switch (type) {
      case 'text': return 'font';
      case 'number': return 'hashtag';
      case 'date': return 'calendar';
      case 'select': return 'list';
      default: return 'filter';
    }
  }

  function setupFilterEventListeners() {
    const filterInputs = document.querySelectorAll('.filter-input');
    
    filterInputs.forEach(input => {
      input.addEventListener('change', updateActiveFilters);
      input.addEventListener('input', debounce(updateActiveFilters, 500));
    });
  }

  function updateActiveFilters() {
    const filterInputs = document.querySelectorAll('.filter-input');
    activeFilters = {};

    filterInputs.forEach(input => {
      if (input.value.trim()) {
        const field = input.dataset.field;
        const type = input.dataset.type;
        
        if (!activeFilters[field]) {
          activeFilters[field] = {};
        }
        
        activeFilters[field][type] = input.value.trim();
      }
    });

    updateFilterDisplay();
  }

  function updateFilterDisplay() {
    const activeFiltersContainer = document.getElementById('active-filters');
    const filterCount = document.getElementById('filter-count');
    const filterCountText = document.getElementById('filter-count-text');

    // Clear existing tags
    activeFiltersContainer.innerHTML = '';

    const filterCount_num = Object.keys(activeFilters).length;

    if (filterCount_num > 0) {
      filterCount.style.display = 'flex';
      filterCountText.textContent = `${filterCount_num} {{ _('filters active') }}`;

      // Create filter tags
      Object.entries(activeFilters).forEach(([field, filters]) => {
        Object.entries(filters).forEach(([type, value]) => {
          const tag = createFilterTag(field, type, value);
          activeFiltersContainer.appendChild(tag);
        });
      });
    } else {
      filterCount.style.display = 'none';
    }
  }

  function createFilterTag(field, type, value) {
    const tag = document.createElement('div');
    tag.className = 'filter-tag';
    
    const fieldLabel = availableFields.find(f => f.name === field)?.label || field;
    let displayValue = value;
    
    if (type.includes('min')) displayValue = `≥ ${value}`;
    if (type.includes('max')) displayValue = `≤ ${value}`;
    if (type.includes('from')) displayValue = `from ${value}`;
    if (type.includes('to')) displayValue = `to ${value}`;

    tag.innerHTML = `
      <span>${fieldLabel}: ${displayValue}</span>
      <button class="filter-tag-remove" onclick="removeFilter('${field}', '${type}')">
        <i class="fa fa-times"></i>
      </button>
    `;

    return tag;
  }

  // Global functions
  window.toggleFilters = function() {
    const content = document.getElementById('filter-content');
    const toggle = document.getElementById('filter-toggle');
    const chevron = document.getElementById('filter-chevron');

    filtersExpanded = !filtersExpanded;

    if (filtersExpanded) {
      content.classList.add('expanded');
      toggle.classList.add('active');
      chevron.className = 'fa fa-chevron-up';
      toggle.querySelector('span').textContent = '{{ _("Hide Filters") }}';
    } else {
      content.classList.remove('expanded');
      toggle.classList.remove('active');
      chevron.className = 'fa fa-chevron-down';
      toggle.querySelector('span').textContent = '{{ _("Show Filters") }}';
    }
  };

  window.applyFilters = function() {
    // Trigger filter application
    const event = new CustomEvent('filtersChanged', {
      detail: { filters: activeFilters }
    });
    document.dispatchEvent(event);

    // Send filters to parent frame or current view
    updateView();
  };

  window.resetFilters = function() {
    const filterInputs = document.querySelectorAll('.filter-input');
    filterInputs.forEach(input => {
      input.value = '';
    });
    
    activeFilters = {};
    updateFilterDisplay();
    updateView();
  };

  window.removeFilter = function(field, type) {
    if (activeFilters[field]) {
      delete activeFilters[field][type];
      
      if (Object.keys(activeFilters[field]).length === 0) {
        delete activeFilters[field];
      }
    }

    // Update corresponding input
    const input = document.querySelector(`[data-field="${field}"][data-type="${type}"]`);
    if (input) {
      input.value = '';
    }

    updateFilterDisplay();
    updateView();
  };

  function updateView() {
    // Build filter query string
    const filterParams = new URLSearchParams();
    
    Object.entries(activeFilters).forEach(([field, filters]) => {
      Object.entries(filters).forEach(([type, value]) => {
        filterParams.append(`filters[${field}][${type}]`, value);
      });
    });

    // Update URL or send to iframe
    const currentUrl = new URL(window.location);
    const newUrl = `${currentUrl.pathname}?${filterParams.toString()}`;
    
    // If we're in an iframe, send message to parent
    if (window.parent !== window) {
      window.parent.postMessage({
        type: 'updateFilters',
        url: newUrl,
        filters: activeFilters
      }, '*');
    } else {
      window.location.href = newUrl;
    }
  }

  function showError() {
    const loadingFilters = document.getElementById('loading-filters');
    if (loadingFilters) {
      loadingFilters.innerHTML = `
        <i class="fa fa-exclamation-triangle" style="color: #ff6b6b; margin-right: 0.5rem;"></i>
        {{ _('Unable to load filter options') }}
      `;
    }
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
})();
</script>