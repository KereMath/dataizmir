{#
Modern version of resources list with enhanced visual design and interactivity
#}

<style>
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --secondary-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  --glass-bg: rgba(255, 255, 255, 0.1);
  --glass-border: rgba(255, 255, 255, 0.2);
  --shadow-modern: 0 20px 40px rgba(0, 0, 0, 0.1);
  --hover-glow: 0 0 30px rgba(102, 126, 234, 0.4);
}

.modern-resources-section {
  background: var(--glass-bg);
  backdrop-filter: blur(15px);
  border: 1px solid var(--glass-border);
  border-radius: 25px;
  padding: 0;
  margin: 2rem 0;
  overflow: hidden;
  box-shadow: var(--shadow-modern);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.modern-resources-section:hover {
  transform: translateY(-5px);
  box-shadow: var(--hover-glow), var(--shadow-modern);
}

.resources-header {
  background: var(--primary-gradient);
  padding: 2rem 2.5rem;
  color: white;
  position: relative;
  overflow: hidden;
}

.resources-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  animation: headerShimmer 6s infinite;
}

@keyframes headerShimmer {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

.resources-title {
  font-size: 2.2rem;
  font-weight: 700;
  margin: 0 0 0.5rem 0;
  display: flex;
  align-items: center;
  gap: 1rem;
  position: relative;
  z-index: 2;
  text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
}

.resources-subtitle {
  color: rgba(255, 255, 255, 0.9);
  margin: 0;
  font-size: 1.1rem;
  position: relative;
  z-index: 2;
}

.resources-stats {
  position: absolute;
  top: 2rem;
  right: 2.5rem;
  display: flex;
  gap: 1rem;
  z-index: 2;
}

.stat-item {
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 15px;
  padding: 0.8rem 1.2rem;
  text-align: center;
  transition: all 0.3s ease;
}

.stat-item:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

.stat-number {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
}

.stat-label {
  font-size: 0.8rem;
  opacity: 0.9;
  margin: 0;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.resources-content {
  padding: 2rem 2.5rem;
}

.modern-resource-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: grid;
  gap: 1.5rem;
}

.modern-resource-list.grid-view {
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
}

.modern-resource-list.list-view {
  grid-template-columns: 1fr;
}

.view-toggle {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  justify-content: flex-end;
}

.view-toggle-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  padding: 0.6rem 1rem;
  color: rgba(255, 255, 255, 0.8);
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 500;
}

.view-toggle-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.view-toggle-btn.active {
  background: var(--secondary-gradient);
  border-color: transparent;
  color: white;
  box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: rgba(255, 255, 255, 0.7);
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 2rem;
  opacity: 0.3;
  color: white;
}

.empty-title {
  font-size: 1.8rem;
  font-weight: 700;
  margin-bottom: 1rem;
  color: white;
}

.empty-message {
  font-size: 1.1rem;
  line-height: 1.6;
  margin-bottom: 2rem;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
}

.empty-action {
  background: var(--secondary-gradient);
  border: none;
  border-radius: 20px;
  padding: 1rem 2rem;
  color: white;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
}

.empty-action:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 35px rgba(79, 172, 254, 0.6);
  color: white;
  text-decoration: none;
}

.resources-filter {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 15px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.filter-input {
  flex: 1;
  min-width: 250px;
  background: rgba(255, 255, 255, 0.9);
  border: 2px solid transparent;
  border-radius: 12px;
  padding: 0.8rem 1.2rem;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.filter-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
}

.filter-select {
  background: rgba(255, 255, 255, 0.9);
  border: 2px solid transparent;
  border-radius: 12px;
  padding: 0.8rem 1.2rem;
  font-size: 1rem;
  transition: all 0.3s ease;
  appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 1rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 3rem;
}

.filter-select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
}

.sort-options {
  display: flex;
  gap: 0.5rem;
}

.sort-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  padding: 0.6rem 0.8rem;
  color: rgba(255, 255, 255, 0.8);
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.sort-btn:hover,
.sort-btn.active {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.loading-state {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 3rem;
  gap: 1rem;
  color: rgba(255, 255, 255, 0.7);
}

.loading-spinner {
  width: 32px;
  height: 32px;
  border: 3px solid rgba(255, 255, 255, 0.2);
  border-top: 3px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
  .resources-header {
    padding: 1.5rem;
    text-align: center;
  }

  .resources-title {
    font-size: 1.8rem;
    flex-direction: column;
    gap: 0.5rem;
  }

  .resources-stats {
    position: static;
    justify-content: center;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .resources-content {
    padding: 1.5rem;
  }

  .modern-resource-list.grid-view {
    grid-template-columns: 1fr;
  }

  .resources-filter {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-input,
  .filter-select {
    min-width: auto;
  }

  .view-toggle {
    justify-content: center;
  }

  .sort-options {
    justify-content: center;
    flex-wrap: wrap;
  }
}

/* Animation for resource items */
@keyframes resourceSlideIn {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modern-resource-list > li {
  animation: resourceSlideIn 0.6s ease-out;
}

.modern-resource-list > li:nth-child(2) { animation-delay: 0.1s; }
.modern-resource-list > li:nth-child(3) { animation-delay: 0.2s; }
.modern-resource-list > li:nth-child(4) { animation-delay: 0.3s; }
.modern-resource-list > li:nth-child(5) { animation-delay: 0.4s; }
.modern-resource-list > li:nth-child(6) { animation-delay: 0.5s; }

/* Accessibility improvements */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>

<section id="dataset-resources" class="modern-resources-section">
  <div class="resources-header">
    <h2 class="resources-title">
      <i class="fa fa-database"></i>
      {{ _('Data and Resources') }}
    </h2>
    <p class="resources-subtitle">
      {{ _('Explore and download the datasets available in different formats') }}
    </p>
    
    {% if resources %}
      <div class="resources-stats">
        <div class="stat-item">
          <div class="stat-number">{{ resources|length }}</div>
          <div class="stat-label">{{ _('Resources') }}</div>
        </div>
        
        {% set formats = resources|map(attribute='format')|reject('none')|list|unique %}
        <div class="stat-item">
          <div class="stat-number">{{ formats|length }}</div>
          <div class="stat-label">{{ _('Formats') }}</div>
        </div>
      </div>
    {% endif %}
  </div>

  <div class="resources-content">
    {% block resource_list %}
      {% if resources %}
        <div class="resources-filter">
          <input type="text" 
                 class="filter-input" 
                 placeholder="{{ _('Search resources...') }}" 
                 id="resource-search"
                 onkeyup="filterResources()">
          
          <select class="filter-select" id="format-filter" onchange="filterResources()">
            <option value="">{{ _('All formats') }}</option>
            {% for format in resources|map(attribute='format')|reject('none')|list|unique|sort %}
              <option value="{{ format }}">{{ format }}</option>
            {% endfor %}
          </select>
          
          <div class="sort-options">
            <button class="sort-btn active" onclick="sortResources('name')" data-sort="name">
              <i class="fa fa-sort-alpha-asc"></i>
            </button>
            <button class="sort-btn" onclick="sortResources('date')" data-sort="date">
              <i class="fa fa-sort-numeric-desc"></i>
            </button>
            <button class="sort-btn" onclick="sortResources('format')" data-sort="format">
              <i class="fa fa-tags"></i>
            </button>
          </div>
        </div>

        <div class="view-toggle">
          <button class="view-toggle-btn active" onclick="setView('grid')" data-view="grid">
            <i class="fa fa-th"></i>
            {{ _('Grid') }}
          </button>
          <button class="view-toggle-btn" onclick="setView('list')" data-view="list">
            <i class="fa fa-list"></i>
            {{ _('List') }}
          </button>
        </div>

        <ul class="{% block resource_list_class %}modern-resource-list grid-view{% endblock %}" id="resources-container">
          {% block resource_list_inner %}
            {% set can_edit = h.check_access('package_update', {'id':pkg.id }) and not is_activity_archive %}
            {% for resource in resources %}
              {% snippet 'package/snippets/resource_item.html', pkg=pkg, res=resource, can_edit=can_edit, is_activity_archive=is_activity_archive %}
            {% endfor %}
          {% endblock %}
        </ul>

        <div class="loading-state" id="loading-state" style="display: none;">
          <div class="loading-spinner"></div>
          <span>{{ _('Filtering resources...') }}</span>
        </div>

      {% else %}
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fa fa-database"></i>
          </div>
          <h3 class="empty-title">{{ _('No Resources Available') }}</h3>
          <p class="empty-message">
            {% if h.check_access('resource_create', {'package_id': pkg['id']}) and not is_activity_archive %}
              {{ _('This dataset doesn\'t have any resources yet. Resources contain the actual data in various formats like CSV, JSON, or Excel files.') }}
            {% else %}
              {{ _('This dataset has no data available for download.') }}
            {% endif %}
          </p>
          
          {% if h.check_access('resource_create', {'package_id': pkg['id']}) and not is_activity_archive %}
            {% trans url=h.url_for(pkg.type ~ '_resource.new', id=pkg.name) %}
              <a href="{{ url }}" class="empty-action">
                <i class="fa fa-plus-circle"></i>
                {{ _('Add First Resource') }}
              </a>
            {% endtrans %}
          {% endif %}
        </div>
      {% endif %}
    {% endblock %}
  </div>
</section>

<script>
(function() {
  'use strict';

  let currentView = 'grid';
  let currentSort = 'name';
  let allResources = [];

  document.addEventListener('DOMContentLoaded', function() {
    // Store original resources data
    const resourceItems = document.querySelectorAll('#resources-container > li');
    allResources = Array.from(resourceItems).map(item => ({
      element: item,
      name: item.querySelector('.resource-title a')?.textContent?.trim() || '',
      format: item.dataset.format || item.className.match(/format-(\w+)/)?.[1] || '',
      date: item.querySelector('[data-date]')?.dataset.date || '',
      description: item.querySelector('.resource-description')?.textContent?.trim() || ''
    }));

    // Add analytics tracking
    trackResourceInteractions();
    
    // Add keyboard navigation
    addKeyboardNavigation();
    
    // Add intersection observer for lazy loading analytics
    addIntersectionObserver();
  });

  window.filterResources = function() {
    const searchTerm = document.getElementById('resource-search').value.toLowerCase();
    const formatFilter = document.getElementById('format-filter').value.toLowerCase();
    const container = document.getElementById('resources-container');
    const loadingState = document.getElementById('loading-state');

    // Show loading state
    loadingState.style.display = 'flex';
    container.style.opacity = '0.5';

    setTimeout(() => {
      const filteredResources = allResources.filter(resource => {
        const matchesSearch = !searchTerm || 
          resource.name.toLowerCase().includes(searchTerm) ||
          resource.description.toLowerCase().includes(searchTerm);
        
        const matchesFormat = !formatFilter || 
          resource.format.toLowerCase() === formatFilter;

        return matchesSearch && matchesFormat;
      });

      // Clear container
      container.innerHTML = '';

      // Add filtered resources
      filteredResources.forEach((resource, index) => {
        resource.element.style.animationDelay = (index * 0.1) + 's';
        container.appendChild(resource.element);
      });

      // Hide loading state
      loadingState.style.display = 'none';
      container.style.opacity = '1';

      // Update stats
      updateResourceStats(filteredResources.length);

      // Track filtering
      if (typeof gtag !== 'undefined') {
        gtag('event', 'resources_filtered', {
          'search_term': searchTerm,
          'format_filter': formatFilter,
          'results_count': filteredResources.length
        });
      }
    }, 300);
  };

  window.sortResources = function(sortBy) {
    const container = document.getElementById('resources-container');
    const loadingState = document.getElementById('loading-state');
    
    // Update sort buttons
    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.sort === sortBy);
    });

    // Show loading state
    loadingState.style.display = 'flex';
    container.style.opacity = '0.5';

    setTimeout(() => {
      const sortedResources = [...allResources].sort((a, b) => {
        switch(sortBy) {
          case 'name':
            return a.name.localeCompare(b.name);
          case 'date':
            return new Date(b.date || 0) - new Date(a.date || 0);
          case 'format':
            return a.format.localeCompare(b.format);
          default:
            return 0;
        }
      });

      // Clear and repopulate container
      container.innerHTML = '';
      sortedResources.forEach((resource, index) => {
        resource.element.style.animationDelay = (index * 0.1) + 's';
        container.appendChild(resource.element);
      });

      // Hide loading state
      loadingState.style.display = 'none';
      container.style.opacity = '1';

      currentSort = sortBy;

      // Track sorting
      if (typeof gtag !== 'undefined') {
        gtag('event', 'resources_sorted', {
          'sort_by': sortBy
        });
      }
    }, 200);
  };

  window.setView = function(view) {
    const container = document.getElementById('resources-container');
    
    // Update view toggle buttons
    document.querySelectorAll('.view-toggle-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.view === view);
    });

    // Update container class
    container.className = container.className.replace(/\b(grid|list)-view\b/g, '');
    container.classList.add(view + '-view');

    currentView = view;

    // Store preference
    localStorage.setItem('resources-view-preference', view);

    // Track view change
    if (typeof gtag !== 'undefined') {
      gtag('event', 'view_changed', {
        'view_type': view
      });
    }
  };

  function updateResourceStats(count) {
    const statNumber = document.querySelector('.stat-number');
    if (statNumber) {
      statNumber.textContent = count;
    }
  }

  function trackResourceInteractions() {
    // Track resource clicks
    document.addEventListener('click', function(e) {
      const resourceLink = e.target.closest('.resource-title a, .modern-btn');
      if (resourceLink && typeof gtag !== 'undefined') {
        const resourceItem = resourceLink.closest('li[data-id]');
        const resourceId = resourceItem?.dataset.id;
        
        if (resourceId) {
          gtag('event', 'resource_interaction', {
            'resource_id': resourceId,
            'action': resourceLink.textContent.trim().toLowerCase(),
            'view_type': currentView
          });
        }
      }
    });
  }

  function addKeyboardNavigation() {
    document.addEventListener('keydown', function(e) {
      // Ctrl/Cmd + F to focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('resource-search')?.focus();
      }
      
      // Escape to clear search
      if (e.key === 'Escape') {
        const searchInput = document.getElementById('resource-search');
        if (searchInput && searchInput === document.activeElement) {
          searchInput.value = '';
          filterResources();
        }
      }
    });
  }

  function addIntersectionObserver() {
    if (typeof IntersectionObserver !== 'undefined') {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const resourceId = entry.target.dataset.id;
            if (resourceId && typeof gtag !== 'undefined') {
              gtag('event', 'resource_view', {
                'resource_id': resourceId,
                'view_type': currentView
              });
            }
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.5 });

      document.querySelectorAll('#resources-container > li').forEach(item => {
        observer.observe(item);
      });
    }
  }

  // Load saved view preference
  const savedView = localStorage.getItem('resources-view-preference');
  if (savedView && ['grid', 'list'].includes(savedView)) {
    setView(savedView);
  }

  // Add live search debouncing
  let searchTimeout;
  const searchInput = document.getElementById('resource-search');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(filterResources, 300);
    });
  }
})();
</script>