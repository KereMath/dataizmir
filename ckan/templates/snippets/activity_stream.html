<style>
    .modern-activity-table tbody tr {
    height: auto !important; /* Otomatik yükseklik */
  }
  /* Main Layout Container */
  .activity-main-layout {
    display: block !important; /* Flex yerine block yapıldı */
    width: 100% !important;
    max-width: 1400px !important;
    margin: 0 auto !important;
    padding: 20px !important;
  }
  
  /* Sidebar tamamen kaldırıldığı için ilgili CSS'ler önemsizleşti */
  .activity-filter-sidebar {
    display: none !important; /* Sidebar tamamen gizlendi */
  }
  
  /* Modern Activity Stream Styles */
  .modern-activity-container {
    background: #ffffff !important;
    border-radius: 12px !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important;
    overflow: auto !important; /* Tablonun yatay kaydırması için auto yapıldı */
    flex: 1 !important;
  }
  
  .activity-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    padding: 20px 24px !important;
    border-bottom: none !important;
  }
  
  .activity-header h3 {
    margin: 0 !important;
    font-size: 18px !important;
    font-weight: 600 !important;
    display: flex !important;
    align-items: center !important;
    gap: 10px !important;
  }
  
  .activity-header h3:before {
    content: "⚡" !important;
    font-size: 20px !important;
  }
  
  .modern-activity-table {
    width: 100% !important;
    border-collapse: collapse !important;
    background: white !important;
    margin: 0 !important;
    table-layout: auto !important; /* Sütun genişlikleri dinamikleşsin */
    min-width: 800px; /* Çok fazla sütun varsa yatay kaydırma için minimum genişlik */
  }
  
  /* Eski sabit sütun genişlikleri kaldırıldı, dinamik içeriğe göre ayarlansın */
  .modern-activity-table th,
  .modern-activity-table td {
      padding: 16px 20px !important;
      text-align: left !important;
      vertical-align: top !important; /* İçerik üste hizalansın */
      font-size: 14px !important;
      line-height: 1.5 !important;
      border-bottom: 1px solid #f1f5f9 !important;
      word-break: break-word; /* Uzun kelimeleri kırma */
  }
  
  .modern-activity-table thead {
    background: #f8fafc !important;
    border-bottom: 2px solid #e2e8f0 !important;
  }
  
  .modern-activity-table th {
    font-weight: 600 !important;
    color: #475569 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
    border: none !important;
  }
  
  .modern-activity-table tbody tr {
    transition: all 0.2s ease !important;
  }
  
  .modern-activity-table tbody tr:hover {
    background: #f8fafc !important;
    transform: none !important; /* Hover efekti kaldırıldı */
    box-shadow: none !important; /* Hover efekti kaldırıldı */
  }
  
  .modern-activity-table tbody tr:last-child {
    border-bottom: none !important;
  }
  
  /* Bu kısım artık kullanılmıyor, kaldırıldı:
  .modern-activity-table tbody tr.hidden {
    display: table-row !important;
  }
  */
  
  /* Diğer CSS kuralları aynen kalsın veya ihtiyaca göre düzenlensin */
  /* Stil düzeltmelerinin çoğu geçerliliğini koruyor */
  
  /* Remove list markers and styling */
  .activity-object li {
    list-style: none !important;
    list-style-type: none !important;
    margin: 0 !important;
    padding: 0 !important;
  }
  
  .activity-object li::marker {
    display: none !important;
    content: none !important;
  }
  
  .activity-object ul, .activity-object ol {
    list-style: none !important;
    padding: 0 !important;
    margin: 0 !important;
  }
  
  
  /* Responsive Design */
  @media (max-width: 1200px) {
    .activity-main-layout {
      flex-direction: column !important;
    }
    
    .activity-filter-sidebar {
      width: 100% !important;
      min-width: auto !important;
      position: relative !important;
      top: auto !important;
    }
    
    .sidebar-content {
      padding: 20px !important;
    }
    
    /* Bu sınıflara sahip elemanlar artık yok, kaldırıldı */
    /*
    .activity-type-filters,
    .time-range-filters,
    .user-filters {
      flex-direction: column !important;
      flex-wrap: nowrap !important;
    }
    
    .activity-type-option,
    .time-range-option,
    .user-filter-option {
      flex: none !important;
      min-width: auto !important;
    }
    */
  }
  
  @media (max-width: 768px) {
    .modern-activity-table th,
    .modern-activity-table td {
      padding: 10px 12px !important; /* Daha küçük padding */
      font-size: 12px !important;
    }
    
    .activity-header {
      padding: 12px 16px !important;
    }
    
    .activity-header h3 {
      font-size: 15px !important;
    }
    
    /* Bu sınıflara sahip elemanlar artık yok, kaldırıldı */
    /*
    .activity-icon {
      width: 24px !important;
      height: 24px !important;
      font-size: 10px !important;
    }
    */
    
    /* Bu sınıflara sahip elemanlar artık yok, kaldırıldı */
    /*
    .activity-type-filters,
    .time-range-filters,
    .user-filters {
      flex-direction: column !important;
    }
    */
    
    /* Pagination artık tamamen gizlendiği için bu kısım da önemsizleşti */
    .pagination-container {
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 10px !important;
      padding: 15px !important;
    }
    
    .pagination-controls {
      justify-content: center !important;
      flex-wrap: wrap !important;
    }
  }
  
  @media (max-width: 480px) {
    .modern-activity-table {
      font-size: 11px !important;
    }
  }
  </style>
  
  {# Displays an activity stream with filters
  
  activity_stream - the activity data. e.g. the output from package_activity_list
  id - the id or current name of the object (e.g. package name, user id)
  object_type - 'package', 'organization', 'group', 'user'
  
  #}
  {% block activity_stream %}
  {# Makrolar aynen kalabilir, çünkü activity nesnesi hala aynı şekilde kullanılacak #}
  {% macro actor(activity) %}
    <span class="actor">
      {{ h.linked_user(activity.user_id, 0, 30) }}
    </span>
  {% endmacro %}
  
  {% macro dataset(activity) %}
    {% set dataset_type = activity.data.package.type if activity.data.package and activity.data.package.type else 'dataset' %}
    <span class="dataset">
      {{ h.link_to(activity.data.package.title if activity.data.package and activity.data.package.title else _('unknown'),
        h.url_for(dataset_type ~ '.read', id=activity.object_id)) }}
    </span>
  {% endmacro %}
  
  {% macro organization(activity) %}
    {{ h.link_to(activity.data.group.title if activity.data.group and activity.data.group.title else _('unknown'),
                 h.url_for('organization.read', id=activity.object_id)) }}
  {% endmacro %}
  
  {% macro user(activity) %}
  <span class="actor">
    {{ h.linked_user(activity.object_id, 0, 20) }}
  </span>
  {% endmacro %}
  
  {% macro group(activity) %}
  <span class="group">
    {{ h.link_to(activity.data.group.title if activity.data.group and activity.data.group.title else _('unknown'),
                 h.url_for('group.read', id=activity.object_id)) }}
  </span>
  {% endmacro %}
  
  
  {% set can_show_activity_detail = h.check_access('activity_list', {'id': id, 'include_data': True, 'object_type': object_type}) %}
  
  <div class="activity-main-layout">
      <div class="activity-filter-sidebar" style="display: none;">
        </div>
  
      <div class="modern-activity-container">
      <div class="activity-header">
        <h3>Tüm Aktiviteler (Backend'den Gelen Eksiksiz Veri)</h3>
      </div>
      
      {% if activity_stream %}
        <table class="modern-activity-table">
          <thead>
            <tr id="activity-table-header-row">
              {# Sütun başlıkları dinamik olarak JavaScript tarafından doldurulacak #}
            </tr>
          </thead>
          <tbody id="activity-table-body">
            {# Jinja2 ile gelen veriyi işleyip tabloya basıyoruz - JS tarafından doldurulacak #}
          </tbody>
        </table>
        
              <div class="pagination-container" style="display: none;">
          <div class="pagination-info" id="pagination-info"></div>
          <div class="pagination-controls">
            <div class="pagination-buttons" id="pagination-buttons"></div>
          </div>
        </div>
      {% else %}
        <div class="activity-empty">
          <div class="activity-empty-icon">📊</div>
          <div class="activity-empty-text">Henüz aktivite yok</div>
          <div class="activity-empty-description">Aktiviteler burada görünecek</div>
        </div>
      {% endif %}
    </div>
  </div>
  
  <script>
  document.addEventListener('DOMContentLoaded', function() {
      // activity_stream verisi, Jinja2'den doğrudan bir JavaScript değişkenine aktarılır.
      // Bu, CKAN'ın Python tarafında `activity_stream` adında bir değişkende
      // aktivite verilerini sağladığını varsayarız.
      const activityStream = {{ activity_stream | tojson }};
  
      const tableBody = document.getElementById('activity-table-body');
      const tableHeaderRow = document.getElementById('activity-table-header-row');
  
      if (!activityStream || activityStream.length === 0) {
          // Eğer aktivite akışı boşsa, JS tarafında ekstra bir işlem yapmaya gerek yok,
          // Jinja'nın {% else %} bloğu zaten bu durumu yönetiyor.
          return;
      }
  
      // --- Sütun Başlıklarını Dinamik Olarak Oluştur ---
      // Tüm aktivitelerdeki benzersiz anahtarları topla
      let allKeys = new Set();
      activityStream.forEach(activity => {
          Object.keys(activity).forEach(key => allKeys.add(key));
          // activity.data bir nesne ise, içindeki anahtarları da 'data.key' formatında ekleyelim
          if (typeof activity.data === 'object' && activity.data !== null) {
              Object.keys(activity.data).forEach(dataKey => allKeys.add('data.' + dataKey));
          } else if (typeof activity.data === 'string') {
              // Eğer activity.data bir JSON string ise parse etmeye çalışalım
              try {
                  const parsedData = JSON.parse(activity.data);
                  if (typeof parsedData === 'object' && parsedData !== null) {
                      Object.keys(parsedData).forEach(dataKey => allKeys.add('data.' + dataKey));
                  }
              } catch (e) {
                  // JSON parse hatası varsa, data'yı sadece bir 'data' sütunu olarak ele alacağız
                  allKeys.add('data');
              }
          }
      });
  
      // Gösterilmesini istemediğimiz bazı anahtarlar (CKAN içsel veya anlamsız)
      const excludedKeys = new Set([
          '__extras',
          'validated_data',
          'object_type', // Nesne tipi ve ID'sini birleştirip daha anlamlı hale getirebiliriz
          'object_id',
          'activity_type', // Daha anlamlı bir "Aktivite" sütunu oluşturacağız
          'user_id', // Kullanıcı ID'si yerine kullanıcı adını çekeceğiz
          // Diğer CKAN özel/içsel anahtarları:
          'revision_id',
          'data' // 'data.key' olarak detayları alacağımız için ana 'data' sütununu kaldırıyoruz
      ]);
  
      // Kullanıcı adları için bir cache oluşturalım
      const userCache = {};
      const userPromises = [];
  
      // CKAN API'sinden kullanıcı adını çeker
      // Bu fonksiyon, aynı zamanda cache'i günceller ve Promise döndürür.
      async function fetchUsername(userId) {
          if (!userId) return 'Bilinmiyor';
          if (userCache[userId]) return userCache[userId];
  
          try {
              // CKAN API Endpoint'i için göreceli URL kullanıyoruz.
              // Sunucu adresini belirtmeye gerek yok.
              const response = await fetch(`/api/3/action/user_show`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  credentials: 'include', // Oturum çerezlerini gönderir
                  body: JSON.stringify({ id: userId })
              });
              const data = await response.json();
              if (data.success && data.result) {
                  const username = data.result.name || data.result.display_name || 'Bilinmiyor';
                  userCache[userId] = username;
                  return username;
              }
          } catch (error) {
              console.warn(`Kullanıcı ID ${userId} bilgisi çekilemedi:`, error);
          }
          userCache[userId] = 'Bilinmiyor'; // Hata durumunda da cache'e ekle
          return 'Bilinmiyor';
      }
  
      // Başlık hücresi için gösterim sırası ve başlıklar
      const customHeaders = {
          'timestamp': 'Zaman',
          'user_display_name': 'Kullanıcı', // Yeni oluşturacağımız kullanıcı adı sütunu
          'activity_details': 'Aktivite Detayı', // Aktivite tipi ve nesne detaylarını birleştireceğimiz sütun
          'object_type': 'Nesne Tipi', // Eğer ayrı bir sütun olarak tutmak istersek
          'object_id': 'Nesne ID', // Eğer ayrı bir sütun olarak tutmak istersek
          // Diğer 'data.' ile başlayanlar dinamik olacak
      };
  
      // Belirli bir sıralama belirleyelim, geri kalanlar alfabetik olsun
      const preferredOrder = [
          'timestamp', 'user_display_name', 'activity_details'
          // 'object_type', 'object_id' gibi daha fazla sütunu buraya ekleyebilirsiniz
      ];
  
      // `allKeys` kümesindeki anahtarları sırala
      let sortedKeys = Array.from(allKeys).filter(key => !excludedKeys.has(key));
      sortedKeys.sort((a, b) => {
          const indexA = preferredOrder.indexOf(a);
          const indexB = preferredOrder.indexOf(b);
  
          // Eğer ikisi de tercih edilen sırada değilse alfabetik sırala
          if (indexA === -1 && indexB === -1) {
              return a.localeCompare(b);
          }
          // Sadece biri tercih edilen sıradaysa, onu öne al
          if (indexA === -1) return 1;
          if (indexB === -1) return -1;
          // İkisi de tercih edilen sıradaysa, sırasına göre sırala
          return indexA - indexB;
      });
  
      // Custom header'ları preferredOrder'ın başına ekleyerek nihai sırayı oluştur
      const finalHeaders = preferredOrder.filter(header => Object.keys(customHeaders).includes(header))
                              .concat(sortedKeys.filter(key => !preferredOrder.includes(key)));
  
      // Dinamik sütun başlıklarını oluştur
      const headerHtml = finalHeaders.map(key => {
          let displayKey = customHeaders[key] || key.replace(/_/g, ' '); // Özel başlık varsa onu kullan, yoksa alt çizgileri düzelt
          if (key.startsWith('data.')) {
              displayKey = 'Detay: ' + displayKey.substring(5).replace(/_/g, ' '); // 'data.' prefix'ini kaldırıp düzelt
          }
          return `<th>${displayKey.charAt(0).toUpperCase() + displayKey.slice(1)}</th>`; // İlk harfi büyüt
      }).join('');
      tableHeaderRow.innerHTML = headerHtml;
  
      // Kullanıcı adlarını önceden çekmek için tüm user_id'leri topla
      const uniqueUserIds = new Set(activityStream.map(activity => activity.user_id).filter(id => id && id !== 'null'));
      uniqueUserIds.forEach(userId => {
          userPromises.push(fetchUsername(userId));
      });
  
      // Tüm kullanıcı adları çekildikten sonra tabloyu render et
      Promise.all(userPromises).then(() => {
          tableBody.innerHTML = ''; // Mevcut içeriği temizle
  
          activityStream.forEach(activity => {
              const tr = document.createElement('tr');
  
              finalHeaders.forEach(headerKey => {
                  const td = document.createElement('td');
                  let cellContent = '';
  
                  if (headerKey === 'user_display_name') {
                      cellContent = userCache[activity.user_id] || activity.user_id || 'Bilinmiyor';
                  } else if (headerKey === 'timestamp') {
                      cellContent = activity.timestamp ? new Date(activity.timestamp).toLocaleString('tr-TR') : '<span style="color:#9b98a7;font-style:italic;">Yok</span>';
                  } else if (headerKey === 'activity_details') {
                      // Bu sütunda Aktivite Tipi ve Nesne bilgisini birleştiriyoruz
                      let objectLinkHtml = '';
                      let activityTypeTranslated = '';
  
                      const activityType = activity.activity_type ? activity.activity_type.replace(/_/g, ' ').toLowerCase() : 'unknown';
  
                      // Basit çeviriler (daha kapsamlı çeviri için CKAN i18n helperları kullanılmalı)
                      if (activityType.includes('new') || activityType.includes('created')) {
                          activityTypeTranslated = 'Yeni Oluşturuldu';
                          td.innerHTML += `<div style="display: flex; align-items: center; gap: 8px;"><div class="activity-icon created">+</div> <span style="font-weight: 600; color: #059669;">${activityTypeTranslated}</span></div>`;
                      } else if (activityType.includes('changed') || activityType.includes('updated')) {
                          activityTypeTranslated = 'Güncellendi';
                          td.innerHTML += `<div style="display: flex; align-items: center; gap: 8px;"><div class="activity-icon updated">✎</div> <span style="font-weight: 600; color: #3b82f6;">${activityTypeTranslated}</span></div>`;
                      } else if (activityType.includes('deleted')) {
                          activityTypeTranslated = 'Silindi';
                          td.innerHTML += `<div style="display: flex; align-items: center; gap: 8px;"><div class="activity-icon deleted">×</div> <span style="font-weight: 600; color: #ef4444;">${activityTypeTranslated}</span></div>`;
                      } else if (activityType.includes('follow')) {
                          activityTypeTranslated = 'Takip Edildi';
                          td.innerHTML += `<div style="display: flex; align-items: center; gap: 8px;"><div class="activity-icon follow">♥</div> <span style="font-weight: 600; color: #f59e0b;">${activityTypeTranslated}</span></div>`;
                      } else {
                          activityTypeTranslated = activity.activity_type ? activity.activity_type.replace(/_/g, ' ') : 'Bilinmiyor';
                          td.innerHTML += `<div style="display: flex; align-items: center; gap: 8px;"><div class="activity-icon default">•</div> <span style="font-weight: 600; color: #6b7280;">${activityTypeTranslated.charAt(0).toUpperCase() + activityTypeTranslated.slice(1)}</span></div>`;
                      }
                      td.innerHTML += `<div class="activity-description">${userCache[activity.user_id] || activity.user_id || 'Bilinmiyor'} tarafından</div>`;
  
  
                      // Nesne tipi ve ID'sine göre link oluştur
                      if (activity.object_type === 'package') {
                          const pkg = activity.data.package || {}; // Eğer data.package yoksa boş obje
                          objectLinkHtml = `<span class="activity-object"><a href="/dataset/${pkg.name || activity.object_id}" class="activity-action-btn view">👁️ ${pkg.title || pkg.name || _('unknown dataset')}</a></span>`;
                      } else if (activity.object_type === 'organization' || activity.object_type === 'group') {
                          const group = activity.data.group || {}; // Eğer data.group yoksa boş obje
                          const urlPrefix = activity.object_type === 'organization' ? '/organization/' : '/group/';
                          objectLinkHtml = `<span class="activity-object"><a href="${urlPrefix}${group.name || activity.object_id}" class="activity-action-btn view">👁️ ${group.title || group.name || _('unknown ' + activity.object_type)}</a></span>`;
                      } else if (activity.object_type === 'user') {
                          objectLinkHtml = `<span class="activity-object"><a href="/user/${activity.object_id}" class="activity-action-btn view">👁️ ${userCache[activity.object_id] || activity.object_id || _('unknown user')}</a></span>`;
                      } else {
                           // Diğer objeler için sadece ID veya tip göster
                          objectLinkHtml = `<span class="activity-object">${activity.object_type ? activity.object_type.charAt(0).toUpperCase() + activity.object_type.slice(1) + ': ' : ''}${activity.object_id || _('unknown object')}</span>`;
                      }
                      td.innerHTML += objectLinkHtml;
                  }
                  else if (headerKey.startsWith('data.')) {
                      // data.key'leri özel olarak işle
                      const dataKey = headerKey.substring(5);
                      try {
                          let dataValue;
                          if (typeof activity.data === 'string') {
                              // Eğer activity.data bir JSON string ise parse et
                              const parsedData = JSON.parse(activity.data);
                              dataValue = parsedData[dataKey];
                          } else if (typeof activity.data === 'object' && activity.data !== null) {
                              // Zaten bir obje ise doğrudan eriş
                              dataValue = activity.data[dataKey];
                          }
                          
                          if (dataValue !== undefined && dataValue !== null) {
                              if (typeof dataValue === 'object') {
                                  cellContent = `<pre>${JSON.stringify(dataValue, null, 2)}</pre>`;
                              } else if (typeof dataValue === 'boolean') {
                                  cellContent = dataValue ? 'Evet' : 'Hayır';
                              }
                              else {
                                  cellContent = dataValue.toString();
                              }
                          } else {
                              cellContent = '<span style="color:#9b98a7;font-style:italic;">Yok</span>';
                          }
                      } catch (e) {
                          cellContent = `<span style="color:red;font-style:italic;">Veri hatası (JSON parse hatası)</span>`;
                          console.error('JSON parse hatası:', e, activity.data);
                      }
                      td.innerHTML = cellContent;
                  } else if (activity[headerKey] !== undefined && activity[headerKey] !== null) {
                      if (typeof activity[headerKey] === 'object') {
                          cellContent = `<pre>${JSON.stringify(activity[headerKey], null, 2)}</pre>`;
                      } else if (typeof activity[headerKey] === 'boolean') {
                          cellContent = activity[headerKey] ? 'Evet' : 'Hayır';
                      } else {
                          cellContent = activity[headerKey].toString();
                      }
                      td.innerHTML = cellContent;
                  } else {
                      td.innerHTML = '<span style="color:#9b98a7;font-style:italic;">Yok</span>';
                  }
                  tr.appendChild(td);
              });
              tableBody.appendChild(tr);
          });
      }).catch(error => {
          console.error("Tablo oluşturulurken hata:", error);
          tableBody.innerHTML = `<tr><td colspan="${finalHeaders.length}" style="text-align:center; color:red;">Veri yüklenirken veya işlenirken hata oluştu: ${error.message}</td></tr>`;
      });
  });
  </script>
  {% endblock %}