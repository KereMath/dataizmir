{% extends "page.html" %}

{% set user = user_dict %}

<style>
  header.module-content.page-header {
    display: none !important;
  }
  .page-header {
    background-color: transparent !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Kullanƒ±cƒ±nƒ±n kendi API bilgilerini fetch et
    fetchUserProfile();
});

async function fetchUserProfile() {
    try {
        console.log('üöÄ Fetching user profile data...');
        
        // API isteƒüi - session-based auth kullanƒ±yor (kullanƒ±cƒ± zaten login)
        const response = await fetch('/api/3/action/user_show', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'include', // Session cookies dahil et
            body: JSON.stringify({
                id: '{{ user.name }}', // Mevcut kullanƒ±cƒ±nƒ±n name'i
                include_datasets: true,
                include_num_followers: true
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ API Response Success!');
            console.log('üìä Full User Data:', data.result);
            
            // Detaylƒ± log'lar
            console.log('üë§ User Info:', {
                name: data.result.name,
                display_name: data.result.display_name,
                email: data.result.email,
                created: data.result.created,
                state: data.result.state,
                sysadmin: data.result.sysadmin,
                apikey: data.result.apikey
            });
            
            console.log('üìà User Stats:', {
                number_created_packages: data.result.number_created_packages,
                num_followers: data.result.num_followers,
                email_hash: data.result.email_hash
            });
            
            if (data.result.datasets) {
                console.log('üì¶ User Datasets (' + data.result.datasets.length + ' total):', 
                    data.result.datasets.map(dataset => ({
                        name: dataset.name,
                        title: dataset.title,
                        state: dataset.state,
                        private: dataset.private,
                        created: dataset.metadata_created
                    }))
                );
            }
            
            // Extra API call - get more detailed user info with all options
            fetchExtendedUserInfo();
            
        } else {
            console.error('‚ùå API Error:', data.error);
        }
        
    } catch (error) {
        console.error('üí• Fetch Error:', error);
        console.log('üîÑ Trying alternative method...');
        
        // Fallback: Try with current session
        try {
            const fallbackResponse = await fetch('/api/3/action/user_show', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: '{{ user.name }}'
                })
            });
            
            const fallbackData = await fallbackResponse.json();
            console.log('üîÑ Fallback Response:', fallbackData);
            
        } catch (fallbackError) {
            console.error('üí• Fallback also failed:', fallbackError);
        }
    }
}

async function fetchExtendedUserInfo() {
    try {
        console.log('üîç Fetching extended user info...');
        
        const extendedResponse = await fetch('/api/3/action/user_show', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'include',
            body: JSON.stringify({
                id: '{{ user.name }}',
                include_datasets: true,
                include_num_followers: true,
                include_password_hash: false, // Bu sadece sysadmin i√ßin
                include_plugin_extras: false // Bu sadece sysadmin i√ßin
            })
        });

        if (extendedResponse.ok) {
            const extendedData = await extendedResponse.json();
            console.log('üéØ Extended User Data:', extendedData.result);
            
            // √ñzel alanlarƒ± logla
            if (extendedData.result.plugin_extras) {
                console.log('üîå Plugin Extras:', extendedData.result.plugin_extras);
            }
            
            // User activity'leri de alabilir miyiz test edelim
            fetchUserActivity();
        }
        
    } catch (error) {
        console.log('‚ö†Ô∏è Extended fetch failed:', error);
    }
}

async function fetchUserActivity() {
    try {
        console.log('üìà Fetching user activity...');
        
        const activityResponse = await fetch('/api/3/action/user_activity_list', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'include',
            body: JSON.stringify({
                id: '{{ user.name }}',
                limit: 10
            })
        });

        if (activityResponse.ok) {
            const activityData = await activityResponse.json();
            console.log('üé¨ User Activity:', activityData.result);
        }
        
    } catch (error) {
        console.log('‚ö†Ô∏è Activity fetch failed:', error);
    }
}

// Debug i√ßin window'a fonksiyonlarƒ± ekle
window.fetchUserProfile = fetchUserProfile;
window.fetchExtendedUserInfo = fetchExtendedUserInfo;
window.fetchUserActivity = fetchUserActivity;

console.log('üéÆ User Profile API Debug Functions Available:');
console.log('- fetchUserProfile()');
console.log('- fetchExtendedUserInfo()');
console.log('- fetchUserActivity()');
</script>

{% block secondary_content %}
<div class="module context-info">
  <section class="module-content">
    {% block secondary_content_inner %}
      {% block user_image %}
      <div class="image">{{ h.user_image(user.id, size=270) }}</div>
      {% endblock %}
      {% block user_heading %}
      <h1 class="heading">{{ user.display_name }}</h1>
      {% endblock %}
      {% block user_about %}
      {% if about_formatted %}
        {{ about_formatted }}
      {% else %}
        <p class="empty">
          {% if is_myself %}
            {% trans %}You have not provided a biography.{% endtrans %}
          {% else %}
            {% trans %}This user has no biography.{% endtrans %}
          {% endif %}
        </p>
      {% endif %}
      {% endblock %}
      {% block user_nums %}
      <div class="nums">
        <dl>
          <dt>{{ _('Followers') }}</dt>
          <dd data-module="followers-counter" data-module-id="{{ user.id }}" data-module-num_followers="{{ user.num_followers }}">{{ h.SI_number_span(user.num_followers) }}</dd>
        </dl>
        <dl>
          <dt>{{ _('Datasets') }}</dt>
          <dd>{{ h.SI_number_span(user.number_created_packages) }}</dd>
        </dl>
      </div>
      {% endblock %}
      {% if is_myself == false %}
        {% block user_follow %}
        <div class="follow_button">
          {{ h.follow_button('user', user.id) }}</li>
        </div>
        {% endblock %}
      {% endif %}
      {% block user_info %}
      <div class="info">
        <dl>
          {% if user.name.startswith('http://') or user.name.startswith('https://') %}
            <dt>{{ _('Open ID') }}</dt>
            <dd>{{ user.name|urlize(25) }}{# Be great if this just showed the domain #}</dd>
          {% else %}
            <dt>{{ _('Username') }}</dt>
            <dd>{{ user.name }}</dd>
          {% endif %}
        </dl>
        {% if is_myself %}
          <dl>
            <dt>{{ _('Email') }} <span class="label label-default" title="{{ _('This means only you can see this') }}">{{ _('Private') }}</span></dt>
            <dd>{{ user.email }}</dd>
          </dl>
        {% endif %}
        <dl>
          <dt>{{ _('Member Since') }}</dt>
          <dd>{{ h.render_datetime(user.created) }}</dd>
        </dl>
        <dl>
          <dt>{{ _('State') }}</dt>
          <dd>{{ _(user.state) }}</dd>
        </dl>
        {% if is_myself %}
          <dl>
            <dt class="key">{{ _('API Key') }} <span class="label label-default" title="{{ _('This means only you can see this') }}">{{ _('Private') }}</span></dt>
            <dd class="value"><code>{{ user.apikey }}</code></dd>
          </dl>
        {% endif %}
      </div>
      {% endblock %}
    {% endblock %}
  </section>
</div>
{% endblock %}