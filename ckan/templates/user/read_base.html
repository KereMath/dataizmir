{% extends "page.html" %}

{% set user = user_dict %}

<style>
  header.module-content.page-header {
    display: none !important;
  }
  .page-header {
    background-color: transparent !important;
  }
</style>

<script>
// ƒ∞lk test - sayfa y√ºklendiƒüinde basit log
console.log('üöÄ Page loaded, starting user profile API test...');
console.log('üë§ Current user from template:', '{{ user.name }}');

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìù DOM loaded, testing API...');
    
    // Basit test fonksiyonu
    testAPI();
});

async function testAPI() {
    console.log('üîç Testing API endpoints...');
    
    try {
        // 1. Basit GET test
        console.log('1Ô∏è‚É£ Testing simple GET...');
        const simpleResponse = await fetch('/api/3/action/user_show?id={{ user.name }}', {
            method: 'GET',
            credentials: 'include'
        });
        console.log('GET Response Status:', simpleResponse.status);
        console.log('GET Response Headers:', Object.fromEntries(simpleResponse.headers.entries()));
        
    } catch (error) {
        console.error('‚ùå GET Error:', error);
    }
    
    try {
        // 2. POST test - en basit hali
        console.log('2Ô∏è‚É£ Testing POST...');
        const postResponse = await fetch('/api/3/action/user_show', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                id: '{{ user.name }}'
            })
        });
        
        console.log('POST Response Status:', postResponse.status);
        console.log('POST Response OK:', postResponse.ok);
        
        const postData = await postResponse.text(); // √ñnce text olarak al
        console.log('POST Raw Response:', postData);
        
        try {
            const jsonData = JSON.parse(postData);
            console.log('POST JSON Response:', jsonData);
            
            if (jsonData.success) {
                console.log('‚úÖ SUCCESS! User data:', jsonData.result);
                displayUserData(jsonData.result);
            } else {
                console.log('‚ùå API Error:', jsonData.error);
            }
        } catch (parseError) {
            console.error('‚ùå JSON Parse Error:', parseError);
        }
        
    } catch (error) {
        console.error('‚ùå POST Error:', error);
    }
    
    try {
        // 3. CSRF token ile test
        console.log('3Ô∏è‚É£ Testing with CSRF token...');
        
        // CSRF token'ƒ± bul
        const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || 
                         document.querySelector('input[name=csrf_token]')?.value;
        
        console.log('CSRF Token found:', csrfToken);
        
        const headers = {
            'Content-Type': 'application/json'
        };
        
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        const csrfResponse = await fetch('/api/3/action/user_show', {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: JSON.stringify({
                id: '{{ user.name }}'
            })
        });
        
        console.log('CSRF Response Status:', csrfResponse.status);
        const csrfData = await csrfResponse.json();
        console.log('CSRF Response:', csrfData);
        
    } catch (error) {
        console.error('‚ùå CSRF Error:', error);
    }
    
    try {
        // 4. Farklƒ± endpoint test
        console.log('4Ô∏è‚É£ Testing alternative endpoint...');
        const altResponse = await fetch('/api/action/user_show', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                id: '{{ user.name }}'
            })
        });
        
        console.log('Alt Response Status:', altResponse.status);
        const altData = await altResponse.json();
        console.log('Alt Response:', altData);
        
    } catch (error) {
        console.error('‚ùå Alt endpoint Error:', error);
    }
}

function displayUserData(userData) {
    console.log('üéØ === DETAILED USER DATA ===');
    console.log('Name:', userData.name);
    console.log('Display Name:', userData.display_name);
    console.log('Email:', userData.email);
    console.log('API Key:', userData.apikey);
    console.log('Created:', userData.created);
    console.log('State:', userData.state);
    console.log('Sysadmin:', userData.sysadmin);
    console.log('Number of datasets:', userData.number_created_packages);
    console.log('Followers:', userData.num_followers);
    console.log('Full object:', userData);
}

// Manual test fonksiyonlarƒ±
window.testAPI = testAPI;
window.manualTest = function() {
    console.log('üîß Manual test ba≈ülatƒ±lƒ±yor...');
    
    fetch('/api/3/action/user_show', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ id: '{{ user.name }}' })
    })
    .then(response => {
        console.log('Manual Response:', response);
        return response.json();
    })
    .then(data => {
        console.log('Manual Data:', data);
    })
    .catch(error => {
        console.error('Manual Error:', error);
    });
};

// Network debugger
window.checkNetwork = function() {
    console.log('üåê Checking network...');
    console.log('Current URL:', window.location.href);
    console.log('User agent:', navigator.userAgent);
    console.log('Cookies:', document.cookie);
};

// Sayfa y√ºklendiƒüinde hemen test et
console.log('üéÆ Available functions:');
console.log('- testAPI() - Full API test');
console.log('- manualTest() - Manual simple test');
console.log('- checkNetwork() - Network debug');

// Auto-run 2 saniye sonra
setTimeout(function() {
    console.log('‚è∞ Auto-running tests in 2 seconds...');
    testAPI();
}, 2000);
</script>

{% block secondary_content %}
<div class="module context-info">
  <section class="module-content">
    {% block secondary_content_inner %}
      {% block user_image %}
      <div class="image">{{ h.user_image(user.id, size=270) }}</div>
      {% endblock %}
      {% block user_heading %}
      <h1 class="heading">{{ user.display_name }}</h1>
      {% endblock %}
      {% block user_about %}
      {% if about_formatted %}
        {{ about_formatted }}
      {% else %}
        <p class="empty">
          {% if is_myself %}
            {% trans %}You have not provided a biography.{% endtrans %}
          {% else %}
            {% trans %}This user has no biography.{% endtrans %}
          {% endif %}
        </p>
      {% endif %}
      {% endblock %}
      {% block user_nums %}
      <div class="nums">
        <dl>
          <dt>{{ _('Followers') }}</dt>
          <dd data-module="followers-counter" data-module-id="{{ user.id }}" data-module-num_followers="{{ user.num_followers }}">{{ h.SI_number_span(user.num_followers) }}</dd>
        </dl>
        <dl>
          <dt>{{ _('Datasets') }}</dt>
          <dd>{{ h.SI_number_span(user.number_created_packages) }}</dd>
        </dl>
      </div>
      {% endblock %}
      {% if is_myself == false %}
        {% block user_follow %}
        <div class="follow_button">
          {{ h.follow_button('user', user.id) }}</li>
        </div>
        {% endblock %}
      {% endif %}
      {% block user_info %}
      <div class="info">
        <dl>
          {% if user.name.startswith('http://') or user.name.startswith('https://') %}
            <dt>{{ _('Open ID') }}</dt>
            <dd>{{ user.name|urlize(25) }}{# Be great if this just showed the domain #}</dd>
          {% else %}
            <dt>{{ _('Username') }}</dt>
            <dd>{{ user.name }}</dd>
          {% endif %}
        </dl>
        {% if is_myself %}
          <dl>
            <dt>{{ _('Email') }} <span class="label label-default" title="{{ _('This means only you can see this') }}">{{ _('Private') }}</span></dt>
            <dd>{{ user.email }}</dd>
          </dl>
        {% endif %}
        <dl>
          <dt>{{ _('Member Since') }}</dt>
          <dd>{{ h.render_datetime(user.created) }}</dd>
        </dl>
        <dl>
          <dt>{{ _('State') }}</dt>
          <dd>{{ _(user.state) }}</dd>
        </dl>
        {% if is_myself %}
          <dl>
            <dt class="key">{{ _('API Key') }} <span class="label label-default" title="{{ _('This means only you can see this') }}">{{ _('Private') }}</span></dt>
            <dd class="value"><code>{{ user.apikey }}</code></dd>
          </dl>
        {% endif %}
      </div>
      {% endblock %}
    {% endblock %}
  </section>
</div>
{% endblock %}